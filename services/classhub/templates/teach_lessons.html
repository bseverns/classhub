{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher · Lessons</title>
    {% include "includes/glass_theme.html" %}
    <link rel="stylesheet" href="{% static 'css/teach_lessons.css' %}" />
  </head>
  <body class="glass-theme teacher-comfort">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top heading">
          <div>
            <div class="muted navline">
              <a href="/teach">Teacher</a> · <a href="/teach/assets">Lesson assets</a>{% if request.user.is_superuser %} · <a href="/admin/">Admin</a>{% endif %} · <a href="/teach/logout">Log out</a>
            </div>
            <h1>Lesson Tracker</h1>
            <div class="muted">Focus on lesson links and submission progress.</div>
          </div>
        </div>

        <div class="card">
          {% if notice %}
            <p class="notice flash-banner">{{ notice }}</p>
          {% endif %}
          {% if error %}
            <p class="error flash-banner">{{ error }}</p>
          {% endif %}

          <form method="get" class="row filter-form">
            <label for="class_id">Class</label>
            <select name="class_id" id="class_id">
              <option value="0" {% if not selected_class_id %}selected{% endif %}>All classes</option>
              {% for classroom in classes %}
                <option value="{{ classroom.id }}" {% if selected_class_id == classroom.id %}selected{% endif %}>{{ classroom.name }}</option>
              {% endfor %}
            </select>
            <button type="submit">Apply</button>
          </form>
        </div>

        {% for group in class_rows %}
          <div class="card">
            <div class="row">
              <div>
                <h2 class="section-title-tight">{{ group.classroom.name }}</h2>
                <div class="muted">Join code <span class="pill">{{ group.classroom.join_code }}</span> · Students {{ group.student_count }}</div>
              </div>
              <div class="muted"><a href="/teach/class/{{ group.classroom.id }}">Open class dashboard</a></div>
            </div>

            {% if group.lesson_rows %}
              <div class="tracker-table-wrap">
                <table>
                  <thead>
                    <tr>
                      <th scope="col">Module</th>
                      <th scope="col">Lesson</th>
                      <th scope="col">Dropboxes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in group.lesson_rows %}
                      <tr class="lesson-row">
                        <td class="module-cell"><strong>{{ row.module.title }}</strong></td>
                        <td class="lesson-cell">
                          <strong><a href="{{ row.lesson_url }}" target="_blank" rel="noopener">{{ row.lesson_title }}</a></strong>
                          <div class="muted">{{ row.course_slug }} / {{ row.lesson_slug }}</div>
                          <a class="quick" href="/teach/videos?class_id={{ group.classroom.id }}&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}">Manage videos</a>
                          <a class="quick" href="/teach/assets?folder_id=0&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}&status=all">Manage assets</a>
                          {% if row.review_url %}
                            <a class="quick" href="{{ row.review_url }}">{{ row.review_label }}</a>
                          {% endif %}
                          {% if row.teacher_material_html %}
                            <details class="teacher-note">
                              <summary>Teacher notes</summary>
                              <div class="teacher-note-body">{{ row.teacher_material_html|safe }}</div>
                            </details>
                          {% endif %}
                          <div class="release-box">
                            {% with release=row.release_state %}
                              <div class="release-status">
                                Release:
                                {% if release.is_locked %}
                                  <span class="state-pill state-pill--locked">Locked</span>
                                {% else %}
                                  <span class="state-pill state-pill--open">Open</span>
                                {% endif %}
                                {% if release.available_on %}
                                  · Date <strong>{{ release.available_on|date:"M j, Y" }}</strong>
                                {% endif %}
                                {% if release.has_override %}
                                  · Override active
                                {% else %}
                                  · Content default
                                {% endif %}
                              </div>
                              <div class="release-actions">
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="set_date" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <input type="date" name="available_on" value="{% if release.override_available_on %}{{ release.override_available_on|date:'Y-m-d' }}{% endif %}" />
                                  <button type="submit">Set date</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="toggle_lock" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Toggle lock</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="unlock_now" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Open now</button>
                                </form>
                                <form method="post" action="/teach/lessons/release">
                                  {% csrf_token %}
                                  <input type="hidden" name="class_id" value="{{ group.classroom.id }}" />
                                  <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                  <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                  <input type="hidden" name="action" value="reset_default" />
                                  <input type="hidden" name="return_to" value="/teach/lessons?class_id={{ group.classroom.id }}" />
                                  <button type="submit">Reset default</button>
                                </form>
                              </div>
                            {% endwith %}
                          </div>
                        </td>
                        <td class="dropbox-cell">
                          {% if row.dropboxes %}
                            {% for dropbox in row.dropboxes %}
                              <div class="dropbox">
                                <div><a href="/teach/material/{{ dropbox.id }}/submissions">{{ dropbox.title }}</a></div>
                                <div class="muted">
                                  Submitted {{ dropbox.submitted }} / {{ group.student_count }}
                                  · Missing {{ dropbox.missing }}
                                  {% if dropbox.last_uploaded_at %}· Latest {{ dropbox.last_uploaded_at }}{% endif %}
                                </div>
                                <div class="actions">
                                  <a href="/teach/material/{{ dropbox.id }}/submissions">All</a>
                                  <a href="/teach/material/{{ dropbox.id }}/submissions?show=missing">Missing</a>
                                  <a href="/teach/material/{{ dropbox.id }}/submissions?download=zip_latest">ZIP latest</a>
                                </div>
                              </div>
                            {% endfor %}
                          {% else %}
                            <span class="muted">No upload dropbox in this module.</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="muted section-empty-note">No lesson links found in this class yet.</p>
            {% endif %}
          </div>
        {% endfor %}

        {% if not class_rows %}
          <div class="card">
            <p class="muted">No classes available.</p>
          </div>
        {% endif %}
      </main>
    </div>
  </body>
</html>
