{% load static hub_extras %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Teacher · {{ classroom.name }}</title>
    {% include "includes/glass_theme.html" %}
    <link rel="stylesheet" href="{% static 'css/teach_class.css' %}" />
  </head>
  <body class="glass-theme teacher-comfort" data-class-id="{{ classroom.id }}">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top">
          <div>
            <div class="muted navline">
              <a href="/teach">Teacher</a> · <a href="/teach/lessons?class_id={{ classroom.id }}">Lesson tracker</a> · <a href="/teach/assets">Lesson assets</a>
              {% if request.user.is_superuser %} · <a href="/admin/">Admin</a>{% endif %} · <a href="/teach/logout">Log out</a>
            </div>
            <h1>{{ classroom.name }}</h1>
            <div class="muted">
              Join code <span class="pill">{{ classroom.join_code }}</span>
              <button type="button" class="inline-copy" data-copy-value="{{ classroom.join_code }}">Copy</button>
              · <a href="/teach/class/{{ classroom.id }}/join-card" target="_blank" rel="noopener">Printable join card</a>
              · Students {{ student_count }}
              · Join flow {% if classroom.enrollment_mode == 'open' %}<span class="state-pill state-pill--open">Open</span>{% elif classroom.enrollment_mode == 'invite_only' %}<span class="state-pill state-pill--locked">Invite only</span>{% else %}<span class="state-pill state-pill--locked">Closed</span>{% endif %}
              · Class {% if classroom.is_locked %}<span class="state-pill state-pill--locked">Locked</span>{% else %}<span class="state-pill state-pill--open">Unlocked</span>{% endif %}
            </div>
            <div id="copy-status" class="muted copy-status" role="status" aria-live="polite"></div>
          </div>
          <div class="btnline">
            <form method="post" action="/teach/class/{{ classroom.id }}/set-enrollment-mode">
              {% csrf_token %}
              <label>
                <span class="visually-hidden">Enrollment mode</span>
                <select name="enrollment_mode">
                  <option value="open" {% if classroom.enrollment_mode == 'open' %}selected{% endif %}>Open</option>
                  <option value="invite_only" {% if classroom.enrollment_mode == 'invite_only' %}selected{% endif %}>Invite only</option>
                  <option value="closed" {% if classroom.enrollment_mode == 'closed' %}selected{% endif %}>Closed</option>
                </select>
              </label>
              <button type="submit">Set enrollment</button>
            </form>
            <form method="post" action="/teach/class/{{ classroom.id }}/toggle-lock">
              {% csrf_token %}
              <button type="submit">{% if classroom.is_locked %}Unlock{% else %}Lock{% endif %}</button>
            </form>
            <form method="post" action="/teach/class/{{ classroom.id }}/rotate-code">
              {% csrf_token %}
              <button type="submit">Rotate code</button>
            </form>
            <a href="/teach/class/{{ classroom.id }}/export-outcomes-csv">Export outcomes CSV</a>
            <a href="/teach/class/{{ classroom.id }}/export-summary-csv">Export summary CSV</a>
          </div>
        </div>

        <div class="card">
          {% if notice %}
            <p class="notice flash-banner">{{ notice }}</p>
          {% endif %}
          {% if error %}
            <p class="error flash-banner">{{ error }}</p>
          {% endif %}
          <details class="section-toggle">
            <summary>
              <span class="section-title">Student Invite Links</span>
              <span class="section-subtitle">Generate no-login links with optional expiry and seat caps.</span>
            </summary>
            <div class="section-body">
              <form method="post" action="/teach/class/{{ classroom.id }}/create-invite-link" class="invite-create-form">
                {% csrf_token %}
                <label>
                  Label (optional)
                  <input name="label" maxlength="120" placeholder="e.g., Period 3 paid cohort" />
                </label>
                <label>
                  Expires in hours (optional)
                  <input name="expires_in_hours" type="number" min="1" max="2160" placeholder="e.g., 72" />
                </label>
                <label>
                  Seat cap (optional)
                  <input name="seat_cap" type="number" min="1" max="5000" placeholder="e.g., 24" />
                </label>
                <button type="submit">Create invite link</button>
              </form>
              {% if invite_links %}
                <div class="roster-table-wrap invite-table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Label</th>
                        <th scope="col">Link</th>
                        <th scope="col">Seats</th>
                        <th scope="col">Expires</th>
                        <th scope="col">Status</th>
                        <th scope="col"><span class="visually-hidden">Action</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for invite in invite_links %}
                        <tr>
                          <td>{{ invite.label|default:"(no label)" }}</td>
                          <td>
                            <code>{{ invite.invite_url }}</code>
                            <button type="button" class="inline-copy" data-copy-value="{{ invite.invite_url }}">Copy</button>
                          </td>
                          <td>
                            {% if invite.max_uses %}
                              {{ invite.use_count }} / {{ invite.max_uses }}
                              {% if invite.seats_remaining_value is not None %}
                                <span class="muted mini"> · {{ invite.seats_remaining_value }} left</span>
                              {% endif %}
                            {% else %}
                              Unlimited
                            {% endif %}
                          </td>
                          <td>
                            {% if invite.expires_at %}
                              {{ invite.expires_at|date:"M j, Y g:i A" }}
                            {% else %}
                              Never
                            {% endif %}
                          </td>
                          <td>
                            {% if invite.is_active and not invite.is_expired_now %}
                              <span class="state-pill state-pill--open">Active</span>
                            {% elif not invite.is_active %}
                              <span class="state-pill state-pill--locked">Disabled</span>
                            {% else %}
                              <span class="state-pill state-pill--locked">Expired</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if invite.is_active %}
                              <form method="post" action="/teach/class/{{ classroom.id }}/disable-invite-link">
                                {% csrf_token %}
                                <input type="hidden" name="invite_id" value="{{ invite.id }}" />
                                <button type="submit">Disable</button>
                              </form>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="muted section-empty-note">No invite links yet.</p>
              {% endif %}
            </div>
          </details>
          <details class="section-toggle">
            <summary>
              <span class="section-title">Roster</span>
              <span class="section-subtitle">Rename or merge duplicate students quickly. Reset roster between drop-in cohorts.</span>
            </summary>
            <div class="section-body">
              {% if students %}
                <div class="roster-table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Student</th>
                        <th scope="col">Return code</th>
                        <th scope="col">Submissions</th>
                        <th scope="col"><span class="visually-hidden">Actions</span></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for st in students %}
                        <tr>
                          <td><strong>{{ st.display_name }}</strong></td>
                          <td>
                            <span
                              id="student-return-code-{{ st.id }}"
                              class="pill secret-code"
                              data-return-code-student-id="{{ st.id }}"
                              data-shown="0"
                            >••••••</span>
                            <button
                              type="button"
                              class="inline-copy"
                              data-secret-target="student-return-code-{{ st.id }}"
                              aria-controls="student-return-code-{{ st.id }}"
                              aria-pressed="false"
                              aria-label="Show return code for {{ st.display_name }}"
                            >Show</button>
                            <button
                              type="button"
                              class="inline-copy"
                              data-copy-secret-target="student-return-code-{{ st.id }}"
                              aria-label="Copy return code for {{ st.display_name }}"
                            >Copy</button>
                          </td>
                          <td class="muted mini">{{ submission_counts_by_student|get_item:st.id|default:0 }}</td>
                          <td>
                            <form method="post" action="/teach/class/{{ classroom.id }}/rename-student" class="rename-row">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ st.id }}" />
                              <input name="display_name" value="{{ st.display_name }}" maxlength="80" />
                              <button type="submit">Rename</button>
                            </form>
                            <form method="post" action="/teach/class/{{ classroom.id }}/delete-student-data" class="delete-row" data-confirm="Delete all stored data for this student now?">
                              {% csrf_token %}
                              <input type="hidden" name="student_id" value="{{ st.id }}" />
                              <label class="inline-check-label">
                                <input type="checkbox" name="confirm_delete" value="1" class="inline-check-input" required />
                                Confirm delete
                              </label>
                              <button type="submit" class="danger-inline">Delete student data</button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="muted section-empty-note">No students in roster yet.</p>
              {% endif %}

              {% if students|length > 1 %}
                <div class="merge-zone">
                  <strong>Merge student records</strong>
                  <p class="muted mini merge-note">
                    Use this when the same student appears twice after rejoining with class code.
                    The source student is removed, and submissions/events are moved to the destination student.
                  </p>
                  <form
                    method="post"
                    action="/teach/class/{{ classroom.id }}/merge-students"
                    data-confirm="Merge selected student records? This cannot be undone."
                  >
                    {% csrf_token %}
                    <div class="merge-row">
                      <label>
                        Source student
                        <select name="source_student_id" required>
                          <option value="">Select source</option>
                          {% for st in students %}
                            <option value="{{ st.id }}">{{ st.display_name }} (#{{ st.id }})</option>
                          {% endfor %}
                        </select>
                      </label>
                      <label>
                        Destination student
                        <select name="target_student_id" required>
                          <option value="">Select destination</option>
                          {% for st in students %}
                            <option value="{{ st.id }}">{{ st.display_name }} (#{{ st.id }})</option>
                          {% endfor %}
                        </select>
                      </label>
                      <label class="inline-check-label merge-confirm-label">
                        <input type="checkbox" name="confirm_merge" value="1" class="inline-check-input" required />
                        Confirm merge
                      </label>
                      <button type="submit">Merge students</button>
                    </div>
                  </form>
                </div>
              {% endif %}

              <div class="danger-zone">
                <strong>Reset roster</strong>
                <p class="muted mini danger-copy">
                  This removes all students in this class and deletes their submissions. Active student sessions are invalidated immediately.
                </p>
                <form method="post" action="/teach/class/{{ classroom.id }}/reset-roster" data-confirm="Reset roster for this class? This deletes students and submissions.">
                  {% csrf_token %}
                  <label class="inline-check-label no-top-margin">
                    <input type="checkbox" name="rotate_code" value="1" checked class="inline-check-input" />
                    Rotate class join code after reset
                  </label>
                  <button type="submit">Reset roster now</button>
                </form>
                <hr class="danger-divider" />
                <strong>Reset helper conversations</strong>
                <p class="muted mini danger-copy">
                  Exports a class helper snapshot (for internal research) and then clears cached helper chat history for this class only.
                </p>
                <form method="post" action="/teach/class/{{ classroom.id }}/reset-helper-conversations" data-confirm="Reset helper conversations for this class?">
                  {% csrf_token %}
                  <input type="hidden" name="export_before_reset" value="0" />
                  <label class="inline-check-label no-top-margin">
                    <input type="checkbox" name="export_before_reset" value="1" checked class="inline-check-input" />
                    Export snapshot before clearing cache
                  </label>
                  <p class="muted mini merge-note">
                    Access to exported helper data is limited to class teachers and createMPLS administrators.
                  </p>
                  <button type="submit">Reset helper conversations</button>
                </form>
              </div>
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Outcomes Snapshot</span>
              <span class="section-subtitle">Certificate-ready learner progress from the last {{ outcome_snapshot.window_days }} days</span>
            </summary>
            <div class="section-body">
              <div class="signal-kpis">
                <div class="signal-kpi"><strong>{{ outcome_snapshot.total_sessions }}</strong> session completions</div>
                <div class="signal-kpi"><strong>{{ outcome_snapshot.total_artifacts }}</strong> artifact submissions</div>
                <div class="signal-kpi"><strong>{{ outcome_snapshot.total_milestones }}</strong> milestones</div>
                <div class="signal-kpi"><strong>{{ outcome_snapshot.eligible_students }}/{{ outcome_snapshot.total_students }}</strong> certificate eligible</div>
              </div>
              <p class="muted mini merge-note">
                Eligibility threshold: {{ outcome_snapshot.certificate_min_sessions }} sessions and {{ outcome_snapshot.certificate_min_artifacts }} artifacts.
              </p>
              {% if outcome_snapshot.top_students %}
                <div class="signal-panel">
                  <strong>Top outcome students</strong>
                  <ul class="signal-list">
                    {% for row in outcome_snapshot.top_students %}
                      <li>
                        <strong>{{ row.display_name }}</strong>
                        · {{ row.session_count }} sessions
                        · {{ row.artifact_count }} artifacts
                        · {{ row.milestone_count }} milestones
                        {% if row.certificate_eligible %} · eligible{% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <p class="muted mini section-empty-note">No outcome events recorded yet.</p>
              {% endif %}
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Helper Signals</span>
              <span class="section-subtitle">Class helper usage insights from the last {{ helper_signals.window_hours }} hours</span>
            </summary>
            <div class="section-body">
              <div class="signal-kpis">
                <div class="signal-kpi"><strong>{{ helper_signals.total_events }}</strong> helper chats</div>
                <div class="signal-kpi"><strong>{{ helper_signals.compacted_events }}</strong> compacted conversations</div>
                <div class="signal-kpi">Avg follow-up suggestions <strong>{{ helper_signals.avg_follow_up_suggestions }}</strong></div>
              </div>
              {% if helper_signals.total_events %}
                <div class="signal-grid">
                  <div class="signal-panel">
                    <strong>Intent mix</strong>
                    <ul class="signal-list">
                      {% for row in helper_signals.intent_rows %}
                        <li><span class="pill">{{ row.intent }}</span> {{ row.count }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  <div class="signal-panel">
                    <strong>Busiest students</strong>
                    <ul class="signal-list">
                      {% for row in helper_signals.busiest_students %}
                        <li>
                          <strong>{{ row.display_name }}</strong> · {{ row.chat_count }} chats
                          {% if row.primary_intent %} · {{ row.primary_intent }}{% endif %}
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              {% else %}
                <p class="muted mini section-empty-note">No helper activity in this window yet.</p>
              {% endif %}
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Lesson Tracker</span>
              <span class="section-subtitle">Course/lesson links with submission coverage</span>
            </summary>
            <div class="section-body">
              {% if lesson_rows %}
                <div class="lesson-table-wrap">
                  <table>
                    <thead>
                      <tr>
                        <th scope="col">Module</th>
                        <th scope="col">Lesson</th>
                        <th scope="col">Dropboxes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in lesson_rows %}
                        <tr class="lesson-row">
                      <td class="module-cell"><strong>{{ row.module.title }}</strong></td>
                      <td class="lesson-cell">
                        <strong><a href="{{ row.lesson_url }}" target="_blank" rel="noopener">{{ row.lesson_title }}</a></strong>
                        <div class="muted mini">{{ row.course_slug }} / {{ row.lesson_slug }}</div>
                        <a class="quick" href="/teach/videos?class_id={{ classroom.id }}&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}">Manage videos</a>
                        <a class="quick" href="/teach/assets?folder_id=0&course_slug={{ row.course_slug }}&lesson_slug={{ row.lesson_slug }}&status=all">Manage assets</a>
                        {% if row.review_url %}
                          <a class="quick" href="{{ row.review_url }}">{{ row.review_label }}</a>
                        {% endif %}
                        {% if row.teacher_material_html %}
                          <details class="teacher-note">
                            <summary>Teacher notes</summary>
                            <div class="teacher-note-body">{{ row.teacher_material_html|safe }}</div>
                          </details>
                        {% endif %}
                        <div class="release-box">
                          {% with release=row.release_state %}
                            <div class="release-status">
                              Release:
                              {% if release.is_locked %}
                                <span class="state-pill state-pill--locked">Locked</span>
                              {% else %}
                                <span class="state-pill state-pill--open">Open</span>
                              {% endif %}
                              {% if release.available_on %}
                                · Date <strong>{{ release.available_on|date:"M j, Y" }}</strong>
                              {% endif %}
                              {% if release.has_override %}
                                · Override active
                              {% else %}
                                · Content default
                              {% endif %}
                            </div>
                            <div class="release-actions">
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="set_date" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <input type="date" name="available_on" value="{% if release.override_available_on %}{{ release.override_available_on|date:'Y-m-d' }}{% endif %}" />
                                <button type="submit">Set date</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="toggle_lock" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Toggle lock</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="unlock_now" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Open now</button>
                              </form>
                              <form method="post" action="/teach/lessons/release">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="reset_default" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />
                                <button type="submit">Reset default</button>
                              </form>
                            </div>
                            <details class="helper-tune">
                              <summary>
                                Helper tuning
                                {% if row.helper_tuning.has_override %}
                                  <span class="muted mini">· Custom scope active</span>
                                {% else %}
                                  <span class="muted mini">· Using lesson defaults</span>
                                {% endif %}
                              </summary>
                              <p class="muted mini hint">
                                Leave fields blank to use lesson defaults for this class.
                              </p>
                              <form method="post" action="/teach/lessons/release" class="helper-grid">
                                {% csrf_token %}
                                <input type="hidden" name="class_id" value="{{ classroom.id }}" />
                                <input type="hidden" name="course_slug" value="{{ row.course_slug }}" />
                                <input type="hidden" name="lesson_slug" value="{{ row.lesson_slug }}" />
                                <input type="hidden" name="action" value="set_helper_scope" />
                                <input type="hidden" name="return_to" value="/teach/class/{{ classroom.id }}" />

                                <label for="helper-context-{{ forloop.counter0 }}">Helper context</label>
                                <input
                                  id="helper-context-{{ forloop.counter0 }}"
                                  name="helper_context_override"
                                  value="{{ row.helper_tuning.context_value }}"
                                  maxlength="200"
                                  placeholder="{{ row.helper_tuning.default_context }}"
                                />

                                <label for="helper-topics-{{ forloop.counter0 }}">Focus topics (one per line)</label>
                                <textarea
                                  id="helper-topics-{{ forloop.counter0 }}"
                                  name="helper_topics_override"
                                >{{ row.helper_tuning.topics_value }}</textarea>

                                <label for="helper-allowed-{{ forloop.counter0 }}">Allowed topics gate (one per line)</label>
                                <textarea
                                  id="helper-allowed-{{ forloop.counter0 }}"
                                  name="helper_allowed_topics_override"
                                >{{ row.helper_tuning.allowed_topics_value }}</textarea>

                                <label for="helper-reference-{{ forloop.counter0 }}">Reference key</label>
                                <input
                                  id="helper-reference-{{ forloop.counter0 }}"
                                  name="helper_reference_override"
                                  value="{{ row.helper_tuning.reference_value }}"
                                  maxlength="200"
                                  placeholder="{{ row.helper_tuning.default_reference }}"
                                />
                                <button type="submit">Save helper tuning</button>
                              </form>
                              <div class="helper-defaults muted mini">
                                Defaults:
                                context <strong>{{ row.helper_tuning.default_context }}</strong>
                                {% if row.helper_tuning.default_topics %}
                                  · topics {{ row.helper_tuning.default_topics|join:", " }}
                                {% endif %}
                                {% if row.helper_tuning.default_allowed_topics %}
                                  · allowed {{ row.helper_tuning.default_allowed_topics|join:", " }}
                                {% endif %}
                              </div>
                            </details>
                          {% endwith %}
                        </div>
                      </td>
                      <td class="dropbox-cell">
                        {% if row.dropboxes %}
                          {% for dropbox in row.dropboxes %}
                            <div class="dropbox">
                              <div><a href="/teach/material/{{ dropbox.id }}/submissions">{{ dropbox.title }}</a></div>
                              <div class="muted mini">Submitted {{ dropbox.submitted }} / {{ student_count }} · Missing {{ dropbox.missing }}{% if dropbox.last_uploaded_at %} · Latest {{ dropbox.last_uploaded_at }}{% endif %}</div>
                              <div class="actions">
                                <a href="/teach/material/{{ dropbox.id }}/submissions">All</a>
                                <a href="/teach/material/{{ dropbox.id }}/submissions?show=missing">Missing</a>
                                <a href="/teach/material/{{ dropbox.id }}/submissions?download=zip_latest">ZIP latest</a>
                              </div>
                            </div>
                          {% endfor %}
                        {% else %}
                          <span class="muted mini">No upload dropbox in this module.</span>
                        {% endif %}
                      </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="muted section-empty-note">No course lesson links detected in this class yet.</p>
              {% endif %}
            </div>
          </details>
        </div>

        <div class="card">
          <details class="section-toggle">
            <summary>
              <span class="section-title">Module Editor</span>
              <span class="section-subtitle">Order matters. Keep it predictable.</span>
            </summary>
            <div class="section-body">
              <div class="module-editor-form-wrap">
                <form method="post" action="/teach/class/{{ classroom.id }}/add-module">
                  {% csrf_token %}
                  <label for="module-title">New module title</label>
                  <input id="module-title" name="title" placeholder="e.g., Session 5 — Scratch Motion + Loops" />
                  <button type="submit" class="module-add-button">Add module</button>
                </form>
              </div>

              {% if modules %}
                {% for m in modules %}
                  <div class="module">
                    <div class="row">
                      <div>
                        <strong>{{ m.title }}</strong>
                        <div class="muted mini">{{ m.materials.all|length }} materials</div>
                      </div>
                      <div class="btnline">
                        <form method="post" action="/teach/class/{{ classroom.id }}/move-module">
                          {% csrf_token %}
                          <input type="hidden" name="module_id" value="{{ m.id }}" />
                          <input type="hidden" name="direction" value="up" />
                          <button type="submit" aria-label="Move module {{ m.title }} up">↑</button>
                        </form>
                        <form method="post" action="/teach/class/{{ classroom.id }}/move-module">
                          {% csrf_token %}
                          <input type="hidden" name="module_id" value="{{ m.id }}" />
                          <input type="hidden" name="direction" value="down" />
                          <button type="submit" aria-label="Move module {{ m.title }} down">↓</button>
                        </form>
                        <a href="/teach/module/{{ m.id }}">Open</a>
                      </div>
                    </div>

                    {% if m.materials.all %}
                      {% for mat in m.materials.all %}
                        <div class="mat">
                          <div class="row">
                            <div>
                              <strong>{{ mat.title }}</strong>
                              <div class="muted mini">Type: {{ mat.type }}</div>
                            </div>
                            <div class="muted mini">
                              {% if mat.type == 'upload' %}
                                Submitted: {{ submission_counts|get_item:mat.id|default:0 }} / {{ student_count }} · <a href="/teach/material/{{ mat.id }}/submissions">Submissions</a>
                              {% endif %}
                            </div>
                          </div>
                          {% if mat.type == 'link' and mat.url %}
                            <div class="muted mini"><a href="{{ mat.url }}" target="_blank" rel="noopener">Open link</a></div>
                          {% elif mat.type == 'text' and mat.body %}
                            <pre class="module-text-preview">{{ mat.body|truncatechars:280 }}</pre>
                          {% elif mat.type == 'upload' %}
                            <div class="muted mini">Accepted: {{ mat.accepted_extensions|default:'.sb3' }} · Max {{ mat.max_upload_mb }}MB</div>
                          {% endif %}
                        </div>
                      {% endfor %}
                    {% else %}
                      <div class="muted mini module-empty-note">No materials yet.</div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <p class="muted section-empty-note">No modules yet.</p>
              {% endif %}
            </div>
          </details>
        </div>
      </main>
    </div>
    <script src="{% static 'js/teach_class.js' %}" defer></script>
  </body>
</html>
