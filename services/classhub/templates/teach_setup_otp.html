{% load static %}
<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teacher 2FA Setup · {{ operator_profile.product_name|default:"Class Hub" }}</title>
  {% include "includes/glass_theme.html" %}
  <link rel="stylesheet" href="{% static 'css/teach_setup_otp.css' %}" />
</head>

<body class="glass-theme teacher-comfort">
  <a class="skip-link" href="#main-content">Skip to main content</a>
  <div class="shell">
    <main id="main-content">
      <div class="top title-row">
        <div>
          <h1>Teacher 2FA Setup</h1>
          <div class="muted navline">
            <a href="/teach">Teacher portal</a> · <a href="/teach/login">Teacher login</a> · <a href="/teach/logout">Log
              out</a>
          </div>
        </div>
        {% if setup_user %}
        <div class="muted">Account: <strong>{{ setup_user.username }}</strong></div>
        {% endif %}
      </div>

      {% if notice %}
      <div class="notice" role="status" aria-live="polite">{{ notice }}</div>
      {% endif %}
      {% if error %}
      <div class="error" role="alert" aria-live="assertive">{{ error }}</div>
      {% endif %}

      <div class="card">
        {% if already_configured %}
        <h2 class="section-title">Two-Factor Authentication</h2>
        <p class="muted">Enter a code from your authenticator app to continue.</p>
        {% elif otp_ready %}
        <h2 class="section-title">Scan QR Code</h2>
        <p class="muted">Use Google Authenticator, 1Password, Authy, or another TOTP app.</p>

        <div class="qr-wrap" aria-label="2FA QR code">
          {{ qr_svg }}
        </div>

        <div class="muted">Can’t scan? Enter this key manually:</div>
        <div class="code-pill">{{ manual_secret }}</div>
        <p class="muted top-gap-10">Token length: {{ digits }} digits.</p>
        {% else %}
        <h2 class="section-title">2FA setup unavailable</h2>
        <p class="muted">Open this page from a valid invite link, or sign in as a staff user first.</p>
        <p><a href="/teach/login">Go to teacher login</a></p>
        {% endif %}

        {% if already_configured or otp_ready %}
        <form method="post" class="otp-form">
          {% csrf_token %}
          {% if token %}
          <input type="hidden" name="token" value="{{ token }}" />
          {% endif %}
          {% if next_path %}
          <input type="hidden" name="next" value="{{ next_path }}" />
          {% endif %}
          <label for="otp-token">Authenticator code</label>
          <input id="otp-token" name="otp_token" inputmode="numeric" autocomplete="one-time-code" placeholder="123456"
            required autofocus />
          <div class="submit-wrap">
            <button type="submit">
              {% if already_configured %}
              Verify Session
              {% else %}
              Verify and enable 2FA
              {% endif %}
            </button>
          </div>
        </form>
        {% endif %}

        {% if otp_ready and not already_configured %}
        <details class="manual-details">
          <summary>Manual setup URL</summary>
          <p class="muted break-all">{{ config_url }}</p>
        </details>
        {% endif %}
      </div>
    </main>
  </div>
</body>

</html>
