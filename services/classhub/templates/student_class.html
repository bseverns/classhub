<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ classroom.name }}</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .shell {
        max-width: 980px;
      }
      .top h1 {
        margin: 6px 0 0 0;
        font-size: clamp(1.85rem, 2.7vw, 2.3rem);
      }
      .module {
        margin-top: 16px;
      }
      .module h2 {
        margin: 0;
      }
      .mat {
        margin-top: 10px;
        padding: 12px;
        border-radius: 12px;
        border: 1px solid rgba(22, 59, 80, 0.12);
        background: rgba(255, 255, 255, 0.5);
      }
      .mat .muted {
        margin-top: 6px;
      }
      .mat-link {
        margin-top: 6px;
        font-weight: 700;
      }
      .mat-link.muted-link {
        font-weight: 600;
      }
      .status-row {
        margin-top: 8px;
      }
      .empty-state {
        margin-top: 10px;
      }
      .done-guide {
        margin-top: 12px;
        border: 1px solid rgba(22, 59, 80, 0.14);
        border-radius: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.45);
      }
      .done-guide h2 {
        margin: 0 0 8px 0;
        font-size: 1rem;
      }
      .done-guide p {
        margin: 0 0 6px 0;
      }
      .done-guide p:last-child {
        margin-bottom: 0;
      }
      .inline-copy {
        margin-left: 8px;
        padding: 4px 8px;
        border-radius: 9px;
        font-size: 12px;
      }
      .secret-code {
        display: inline-block;
        min-width: 8ch;
        text-align: center;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        letter-spacing: 0.08em;
      }
      .copy-status {
        margin-top: 8px;
        min-height: 18px;
      }
    </style>
  </head>
  <body class="glass-theme">
    {% load hub_extras %}
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top">
          <div>
            <div class="muted"><a href="/">Join page</a> · <a href="/student">Student home</a> · <a href="/student/portfolio-export">Export my portfolio</a></div>
            <h1>{{ classroom.name }}</h1>
            <div class="muted">
              Signed in as <strong>{{ student.display_name }}</strong>
              · Code <span class="pill">{{ classroom.join_code }}</span>
              <button type="button" class="inline-copy" data-copy-value="{{ classroom.join_code }}">Copy class code</button>
            </div>
            <div class="muted">
              Your return code:
              <span
                id="student-return-code"
                class="pill secret-code"
                data-secret-code="{{ student.return_code|b64encode }}"
                data-shown="0"
              >••••••</span>
              <button
                type="button"
                class="inline-copy"
                data-secret-target="student-return-code"
                aria-controls="student-return-code"
                aria-pressed="false"
                aria-label="Show return code"
              >Show</button>
              <button
                type="button"
                class="inline-copy"
                data-copy-secret-target="student-return-code"
                aria-label="Copy return code"
              >Copy return code</button>
              (use it if you ever need to rejoin)
            </div>
            <div id="copy-status" class="muted copy-status" role="status" aria-live="polite"></div>
          </div>
          <div>
            <a class="muted" href="/logout">Log out</a>
          </div>
        </div>

        <div class="card done-guide">
          <h2>How to tell you are done</h2>
          <p class="muted"><span class="state-pill state-pill--done">Done for now</span> means your upload is saved and visible.</p>
          <p class="muted"><span class="state-pill state-pill--open">Open</span> means you can work/submit now.</p>
          <p class="muted"><span class="state-pill state-pill--locked">Locked</span> means wait until the listed date.</p>
        </div>

        {% if modules %}
          {% for m in modules %}
            <div class="card module">
              <h2>{{ m.title }}</h2>

              {% if m.materials.all %}
                {% for mat in m.materials.all %}
                  <div class="mat">
                    <strong>{{ mat.title }}</strong>
                    {% if mat.type == 'link' and mat.url %}
                      {% with access=material_access|get_item:mat.id %}
                        {% if access.is_lesson_link and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Lesson locked</span>
                          </div>
                        {% elif access.is_lesson_link %}
                          <div class="status-row">
                            <span class="state-pill state-pill--open">Lesson open</span>
                          </div>
                        {% endif %}
                        {% if access.is_lesson_link and access.is_locked %}
                          <div class="mat-link"><span class="state-pill state-pill--locked">Full lesson locked</span></div>
                          <div class="mat-link muted-link"><a href="{{ mat.url }}" target="_blank" rel="noopener">Preview intro-only page</a></div>
                          <div class="muted">Full lesson unlocks on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          <div class="mat-link"><a href="{{ mat.url }}" target="_blank" rel="noopener">Open lesson</a></div>
                        {% endif %}
                      {% endwith %}
                    {% elif mat.type == 'text' and mat.body %}
                      <pre style="margin-top:8px">{{ mat.body }}</pre>
                    {% elif mat.type == 'upload' %}
                      {% with s=submissions_by_material|get_item:mat.id access=material_access|get_item:mat.id %}
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Dropbox locked</span>
                          </div>
                        {% elif access.is_lesson_upload %}
                          <div class="status-row">
                            <span class="state-pill state-pill--open">Dropbox open</span>
                          </div>
                        {% endif %}
                        <div class="muted">Accepted: {{ mat.accepted_extensions|default:'.sb3' }} · Max {{ mat.max_upload_mb }}MB</div>
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="muted">Submissions open on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          <div class="status-row">
                            {% if s %}
                              <span class="state-pill state-pill--done">Done for now</span>
                            {% else %}
                              <span class="state-pill state-pill--open">Not submitted yet</span>
                            {% endif %}
                          </div>
                          <div class="mat-link">
                            <a href="/material/{{ mat.id }}/upload">Upload / view submissions</a>
                            {% if s %}
                              <span class="muted">· {{ s.count }} uploaded (latest saved)</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <div class="muted empty-state">(Empty material — teacher will fill this in.)</div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="muted empty-state">No materials yet.</div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="card">
            <p class="muted">No modules yet. A teacher/admin can add them in /admin.</p>
          </div>
        {% endif %}

        {% if helper_widget %}
          {{ helper_widget|safe }}
        {% endif %}
      </main>
    </div>
    <script>
      (function () {
        const status = document.getElementById("copy-status");
        const copyButtons = document.querySelectorAll("[data-copy-value], [data-copy-secret-target]");
        const toggleButtons = document.querySelectorAll("[data-secret-target]");
        const decodeSecret = (el) => {
          if (!el) return "";
          const encoded = el.getAttribute("data-secret-code") || "";
          if (!encoded) return "";
          try {
            return atob(encoded);
          } catch (_err) {
            return "";
          }
        };
        const maskFor = (value) => "•".repeat(Math.max(value.length, 6));
        const setMasked = (el) => {
          const plain = decodeSecret(el);
          el.textContent = maskFor(plain);
          el.setAttribute("data-shown", "0");
        };
        const setShown = (el) => {
          const plain = decodeSecret(el);
          el.textContent = plain || maskFor("");
          el.setAttribute("data-shown", "1");
        };

        toggleButtons.forEach((btn) => {
          const target = document.getElementById(btn.getAttribute("data-secret-target") || "");
          if (!target) return;
          setMasked(target);
          btn.addEventListener("click", () => {
            const shown = target.getAttribute("data-shown") === "1";
            if (shown) {
              setMasked(target);
              btn.textContent = "Show";
              btn.setAttribute("aria-pressed", "false");
              btn.setAttribute("aria-label", "Show return code");
              if (status) status.textContent = "Return code hidden.";
            } else {
              setShown(target);
              btn.textContent = "Hide";
              btn.setAttribute("aria-pressed", "true");
              btn.setAttribute("aria-label", "Hide return code");
              if (status) status.textContent = "Return code shown.";
            }
          });
        });

        if (!status || !copyButtons.length) return;
        copyButtons.forEach((btn) => {
          btn.addEventListener("click", async () => {
            let value = btn.getAttribute("data-copy-value") || "";
            if (!value) {
              const target = document.getElementById(btn.getAttribute("data-copy-secret-target") || "");
              value = decodeSecret(target);
            }
            if (!value) return;
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(value);
              } else {
                const input = document.createElement("input");
                input.value = value;
                document.body.appendChild(input);
                input.select();
                document.execCommand("copy");
                document.body.removeChild(input);
              }
              status.textContent = "Copied to clipboard.";
            } catch (err) {
              status.textContent = "Copy failed. Please copy manually.";
            }
          });
        });
      })();
    </script>
  </body>
</html>
