{% load static hub_extras %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ classroom.name }}</title>
    {% include "includes/glass_theme.html" %}
    <link rel="stylesheet" href="{% static 'css/student_class.css' %}" />
  </head>
  <body class="glass-theme">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="top">
          <div>
            <div class="muted"><a href="/">Join page</a> · <a href="/student">Student home</a> · <a href="/student/my-data">My Data</a> · <a href="/student/portfolio-export">Export my portfolio</a></div>
            <h1>{{ classroom.name }}</h1>
            <div class="muted">
              Signed in as <strong>{{ student.display_name }}</strong>
              · Code <span class="pill">{{ classroom.join_code }}</span>
              <button type="button" class="inline-copy" data-copy-value="{{ classroom.join_code }}">Copy class code</button>
            </div>
            <div class="muted">
              Your return code:
              <span
                id="student-return-code"
                class="pill secret-code"
                data-shown="0"
              >••••••</span>
              <button
                type="button"
                class="inline-copy"
                data-secret-target="student-return-code"
                aria-controls="student-return-code"
                aria-pressed="false"
                aria-label="Show return code"
              >Show</button>
              <button
                type="button"
                class="inline-copy"
                data-copy-secret-target="student-return-code"
                aria-label="Copy return code"
              >Copy return code</button>
              (use it if you ever need to rejoin)
            </div>
            <div id="copy-status" class="muted copy-status" role="status" aria-live="polite"></div>
          </div>
          <div>
            <a class="muted" href="/logout">Log out</a>
          </div>
        </div>

        <div class="card done-guide">
          <h2>How to tell you are done</h2>
          <p class="muted"><span class="state-pill state-pill--done">Done for now</span> means your upload is saved and visible.</p>
          <p class="muted"><span class="state-pill state-pill--open">Open</span> means you can work/submit now.</p>
          <p class="muted"><span class="state-pill state-pill--locked">Locked</span> means wait until the listed date.</p>
        </div>

        <div class="card done-guide">
          <h2>My Data</h2>
          <p class="muted">Manage your class data on this device in one place.</p>
          <div class="my-data-actions">
            <a href="/student/my-data">Show my submissions</a>
            <a href="/student/portfolio-export">Download my work</a>
            <form method="post" action="/student/delete-work" data-confirm="Delete all of your submissions now?">
              {% csrf_token %}
              <button type="submit" class="danger-inline">Delete my work now</button>
            </form>
            <form method="post" action="/student/end-session">
              {% csrf_token %}
              <button type="submit">End my session on this device</button>
            </form>
          </div>
        </div>

        {% if modules %}
          {% for m in modules %}
            <div class="card module">
              <h2>{{ m.title }}</h2>

              {% if m.materials.all %}
                {% for mat in m.materials.all %}
                  <div class="mat">
                    <strong>{{ mat.title }}</strong>
                    {% if mat.type == 'link' and mat.url %}
                      {% with access=material_access|get_item:mat.id %}
                        {% if access.is_lesson_link and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Lesson locked</span>
                          </div>
                        {% elif access.is_lesson_link %}
                          <div class="status-row">
                            <span class="state-pill state-pill--open">Lesson open</span>
                          </div>
                        {% endif %}
                        {% if access.is_lesson_link and access.is_locked %}
                          <div class="mat-link"><span class="state-pill state-pill--locked">Full lesson locked</span></div>
                          <div class="mat-link muted-link"><a href="{{ mat.url }}" target="_blank" rel="noopener">Preview intro-only page</a></div>
                          <div class="muted">Full lesson unlocks on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          <div class="mat-link"><a href="{{ mat.url }}" target="_blank" rel="noopener">Open lesson</a></div>
                        {% endif %}
                      {% endwith %}
                    {% elif mat.type == 'text' and mat.body %}
                      <pre class="text-material-preview">{{ mat.body }}</pre>
                    {% elif mat.type == 'upload' %}
                      {% with s=submissions_by_material|get_item:mat.id access=material_access|get_item:mat.id %}
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Dropbox locked</span>
                          </div>
                        {% elif access.is_lesson_upload %}
                          <div class="status-row">
                            <span class="state-pill state-pill--open">Dropbox open</span>
                          </div>
                        {% endif %}
                        <div class="muted">Accepted: {{ mat.accepted_extensions|default:'.sb3' }} · Max {{ mat.max_upload_mb }}MB</div>
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="muted">Submissions open on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          <div class="status-row">
                            {% if s %}
                              <span class="state-pill state-pill--done">Done for now</span>
                            {% else %}
                              <span class="state-pill state-pill--open">Not submitted yet</span>
                            {% endif %}
                          </div>
                          <div class="mat-link">
                            <a href="/material/{{ mat.id }}/upload">Upload / view submissions</a>
                            {% if s %}
                              <span class="muted">· {{ s.count }} uploaded (latest saved)</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% elif mat.type == 'gallery' %}
                      {% with s=submissions_by_material|get_item:mat.id access=material_access|get_item:mat.id gallery_entries=gallery_entries_by_material|get_item:mat.id %}
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Gallery locked</span>
                          </div>
                        {% elif access.is_lesson_upload %}
                          <div class="status-row">
                            <span class="state-pill state-pill--open">Gallery open</span>
                          </div>
                        {% endif %}
                        <div class="muted">Accepted: {{ mat.accepted_extensions|default:'.png,.jpg,.jpeg,.webp,.gif,.pdf,.sb3' }} · Max {{ mat.max_upload_mb }}MB</div>
                        {% if access.is_lesson_upload and access.is_locked %}
                          <div class="muted">Gallery opens on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          <div class="status-row">
                            {% if s %}
                              <span class="state-pill state-pill--done">Uploaded</span>
                            {% else %}
                              <span class="state-pill state-pill--open">Not uploaded yet</span>
                            {% endif %}
                          </div>
                          <div class="mat-link">
                            <a href="/material/{{ mat.id }}/upload">Upload / manage gallery</a>
                            {% if s %}
                              <span class="muted">· {{ s.count }} uploaded</span>
                            {% endif %}
                          </div>
                        {% endif %}
                        {% if gallery_entries %}
                          <div class="gallery-shared-wrap">
                            <div class="muted">Shared gallery</div>
                            <ul class="gallery-shared-list">
                              {% for g in gallery_entries %}
                                <li>
                                  <a href="/submission/{{ g.submission_id }}/download">{{ g.original_filename }}</a>
                                  <span class="muted">· {{ g.display_name }}{% if g.is_owner %} (you){% endif %} · {{ g.uploaded_at|date:"M j, g:i a" }}</span>
                                </li>
                              {% endfor %}
                            </ul>
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% elif mat.type == 'checklist' %}
                      {% with access=material_access|get_item:mat.id items=material_checklist_items|get_item:mat.id state=material_responses|get_item:mat.id %}
                        {% if access.is_lesson_activity and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Checklist locked</span>
                          </div>
                          <div class="muted">Checklist opens on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% elif items %}
                          <form method="post" action="/material/{{ mat.id }}/checklist" class="checklist-form">
                            {% csrf_token %}
                            <input type="hidden" name="return_to" value="/student" />
                            {% for item in items %}
                              <label class="checklist-item-row">
                                <input
                                  type="checkbox"
                                  name="checked_item"
                                  value="{{ forloop.counter0 }}"
                                  {% if state and forloop.counter0 in state.checklist_checked %}checked{% endif %}
                                />
                                <span>{{ item }}</span>
                              </label>
                            {% endfor %}
                            <button type="submit">Save checklist</button>
                          </form>
                          <div class="status-row">
                            {% if state and state.checklist_checked|length >= items|length %}
                              <span class="state-pill state-pill--done">Done for now</span>
                            {% else %}
                              <span class="state-pill state-pill--open">In progress</span>
                            {% endif %}
                          </div>
                        {% else %}
                          <div class="muted empty-state">(Checklist has no items yet.)</div>
                        {% endif %}
                      {% endwith %}
                    {% elif mat.type == 'reflection' %}
                      {% with access=material_access|get_item:mat.id state=material_responses|get_item:mat.id %}
                        {% if access.is_lesson_activity and access.is_locked %}
                          <div class="status-row">
                            <span class="state-pill state-pill--locked">Reflection locked</span>
                          </div>
                          <div class="muted">Reflection opens on <strong>{{ access.available_on|date:"M j, Y" }}</strong>.</div>
                        {% else %}
                          {% if mat.body %}
                            <pre class="text-material-preview">{{ mat.body }}</pre>
                          {% endif %}
                          <form method="post" action="/material/{{ mat.id }}/reflection" class="reflection-form">
                            {% csrf_token %}
                            <input type="hidden" name="return_to" value="/student" />
                            <label for="reflection-{{ mat.id }}" class="muted">Your private reflection</label>
                            <textarea id="reflection-{{ mat.id }}" name="reflection_text" rows="5" placeholder="Write a short reflection.">{{ state.reflection_text|default:'' }}</textarea>
                            <button type="submit">Save reflection</button>
                          </form>
                          <div class="status-row">
                            {% if state and state.reflection_text %}
                              <span class="state-pill state-pill--done">Saved</span>
                            {% else %}
                              <span class="state-pill state-pill--open">Not saved yet</span>
                            {% endif %}
                          </div>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      <div class="muted empty-state">(Empty material — teacher will fill this in.)</div>
                    {% endif %}
                  </div>
                {% endfor %}
              {% else %}
                <div class="muted empty-state">No materials yet.</div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <div class="card">
            <p class="muted">No modules yet. A teacher/admin can add them in /admin.</p>
          </div>
        {% endif %}

        {% if helper_widget %}
          {{ helper_widget|safe }}
        {% endif %}
      </main>
    </div>
    <script src="{% static 'js/student_class.js' %}" defer></script>
  </body>
</html>
