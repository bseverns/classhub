<div
  class="helper-widget"
  data-helper-scope-token="{{ helper_scope_token|default:'' }}"
  data-helper-reference="{{ helper_reference|default:'' }}"
  data-helper-context="{{ helper_context|default:'' }}"
  data-helper-topics="{{ helper_topics|default:'' }}"
>
  <div class="helper-title-row">
    <h2 style="margin:0; font-size:1.25rem;">{{ helper_title|default:"Homework Helper" }}</h2>
    <span class="helper-backend-badge">{{ helper_backend_label|default:"Local model (Ollama)" }}</span>
  </div>
  <p class="helper-description">{{ helper_description|default:"Ask the helper for hints, steps, or feedback." }}</p>
  <div class="helper-privacy">
    <p class="muted helper-privacy-line">Stored: helper access timestamps and lesson-scope metadata only (not ads/tracking profiles).</p>
    <p class="muted helper-privacy-line">Storage location: this server.</p>
    <p class="muted helper-privacy-line">
      Retention:
      {% if student_event_retention_days %}
        helper access events are kept up to {{ student_event_retention_days }} day{{ student_event_retention_days|pluralize }}.
      {% else %}
        helper access events stay until admin retention cleanup is run.
      {% endif %}
    </p>
    <p class="muted helper-privacy-line">Delete now: <a href="{{ helper_delete_url|default:'/student/my-data' }}">My Data</a>. No tracking. No ads. No data broker sharing.</p>
  </div>
  <div class="helper-quick-wrap">
    <div class="helper-quick-title">Quick asks (tap to send):</div>
    <div class="helper-quick-actions" role="group" aria-label="Quick helper prompts"></div>
  </div>

  <label class="visually-hidden helper-label" for="helper-input-0">Question for helper</label>
  <textarea id="helper-input-0" class="helper-input" placeholder="Ask for help…"></textarea>
  <button class="helper-submit" type="button">{{ helper_button_label|default:"Ask" }}</button>
  <pre class="helper-output" role="status" aria-live="polite"></pre>
  <div class="helper-citations" hidden>
    <div class="helper-citations-title">Lesson references used</div>
    <ul class="helper-citations-list"></ul>
  </div>
</div>

<style>
  .helper-widget {
    border: 1px solid var(--line, rgba(22, 59, 80, 0.2));
    border-radius: var(--radius, 18px);
    padding: 16px;
    margin-top: 22px;
    background: var(--glass, rgba(255, 255, 255, 0.56));
    backdrop-filter: blur(14px) saturate(150%);
    -webkit-backdrop-filter: blur(14px) saturate(150%);
    box-shadow: var(--shadow, 0 20px 44px rgba(14, 42, 62, 0.16));
    max-width: none;
  }
  .helper-widget textarea {
    width: 100%;
    min-height: 90px;
    padding: 10px;
    border-radius: var(--radius-sm, 12px);
    border: 1px solid var(--line, rgba(22, 59, 80, 0.2));
    background: var(--glass-strong, rgba(255, 255, 255, 0.74));
    color: var(--ink, #143244);
    font-size: 15px;
    font-family: inherit;
  }
  .helper-widget textarea:focus {
    outline: none;
    border-color: var(--focus, #0f7c8b);
    box-shadow: 0 0 0 3px rgba(15, 124, 139, 0.16);
  }
  .helper-widget .helper-submit {
    margin-top: 10px;
    padding: 10px 14px;
    font-size: 14px;
    font-weight: 700;
    border-radius: var(--radius-sm, 12px);
    border: 1px solid rgba(9, 31, 44, 0.24);
    background: linear-gradient(155deg, var(--cta-bg, #12394f), var(--cta-bg-hover, #0f3042));
    color: var(--cta-ink, #eef7fb);
    cursor: pointer;
  }
  .helper-widget .helper-submit:hover {
    filter: brightness(1.04);
  }
  .helper-widget .helper-submit:disabled {
    cursor: wait;
    filter: grayscale(0.25);
    opacity: 0.86;
  }
  .helper-widget pre {
    white-space: pre-wrap;
    margin-top: 12px;
    color: #26495d;
    min-height: 40px;
    border: 1px solid rgba(22, 59, 80, 0.14);
    border-radius: var(--radius-sm, 12px);
    padding: 10px;
    background: rgba(255, 255, 255, 0.44);
  }
  .helper-description {
    color: var(--muted, #4e6f80);
    font-size: 14px;
    margin-top: 4px;
    margin-bottom: 12px;
  }
  .helper-title-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .helper-backend-badge {
    font-size: 12px;
    font-weight: 700;
    border: 1px solid rgba(22, 59, 80, 0.2);
    border-radius: 999px;
    padding: 4px 10px;
    color: #1d475e;
    background: rgba(255, 255, 255, 0.72);
  }
  .helper-privacy {
    margin-top: -4px;
    margin-bottom: 12px;
    border: 1px solid rgba(169, 46, 66, 0.35);
    border-radius: 10px;
    padding: 10px;
    background: linear-gradient(180deg, rgba(255, 240, 242, 0.84), rgba(255, 248, 249, 0.72));
  }
  .helper-privacy-line {
    margin: 0 0 6px 0;
    font-size: 12px;
    text-align: center;
    color: #7b2a39;
    font-weight: 350;
    letter-spacing: 0.004em;
  }
  .helper-privacy-line:last-child {
    margin-bottom: 0;
  }
  .helper-privacy a {
    color: #8f2038;
    text-decoration-color: rgba(143, 32, 56, 0.45);
  }
  .helper-privacy a:hover {
    color: #6e172b;
    text-decoration-color: rgba(110, 23, 43, 0.68);
  }
  .helper-citations {
    margin-top: 10px;
    border-top: 1px solid rgba(22, 59, 80, 0.14);
    padding-top: 10px;
  }
  .helper-citations-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--muted, #4e6f80);
    margin-bottom: 6px;
  }
  .helper-citations-list {
    margin: 0;
    padding-left: 18px;
    display: grid;
    gap: 6px;
  }
  .helper-citations-list li {
    font-size: 12px;
    color: #33596e;
  }
  .helper-quick-wrap {
    margin-bottom: 12px;
  }
  .helper-quick-title {
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.03em;
    text-transform: uppercase;
    color: var(--muted, #4e6f80);
    margin-bottom: 6px;
  }
  .helper-quick-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .helper-widget .helper-quick-action {
    margin-top: 0;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 600;
    border-radius: 999px;
    border: 1px solid rgba(15, 52, 72, 0.24);
    background: rgba(255, 255, 255, 0.72);
    color: #1f455c;
    cursor: pointer;
  }
  .helper-quick-action:hover {
    background: rgba(255, 255, 255, 0.92);
  }
  .helper-quick-action:focus {
    outline: none;
    border-color: var(--focus, #0f7c8b);
    box-shadow: 0 0 0 3px rgba(15, 124, 139, 0.16);
  }
  .helper-quick-action:disabled {
    cursor: wait;
    opacity: 0.8;
  }
  @supports not ((backdrop-filter: blur(2px)) or (-webkit-backdrop-filter: blur(2px))) {
    .helper-widget {
      background: #f6fafc;
    }
    .helper-widget textarea {
      background: #f9fcfe;
    }
  }
</style>

<script>
(function () {
  const getCookie = (name) => {
    const cookies = document.cookie ? document.cookie.split("; ") : [];
    for (const c of cookies) {
      const idx = c.indexOf("=");
      if (idx === -1) continue;
      const k = c.slice(0, idx);
      const v = c.slice(idx + 1);
      if (k === name) return decodeURIComponent(v);
    }
    return "";
  };
  const csrfToken = () => getCookie("csrftoken") || "";

  const widgets = document.querySelectorAll(".helper-widget");
  const QUICK_PROMPTS = {
    piper: [
      {
        label: "Jump not working",
        prompt: "In StoryMode, left/right work but jump does not work in Cheeseteroid. Help me troubleshoot one step at a time.",
      },
      {
        label: "No buttons respond",
        prompt: "None of my StoryMode breadboard buttons are responding. Give me one check at a time and ask me to retest.",
      },
      {
        label: "One direction fails",
        prompt: "Only one movement direction fails on my Piper controls. What should I compare first in my jumper wiring path?",
      },
      {
        label: "Mouse-only path",
        prompt: "I only have a mouse right now, no keyboard. What is the mouse-first path for this lesson?",
      },
      {
        label: "Upload .sb3 help",
        prompt: "I finished but cannot find my .sb3 file to upload. Walk me through check -> retest steps.",
      },
    ],
    scratch: [
      {
        label: "Sprite won't move",
        prompt: "My sprite does not move when I click the green flag. Please give me one Scratch block check at a time.",
      },
      {
        label: "Backdrop won't change",
        prompt: "My backdrop never changes. What is one specific Scratch block check I should do first?",
      },
      {
        label: "Score not updating",
        prompt: "My score is not updating correctly. Help me debug in small steps and retest after each change.",
      },
      {
        label: "Game over missing",
        prompt: "My game over condition does not trigger. Give me one event/broadcast check and then ask me to retest.",
      },
      {
        label: "Save and upload",
        prompt: "Please walk me through saving my Scratch project as .sb3 and uploading it privately.",
      },
    ],
    general: [
      {
        label: "What is today's goal?",
        prompt: "What is the goal for this lesson, and what should be done first?",
      },
      {
        label: "I am stuck",
        prompt: "I am stuck. Ask me one clarifying question, then give me one small next step.",
      },
      {
        label: "How to ask better",
        prompt: "Help me write a clear help request: what I expected, what happened, and what I already tried.",
      },
    ],
  };

  const hasKeyword = (text, words) => words.some((w) => text.includes(w));
  const detectPromptGroup = (ref, context, topics) => {
    const meta = `${ref} ${context} ${topics}`.toLowerCase();
    if (
      hasKeyword(meta, [
        "piper",
        "storymode",
        "pipercode",
        "mars",
        "cheeseteroid",
        "gpio",
        "breadboard",
        "jumper",
        "wiring",
      ])
    ) {
      return "piper";
    }
    if (hasKeyword(meta, ["scratch", "sprite", "backdrop", "animation", "game"])) {
      return "scratch";
    }
    return "general";
  };

  widgets.forEach((widget, idx) => {
    const label = widget.querySelector(".helper-label");
    const textarea = widget.querySelector(".helper-input");
    const button = widget.querySelector(".helper-submit");
    const output = widget.querySelector(".helper-output");
    const citationWrap = widget.querySelector(".helper-citations");
    const citationList = widget.querySelector(".helper-citations-list");
    const quickWrap = widget.querySelector(".helper-quick-wrap");
    const quickActions = widget.querySelector(".helper-quick-actions");
    const inputId = `helper-input-${idx}`;
    textarea.id = inputId;
    label.setAttribute("for", inputId);
    const scopeToken = (widget.dataset.helperScopeToken || "").trim();
    const helperReference = (widget.dataset.helperReference || "").trim();
    const helperContext = (widget.dataset.helperContext || "").trim();
    const helperTopics = (widget.dataset.helperTopics || "").trim();

    const setOutput = (txt) => {
      output.textContent = txt;
    };
    const renderCitations = (rows) => {
      if (!citationWrap || !citationList) return;
      const citations = Array.isArray(rows) ? rows : [];
      citationList.innerHTML = "";
      if (!citations.length) {
        citationWrap.hidden = true;
        return;
      }
      citations.forEach((row) => {
        const li = document.createElement("li");
        const refId = row && row.id ? String(row.id) : "";
        const text = row && row.text ? String(row.text) : "";
        const source = row && row.source ? String(row.source) : "";
        const parts = [];
        if (refId) parts.push(`[${refId}]`);
        if (source) parts.push(`${source}:`);
        parts.push(text);
        li.textContent = parts.join(" ");
        citationList.appendChild(li);
      });
      citationWrap.hidden = false;
    };

    const setQuickActionsBusy = (disabled) => {
      if (!quickActions) return;
      quickActions.querySelectorAll(".helper-quick-action").forEach((quickBtn) => {
        quickBtn.disabled = disabled;
      });
    };

    const sendMessage = async (rawMessage) => {
      const message = (rawMessage || "").trim();
      if (!message) {
        setOutput("Type a question before asking.");
        renderCitations([]);
        return;
      }
      textarea.value = message;
      button.disabled = true;
      button.setAttribute("aria-busy", "true");
      setQuickActionsBusy(true);
      setOutput("Thinking…");
      try {
        const payload = { message };
        if (scopeToken) {
          payload.scope_token = scopeToken;
        }
        const res = await fetch("/helper/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken(),
          },
          credentials: "same-origin",
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          throw new Error("helper_error");
        }
        const data = await res.json();
        setOutput(data.text || "(no output)");
        renderCitations(data.citations || []);
      } catch (err) {
        setOutput("Helper error (check server logs).");
        renderCitations([]);
      } finally {
        button.disabled = false;
        button.removeAttribute("aria-busy");
        setQuickActionsBusy(false);
      }
    };

    const promptGroup = detectPromptGroup(helperReference, helperContext, helperTopics);
    const promptSet = QUICK_PROMPTS[promptGroup] || QUICK_PROMPTS.general;
    if (quickActions && promptSet.length) {
      promptSet.forEach((item) => {
        const quickBtn = document.createElement("button");
        quickBtn.type = "button";
        quickBtn.className = "helper-quick-action";
        quickBtn.textContent = item.label;
        quickBtn.addEventListener("click", () => {
          if (button.disabled) return;
          textarea.value = item.prompt;
          textarea.focus();
          textarea.setSelectionRange(textarea.value.length, textarea.value.length);
          sendMessage(item.prompt);
        });
        quickActions.appendChild(quickBtn);
      });
    } else if (quickWrap) {
      quickWrap.hidden = true;
    }

    button.addEventListener("click", async () => {
      await sendMessage(textarea.value || "");
    });
  });
})();
</script>
