<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Class</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .shell {
        max-width: 760px;
      }
      .hero {
        margin-top: 6px;
        margin-bottom: 14px;
      }
      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 2.8vw, 2.6rem);
      }
      .hero p {
        margin: 8px 0 0 0;
      }
      .error {
        margin-top: 10px;
        padding: 9px 11px;
        border: 1px solid rgba(182, 56, 56, 0.35);
        border-radius: 10px;
        color: #8f2d2d;
        background: rgba(255, 224, 224, 0.55);
        font-size: 14px;
      }
      .actions {
        margin-top: 16px;
      }
      .entry-note {
        margin-top: 16px;
      }
      .privacy-note {
        margin-top: 14px;
        border: 1px solid rgba(169, 46, 66, 0.35);
        border-radius: 12px;
        padding: 12px;
        background: linear-gradient(180deg, rgba(255, 240, 242, 0.84), rgba(255, 248, 249, 0.72));
      }
      .privacy-note p {
        margin: 0 0 6px 0;
        text-align: center;
      }
      .privacy-note .muted {
        color: #7b2a39;
        font-weight: 350;
        letter-spacing: 0.004em;
      }
      .privacy-note p:last-child {
        margin-bottom: 0;
      }
      .privacy-note a {
        color: #8f2038;
        text-decoration-color: rgba(143, 32, 56, 0.45);
      }
      .privacy-note a:hover {
        color: #6e172b;
        text-decoration-color: rgba(110, 23, 43, 0.68);
      }
    </style>
  </head>
  <body class="glass-theme">
    <a class="skip-link" href="#main-content">Skip to main content</a>
    <div class="shell">
      <main id="main-content">
        <div class="hero">
          <h1>Join your class</h1>
          <p class="muted">Enter the class code your teacher gives you. Pick a name your teacher will recognize.</p>
          <p class="muted">If this is the same classroom computer/browser, you can usually leave return code blank.</p>
        </div>

        <div class="card">
          <form id="join-form" novalidate>
            <label for="code">Class code</label>
            <input id="code" name="class_code" placeholder="ABCD1234" autocomplete="off" required />

            <label for="name">Your name</label>
            <input id="name" name="display_name" placeholder="Ada" autocomplete="name" required />

            <label for="return_code">Return code (optional)</label>
            <input id="return_code" name="return_code" placeholder="ABC234" autocomplete="one-time-code" />

            <div class="actions">
              <button id="join" type="submit">Join class</button>
            </div>
            <div id="msg" class="error" role="alert" aria-live="assertive" style="display:none"></div>
          </form>

          <div class="privacy-note" aria-live="polite">
            <p class="muted"><strong>Privacy at a glance:</strong></p>
            <p class="muted">We store your display name, class submissions, and event timestamps needed to run class.</p>
            <p class="muted">Storage location: this server is hosted by createMPLS, a nonprofit educational group.</p>
            <p class="muted">
              Retention:
              {% if submission_retention_days %}
                submissions are kept up to {{ submission_retention_days }} day{{ submission_retention_days|pluralize }} unless deleted sooner.
              {% else %}
                submissions stay until a teacher or admin removes them.
              {% endif %}
            </p>
            <p class="muted">Delete now: after joining, open <a href="/student/my-data">My Data</a> to delete your work or end this device session.</p>
            <p class="muted">No tracking. No ads. No data broker sharing.</p>
          </div>
        </div>

        <p class="muted entry-note">Teacher/admin? Use <a href="/teach">/teach</a> (or <a href="/admin/">/admin</a>).</p>
      </main>
    </div>

    <script>
      const msg = document.getElementById('msg');
      const showErr = (t) => { msg.textContent = t; msg.style.display = 'block'; };

      // Django CSRF: read csrftoken cookie and send it as X-CSRFToken.
      // This keeps CSRF protection enabled without requiring a full form POST.
      const getCookie = (name) => {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (const c of cookies) {
          const idx = c.indexOf('=');
          if (idx === -1) continue;
          const k = c.slice(0, idx);
          const v = c.slice(idx + 1);
          if (k === name) return decodeURIComponent(v);
        }
        return '';
      };

      const csrfToken = () => getCookie('csrftoken') || '';

      (() => {
        const params = new URLSearchParams(window.location.search || '');
        const prefillCode = (params.get('class_code') || params.get('code') || '').trim();
        if (prefillCode) {
          const codeInput = document.getElementById('code');
          codeInput.value = prefillCode;
          const nameInput = document.getElementById('name');
          if (nameInput) nameInput.focus();
        }
      })();

      document.getElementById('join-form').addEventListener('submit', async (event) => {
        event.preventDefault();
        msg.style.display = 'none';
        const class_code = (document.getElementById('code').value || '').trim();
        const display_name = (document.getElementById('name').value || '').trim();
        const return_code = (document.getElementById('return_code').value || '').trim();
        const joinBtn = document.getElementById('join');
        joinBtn.disabled = true;
        joinBtn.setAttribute('aria-busy', 'true');

        try {
          const res = await fetch('/join', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken(),
            },
            credentials: 'same-origin',
            body: JSON.stringify({ class_code, display_name, return_code })
          });

          if (!res.ok) {
            const data = await res.json().catch(() => ({}));
            const e = data.error || 'join_failed';
            if (e === 'invalid_code') return showErr('That class code is not recognized.');
            if (e === 'invalid_return_code') return showErr('That return code is not valid for this class.');
            if (e === 'class_locked') return showErr('This class is locked right now.');
            if (e === 'missing_fields') return showErr('Please enter a class code and your name.');
            if (e === 'rate_limited') return showErr('Too many join attempts. Wait a minute and try again.');
            return showErr('Could not join. Try again.');
          }

          window.location.href = '/student';
        } catch (err) {
          showErr('Network error. Please try again.');
        } finally {
          joinBtn.disabled = false;
          joinBtn.removeAttribute('aria-busy');
        }
      });
    </script>
  </body>
</html>
