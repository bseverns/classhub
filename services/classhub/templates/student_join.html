<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Join Class</title>
    {% include "includes/glass_theme.html" %}
    <style>
      .shell {
        max-width: 760px;
      }
      .hero {
        margin-top: 6px;
        margin-bottom: 14px;
      }
      .hero h1 {
        margin: 0;
        font-size: clamp(2rem, 2.8vw, 2.6rem);
      }
      .hero p {
        margin: 8px 0 0 0;
      }
      .error {
        margin-top: 10px;
        padding: 9px 11px;
        border: 1px solid rgba(182, 56, 56, 0.35);
        border-radius: 10px;
        color: #8f2d2d;
        background: rgba(255, 224, 224, 0.55);
        font-size: 14px;
      }
      .actions {
        margin-top: 16px;
      }
      .entry-note {
        margin-top: 16px;
      }
    </style>
  </head>
  <body class="glass-theme">
    <div class="shell">
      <div class="hero">
        <h1>Join your class</h1>
        <p class="muted">Enter the class code your teacher gives you. Pick a name your teacher will recognize.</p>
      </div>

      <div class="card">
        <label for="code">Class code</label>
        <input id="code" placeholder="ABCD1234" autocomplete="off" />

        <label for="name">Your name</label>
        <input id="name" placeholder="Ada" autocomplete="off" />

        <div class="actions">
          <button id="join">Join class</button>
        </div>
        <div id="msg" class="error" style="display:none"></div>
      </div>

      <p class="muted entry-note">Teacher/admin? Use <a href="/teach">/teach</a> (or <a href="/admin/">/admin</a>).</p>
    </div>

    <script>
      const msg = document.getElementById('msg');
      const showErr = (t) => { msg.textContent = t; msg.style.display = 'block'; };

      // Django CSRF: read csrftoken cookie and send it as X-CSRFToken.
      // This keeps CSRF protection enabled without requiring a full form POST.
      const getCookie = (name) => {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (const c of cookies) {
          const idx = c.indexOf('=');
          if (idx === -1) continue;
          const k = c.slice(0, idx);
          const v = c.slice(idx + 1);
          if (k === name) return decodeURIComponent(v);
        }
        return '';
      };

      const csrfToken = () => getCookie('csrftoken') || '';

      document.getElementById('join').addEventListener('click', async () => {
        msg.style.display = 'none';
        const class_code = (document.getElementById('code').value || '').trim();
        const display_name = (document.getElementById('name').value || '').trim();

        const res = await fetch('/join', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken(),
          },
          credentials: 'same-origin',
          body: JSON.stringify({ class_code, display_name })
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const e = data.error || 'join_failed';
          if (e === 'invalid_code') return showErr('That class code is not recognized.');
          if (e === 'class_locked') return showErr('This class is locked right now.');
          if (e === 'missing_fields') return showErr('Please enter a class code and your name.');
          return showErr('Could not join. Try again.');
        }

        window.location.href = '/student';
      });
    </script>
  </body>
</html>
