# Default env preset is local/day-1.
# For domain/TLS deployments, start from compose/.env.example.domain.
# Mode-specific copies:
# - compose/.env.example.local
# - compose/.env.example.domain
# Routing selector for Caddy template mounted by docker-compose.yml.
# - Caddyfile.local  = local/day-1 HTTP on localhost
# - Caddyfile.domain = real domain + automatic TLS via Caddy
# - Caddyfile.domain.assets = domain mode with separate asset host routing
CADDYFILE_TEMPLATE=Caddyfile.local
# Infrastructure image pins (override only when intentionally upgrading).
CADDY_IMAGE=caddy:2.10.2
POSTGRES_IMAGE=postgres:16.8
REDIS_IMAGE=redis:7.4.2
OLLAMA_IMAGE=ollama/ollama:0.5.7
MINIO_IMAGE=minio/minio:RELEASE.2025-09-07T16-13-09Z-cpuv1
# Runtime UID/GID for classhub_web and helper_web containers.
# Set to your deploy user ids so host-mounted volumes (for example /uploads) stay writable.
APP_UID=1000
APP_GID=1000

# Domain is used by Caddyfile.domain. Keep placeholder until DNS is ready.
DOMAIN=lms.example.org
ASSET_DOMAIN=assets.example.org
CADDY_CLASSHUB_MAX_BODY=220MB
CADDY_HELPER_MAX_BODY=1MB
CADDY_HSTS_MAX_AGE=31536000
# Optional teacher/admin edge armor.
# - IP allowlist applies to /admin* and /teach* routes.
# - Keep default (allow all) unless you have fixed operator IP ranges.
CADDY_STAFF_IP_ALLOWLIST_V4=0.0.0.0/0
CADDY_STAFF_IP_ALLOWLIST_V6=::/0
# Set to 1 only if you intentionally keep staff routes public at the edge.
CADDY_ALLOW_PUBLIC_STAFF_ROUTES=1
# Optional extra gate for /admin* in Caddy (in addition to Django auth + OTP).
# Note: /admin/login* remains Django-only so staff can complete OTP login flow.
CADDY_ADMIN_BASIC_AUTH_ENABLED=0
CADDY_ADMIN_BASIC_AUTH_USER=
# Generate with: docker run --rm caddy:2.10.2 caddy hash-password --plaintext 'strong-password'
# Compose interpolation note: bcrypt hashes contain '$'. Wrap value in single quotes
# or escape each '$' as '$$' to avoid "variable is not set" warnings.
CADDY_ADMIN_BASIC_AUTH_HASH=

POSTGRES_DB=classhub
POSTGRES_USER=classhub
POSTGRES_PASSWORD=REPLACE_ME_STRONG

MINIO_ROOT_USER=minio_admin
MINIO_ROOT_PASSWORD=REPLACE_ME_STRONG

DJANGO_DEBUG=0
DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1
DJANGO_SECRET_KEY=REPLACE_ME_STRONG
# Dedicated signer for student same-device hint cookies.
# Must differ from DJANGO_SECRET_KEY when DJANGO_DEBUG=0.
DEVICE_HINT_SIGNING_KEY=REPLACE_ME_STRONG
DJANGO_TIME_ZONE=America/Chicago
DJANGO_ADMIN_2FA_REQUIRED=1
DJANGO_TEACHER_2FA_REQUIRED=1
CSRF_TRUSTED_ORIGINS=http://localhost
DJANGO_SESSION_COOKIE_DOMAIN=
DJANGO_CSRF_COOKIE_DOMAIN=
# CSP rollout mode:
# - relaxed: enforced relaxed policy + strict report-only policy
# - report-only: strict report-only policy only
# - strict: strict enforced policy only
# Temporary default for class-day safety while inline script migration is in progress.
DJANGO_CSP_MODE=report-only
# Optional enforced CSP override. If set, this overrides mode-derived enforced CSP.
DJANGO_CSP_POLICY=
# Transitional strict-script canary (recommended before full strict flip):
# 1) set DJANGO_CSP_MODE=strict
# 2) set DJANGO_CSP_POLICY to strict script-src + temporary inline style allowance
#    so script execution is locked while inline style cleanup is still in progress.
# DJANGO_CSP_POLICY=default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; img-src 'self' data: https:; media-src 'self' https:; frame-src 'self' https://www.youtube-nocookie.com; style-src 'self' 'unsafe-inline'; script-src 'self'; connect-src 'self' https:;
# Optional report-only CSP override. If set, this overrides mode-derived report-only CSP.
DJANGO_CSP_REPORT_ONLY_POLICY=
DJANGO_PERMISSIONS_POLICY=accelerometer=(), autoplay=(), camera=(), clipboard-read=(), clipboard-write=(self), display-capture=(), encrypted-media=(), fullscreen=(self), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), midi=(), payment=(), publickey-credentials-get=(), usb=(), xr-spatial-tracking=()
DJANGO_X_FRAME_OPTIONS=SAMEORIGIN
DJANGO_EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend
DJANGO_EMAIL_HOST=
DJANGO_EMAIL_PORT=587
DJANGO_EMAIL_HOST_USER=
DJANGO_EMAIL_HOST_PASSWORD=
DJANGO_EMAIL_USE_TLS=1
DJANGO_EMAIL_USE_SSL=0
DJANGO_EMAIL_TIMEOUT_SECONDS=10
DJANGO_DEFAULT_FROM_EMAIL=classhub@localhost
TEACHER_INVITE_FROM_EMAIL=classhub@localhost
TEACHER_2FA_INVITE_MAX_AGE_SECONDS=86400
TEACHER_2FA_DEVICE_NAME=teacher-primary
DJANGO_SECURE_SSL_REDIRECT=0
# HSTS is edge-owned in Caddy (CADDY_HSTS_MAX_AGE). Keep Django value at 0 unless intentionally overriding.
DJANGO_SECURE_HSTS_SECONDS=0
DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=0
DJANGO_SECURE_HSTS_PRELOAD=0
DJANGO_SECURE_REFERRER_POLICY=strict-origin-when-cross-origin
# Local/day-1 default keeps proxy trust off. Domain example enables this.
REQUEST_SAFETY_TRUST_PROXY_HEADERS=0
REQUEST_SAFETY_XFF_INDEX=0
CLASSHUB_AUTH_RATE_LIMIT_WINDOW_SECONDS=60
CLASSHUB_ADMIN_LOGIN_RATE_LIMIT_PER_MINUTE=20
CLASSHUB_TEACHER_2FA_RATE_LIMIT_PER_MINUTE=10
CLASSHUB_HELPER_SIGNAL_WINDOW_HOURS=24
CLASSHUB_HELPER_SIGNAL_TOP_STUDENTS=5
# Optional short-lived cache for teacher tracker panels (seconds). Set 0 to disable.
CLASSHUB_TEACHER_PANEL_CACHE_TTL_SECONDS=0
CLASSHUB_SITE_MODE=normal
CLASSHUB_SITE_MODE_MESSAGE=
# Optional operator profile for white-label deployments (no template edits needed).
CLASSHUB_PRODUCT_NAME=Class Hub
CLASSHUB_OPERATOR_NAME=createMPLS
CLASSHUB_OPERATOR_DESCRIPTOR=a nonprofit educational group
# Optional explicit text override. If blank, generated from operator name + descriptor.
CLASSHUB_STORAGE_LOCATION_TEXT=
CLASSHUB_PRIVACY_PROMISE_TEXT=No tracking. No ads. No data broker sharing.
CLASSHUB_ADMIN_LABEL=createMPLS Course Admin
CLASSHUB_UPLOAD_MAX_MB=200
# Keep request timeout aligned with real upload expectations (60s is often too low on classroom Wi-Fi).
CLASSHUB_GUNICORN_TIMEOUT_SECONDS=1200
CLASSHUB_GUNICORN_WORKERS=2
CLASSHUB_UPLOAD_SCAN_ENABLED=0
CLASSHUB_UPLOAD_SCAN_COMMAND=clamscan --no-summary --stdout
CLASSHUB_UPLOAD_SCAN_TIMEOUT_SECONDS=20
CLASSHUB_UPLOAD_SCAN_FAIL_CLOSED=0
CLASSHUB_MARKDOWN_ALLOW_IMAGES=0
CLASSHUB_MARKDOWN_ALLOWED_IMAGE_HOSTS=
# Optional separate origin for lesson assets/videos rendered in lesson markdown.
# Leave blank to use same-origin links.
CLASSHUB_ASSET_BASE_URL=
CLASSHUB_JOIN_RATE_LIMIT_PER_MINUTE=20
CLASSHUB_DEVICE_REJOIN_COOKIE_NAME=classhub_student_hint
CLASSHUB_DEVICE_REJOIN_MAX_AGE_DAYS=30
# Retention defaults are intentionally nonzero; set to 0 only when opting out explicitly.
CLASSHUB_SUBMISSION_RETENTION_DAYS=90
CLASSHUB_STUDENT_EVENT_RETENTION_DAYS=180
CLASSHUB_PORTFOLIO_FILENAME_MODE=generic
CLASSHUB_STUDENT_EVENT_IP_MODE=truncate
# Optional defaults for scripts/retention_maintenance.sh
RETENTION_SUBMISSION_DAYS=90
RETENTION_EVENT_DAYS=180
RETENTION_EVENT_EXPORT_DIR=/uploads/retention_exports
RETENTION_HELPER_EXPORT_DAYS=180
RETENTION_HELPER_EXPORT_DIR=/uploads/helper_reset_exports
RETENTION_SCAVENGE_MODE=report
RETENTION_ALERT_WEBHOOK_URL=
RETENTION_ALERT_ON_SUCCESS=0
# Production default: migrations run explicitly in deploy scripts, not at container boot.
RUN_MIGRATIONS_ON_START=0

# Homework Helper backend
# Options: "ollama" (default), "openai", or "mock" (CI/test only)
HELPER_LLM_BACKEND=ollama
# Safety gate: set to 1 only after confirming remote-helper data handling policy.
HELPER_REMOTE_MODE_ACKNOWLEDGED=0
HELPER_MOCK_RESPONSE_TEXT=
HELPER_STRICTNESS=light
HELPER_SCOPE_MODE=strict
HELPER_REFERENCE_DIR=/app/tutor/reference
HELPER_REFERENCE_MAP={"piper_scratch":"piper_scratch.md"}
HELPER_REFERENCE_FILE=/app/tutor/reference/piper_scratch.md
HELPER_SCOPE_TOKEN_MAX_AGE_SECONDS=7200
HELPER_RESPONSE_MAX_CHARS=2200
HELPER_CONVERSATION_ENABLED=1
HELPER_CONVERSATION_MAX_MESSAGES=8
HELPER_CONVERSATION_TTL_SECONDS=3600
HELPER_CONVERSATION_TURN_MAX_CHARS=800
HELPER_CONVERSATION_HISTORY_MAX_CHARS=2400
HELPER_CONVERSATION_SUMMARY_MAX_CHARS=900
HELPER_FOLLOW_UP_SUGGESTIONS_MAX=3
HELPER_MAX_CONCURRENCY=2
HELPER_QUEUE_MAX_WAIT_SECONDS=10
HELPER_QUEUE_POLL_SECONDS=0.2
HELPER_QUEUE_SLOT_TTL_SECONDS=120
# Keep helper worker timeout above (queue wait + retries * backend timeout + backoff).
HELPER_GUNICORN_TIMEOUT_SECONDS=180
HELPER_GUNICORN_WORKERS=2
HELPER_BACKEND_MAX_ATTEMPTS=2
HELPER_BACKOFF_SECONDS=0.4
HELPER_CIRCUIT_BREAKER_FAILURES=5
HELPER_CIRCUIT_BREAKER_TTL_SECONDS=30
HELPER_RATE_LIMIT_PER_MINUTE=30
HELPER_RATE_LIMIT_PER_IP_PER_MINUTE=90
HELPER_REQUIRE_CLASSHUB_TABLE=0
HELPER_REQUIRE_SCOPE_TOKEN_FOR_STAFF=0
HELPER_INTERNAL_API_TOKEN=REPLACE_ME_STRONG
HELPER_INTERNAL_RESET_URL=http://helper_web:8000/helper/internal/reset-class-conversations
HELPER_INTERNAL_RESET_TIMEOUT_SECONDS=2
HELPER_INTERNAL_RESET_EXPORT_BEFORE_DELETE=1
HELPER_CLASS_RESET_MAX_KEYS=4000
HELPER_CLASS_RESET_ARCHIVE_ENABLED=1
HELPER_CLASS_RESET_ARCHIVE_DIR=/uploads/helper_reset_exports
HELPER_CLASS_RESET_ARCHIVE_MAX_MESSAGES=120
CLASSHUB_INTERNAL_EVENTS_URL=http://classhub_web:8000/internal/events/helper-chat-access
CLASSHUB_INTERNAL_EVENTS_TOKEN=REPLACE_ME_STRONG
CLASSHUB_INTERNAL_EVENTS_TIMEOUT_SECONDS=3
HELPER_TOPIC_FILTER_MODE=strict
HELPER_TEXT_LANGUAGE_KEYWORDS=pascal,python,java,javascript,typescript,c++,c#,csharp,ruby,php,go,golang,rust,swift,kotlin

# Ollama (local model server)
OLLAMA_BASE_URL=http://ollama:11434
OLLAMA_MODEL=llama3.2:1b
OLLAMA_TIMEOUT_SECONDS=30
OLLAMA_TEMPERATURE=0.2
OLLAMA_TOP_P=0.9
OLLAMA_NUM_PREDICT=400

# OpenAI (optional fallback)
OPENAI_API_KEY=__SET_ME__
OPENAI_MODEL=gpt-5.2
OPENAI_MAX_OUTPUT_TOKENS=400

# Deploy smoke checks (used by scripts/smoke_check.sh --strict)
SMOKE_BASE_URL=https://lms.example.org
SMOKE_CLASS_CODE=ABCD1234
SMOKE_DISPLAY_NAME=Smoke Student
SMOKE_HELPER_MESSAGE=Give one short Scratch hint about moving a sprite.
SMOKE_TEACHER_USERNAME=teacher1
SMOKE_TEACHER_PASSWORD=CHANGE_ME
# Optional: pre-issued Django session key for /teach checks (used by golden smoke).
SMOKE_TEACHER_SESSION_KEY=
SMOKE_TIMEOUT_SECONDS=20
SMOKE_INSECURE_TLS=0
