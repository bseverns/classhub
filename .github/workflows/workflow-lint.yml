name: workflow-lint

on:
  pull_request:
  push:
    branches: [main]

jobs:
  parse-yaml:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: .github/workflows/workflow-lint.yml
      - name: Install YAML parser
        run: pip install pyyaml==6.0.2
      - name: Validate workflow YAML
        run: |
          python - <<'PY'
          import sys
          from pathlib import Path
          import yaml

          workflow_dir = Path(".github/workflows")
          files = sorted({*workflow_dir.glob("*.yml"), *workflow_dir.glob("*.yaml")})
          if not files:
              print("[workflow-lint] FAIL: no workflow files found", file=sys.stderr)
              raise SystemExit(1)

          failures = []
          for path in files:
              raw = path.read_text(encoding="utf-8")
              try:
                  yaml.safe_load(raw)
              except Exception as exc:
                  failures.append(f"{path}: {exc}")

          if failures:
              print("[workflow-lint] FAIL: invalid workflow YAML detected:", file=sys.stderr)
              for row in failures:
                  print(f"  - {row}", file=sys.stderr)
              raise SystemExit(1)

          print(f"[workflow-lint] OK ({len(files)} workflow files parsed)")
          PY
