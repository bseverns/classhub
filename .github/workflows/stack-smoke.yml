name: stack-smoke

on:
  pull_request:
  push:
    branches: [main]

jobs:
  doctor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare compose env for CI doctor run
        run: |
          cp compose/.env.example compose/.env
          # Append CI overrides so env guardrails stay stable even if .env.example formatting changes.
          {
            echo "CADDYFILE_TEMPLATE=Caddyfile.local"
            echo "POSTGRES_PASSWORD=aaaaaaaaaaaaaaaa"
            echo "MINIO_ROOT_PASSWORD=bbbbbbbbbbbbbbbb"
            echo "DJANGO_SECRET_KEY=cccccccccccccccccccccccccccccccc"
            echo "DEVICE_HINT_SIGNING_KEY=eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee"
            echo "HELPER_SCOPE_SIGNING_KEY=gggggggggggggggggggggggggggggggg"
            echo "CLASSHUB_INTERNAL_EVENTS_TOKEN=dddddddddddddddd"
            echo "HELPER_INTERNAL_API_TOKEN=ffffffffffffffff"
            echo "DJANGO_DEBUG=0"
            echo "DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1"
            echo "CSRF_TRUSTED_ORIGINS=http://localhost"
            echo "SMOKE_BASE_URL=http://localhost"
            echo "HELPER_LLM_BACKEND=mock"
            echo "HELPER_TOPIC_FILTER_MODE=strict"
          } >> compose/.env

      - name: Run system doctor with golden-path smoke
        run: |
          bash scripts/system_doctor.sh \
            --build \
            --compose-mode prod \
            --smoke-mode golden \
            --helper-message "Help me with AP calculus limits."
