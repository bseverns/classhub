name: stack-smoke

on:
  pull_request:
  push:
    branches: [main]

jobs:
  doctor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare compose env for CI doctor run
        run: |
          cp compose/.env.example compose/.env
          # Append CI overrides so env guardrails stay stable even if .env.example formatting changes.
          cat >> compose/.env <<'EOF'
CADDYFILE_TEMPLATE=Caddyfile.local
POSTGRES_PASSWORD=aaaaaaaaaaaaaaaa
MINIO_ROOT_PASSWORD=bbbbbbbbbbbbbbbb
DJANGO_SECRET_KEY=cccccccccccccccccccccccccccccccc
DEVICE_HINT_SIGNING_KEY=eeeeeeeeeeeeeeeeeeeeeeeeeeeeeeee
CLASSHUB_INTERNAL_EVENTS_TOKEN=dddddddddddddddd
DJANGO_DEBUG=0
DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1
CSRF_TRUSTED_ORIGINS=http://localhost
SMOKE_BASE_URL=http://localhost
HELPER_LLM_BACKEND=mock
HELPER_TOPIC_FILTER_MODE=strict
EOF

      - name: Run system doctor with golden-path smoke
        run: |
          bash scripts/system_doctor.sh \
            --build \
            --compose-mode prod \
            --smoke-mode golden \
            --helper-message "Help me with AP calculus limits."
