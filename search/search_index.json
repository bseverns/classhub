{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"ClassHub Docs","text":"<p>ClassHub is a self-hosted, classroom-first LMS designed for real programming: fast student join \u2192 lesson \u2192 submission \u2192 teacher review, with a quarantined Homework Helper behind <code>/helper/*</code>.</p>"},{"location":"#quick-links","title":"Quick links","text":"<ul> <li>Start Here</li> <li>Day 1 Checklist</li> <li>Runbook</li> <li>Security Baseline</li> <li>Privacy Addendum</li> <li>Disaster Recovery</li> </ul>"},{"location":"ARCHITECTURE/","title":"Architecture","text":"<p>This system is a small self-hosted LMS stack with a split web surface:</p> <ul> <li><code>Class Hub</code> (main LMS)</li> <li><code>Homework Helper</code> (AI tutor under <code>/helper/*</code>)</li> </ul>"},{"location":"ARCHITECTURE/#runtime-topology-current","title":"Runtime topology (current)","text":"<pre><code>flowchart TD\n  U[Students / Teachers / Admins] --&gt;|HTTP/HTTPS| C[Caddy]\n  C --&gt;|/helper/*| H[Homework Helper Django]\n  C --&gt;|everything else| W[Class Hub Django]\n\n  W --&gt; P[(Postgres)]\n  H --&gt; P\n  W --&gt; R[(Redis db0)]\n  H --&gt; R[(Redis db1)]\n\n  W --&gt; F[(Local upload volume&lt;br/&gt;/uploads)]\n  H --&gt; O[Ollama]\n  H -. optional .-&gt; A[OpenAI Responses API]\n\n  M[(MinIO)] -. reserved / optional .- W</code></pre>"},{"location":"ARCHITECTURE/#trust-boundaries-map-a","title":"Trust boundaries (Map A)","text":"<pre><code>flowchart TB\n  subgraph Z0[\"Internet and Browsers\"]\n    S[\"Student browser\"]\n    T[\"Teacher browser\"]\n    A[\"Admin browser\"]\n  end\n\n  subgraph Z1[\"Edge Proxy (Caddy)\"]\n    C[\"Caddy: TLS, routing, request limits\"]\n  end\n\n  subgraph Z2[\"Application Network\"]\n    CH[\"ClassHub (Django)\"]\n    HH[\"Homework Helper (Django)\"]\n    R[\"Redis cache\"]\n    PG[\"Postgres database\"]\n    FS[\"File storage (/uploads)\"]\n  end\n\n  subgraph Z3[\"Optional External Services\"]\n    YT[\"YouTube-nocookie embeds\"]\n    REM[\"Remote LLM provider (optional)\"]\n  end\n\n  S --&gt;|HTTPS| C\n  T --&gt;|HTTPS| C\n  A --&gt;|HTTPS| C\n\n  C --&gt;|/, /teach, downloads| CH\n  C --&gt;|/helper/*| HH\n\n  CH &lt;--&gt; R\n  CH &lt;--&gt; PG\n  CH &lt;--&gt; FS\n\n  HH &lt;--&gt; R\n  HH --&gt;|metadata event POST| CH\n\n  CH -.-&gt; YT\n  HH -. optional .-&gt; REM</code></pre>"},{"location":"ARCHITECTURE/#what-routes-where","title":"What routes where","text":"<ul> <li>Caddy handles edge traffic.</li> <li><code>/helper/*</code> goes to Homework Helper.</li> <li>All other paths go to Class Hub.</li> </ul> <p>This means helper outages are less likely to take down core LMS pages.</p> <pre><code>flowchart LR\n  S[Student session&lt;br/&gt;class code + display name] --&gt; W[Class Hub]\n  T[Teacher/Admin Django auth + OTP] --&gt; W\n  W --&gt;|signed scope token| H[Homework Helper]\n  H --&gt;|metadata-only event| W</code></pre>"},{"location":"ARCHITECTURE/#data-boundaries","title":"Data boundaries","text":""},{"location":"ARCHITECTURE/#class-hub","title":"Class Hub","text":"<ul> <li>Owns classroom, student, module/material, submission, and teacher portal flows.</li> <li>Uses Postgres + Redis.</li> <li>Stores uploads on local mounted storage (<code>/uploads</code>), not public media routes.</li> </ul>"},{"location":"ARCHITECTURE/#homework-helper","title":"Homework Helper","text":"<ul> <li>Owns helper chat policy, prompt shaping, and model backends.</li> <li>Uses Postgres + Redis for auth/session/rate-limit integration.</li> <li>Uses Ollama by default; OpenAI is optional by environment config.</li> </ul>"},{"location":"ARCHITECTURE/#why-two-django-services","title":"Why two Django services","text":"<ol> <li>Availability isolation: core classroom flows can remain usable when AI degrades.</li> <li>Security boundaries: helper policy/rate-limit logic is isolated from core LMS pages.</li> <li>Operational flexibility: helper can evolve independently (model/backend changes).</li> </ol>"},{"location":"ARCHITECTURE/#deployment-model","title":"Deployment model","text":"<ul> <li>Production images bake service code and curriculum content from repo.</li> <li>Gunicorn serves Django in containers.</li> <li>Local dev uses compose override + bind mounts for fast iteration.</li> </ul> <p>See:</p> <ul> <li>DEVELOPMENT.md for local workflow</li> <li>RUNBOOK.md for operations</li> <li><code>compose/docker-compose.yml</code> for source-of-truth wiring</li> </ul>"},{"location":"ARCHITECTURE/#classhub-module-graph-map-c","title":"ClassHub module graph (Map C)","text":"<pre><code>flowchart TB\n  subgraph URL[\"URLs / Routing\"]\n    U[config/urls.py&lt;br/&gt;route table]\n  end\n\n  subgraph MW[\"Middleware layer\"]\n    M1[SecurityHeadersMiddleware]\n    M2[SiteModeMiddleware]\n    M3[TeacherOTPRequiredMiddleware]\n    M4[StudentSessionMiddleware]\n  end\n\n  subgraph V[\"Views\"]\n    V1[hub/views/student.py&lt;br/&gt;join \u2022 lesson \u2022 upload \u2022 my-data \u2022 exports]\n    V2[hub/views/teacher.py&lt;br/&gt;teacher portal \u2022 roster \u2022 materials]\n    V3[hub/views/content.py&lt;br/&gt;content rendering helpers]\n    V4[hub/views/internal.py&lt;br/&gt;token-gated internal events]\n    V5[hub/views/media.py&lt;br/&gt;asset/video download + stream]\n  end\n\n  subgraph S[\"Services\"]\n    S1[hub/services/content_links.py]\n    S2[hub/services/upload_validation.py]\n    S3[hub/services/filenames.py]\n    S4[hub/services/ip_privacy.py]\n    S5[hub/services/audit.py]\n    S6[hub/services/upload_scan.py]\n    S7[hub/services/release_state.py]\n  end\n\n  subgraph T[\"Templates\"]\n    TT[hub/templatetags/hub_extras.py]\n    TP[templates/student_* + teach_* + includes/helper_widget]\n  end\n\n  subgraph D[\"Data layer\"]\n    MD[hub/models.py]\n    DB[(Postgres)]\n    RC[(Redis/cache)]\n    FS[(MEDIA storage)]\n  end\n\n  subgraph H[\"Homework Helper service\"]\n    H1[tutor/views.py&lt;br/&gt;/helper/chat]\n    H2[tutor/policy.py]\n    H3[tutor/classhub_events.py]\n    H4[common/request_safety]\n  end\n\n  U --&gt; M1 --&gt; M2 --&gt; M3 --&gt; M4 --&gt; V1\n  M4 --&gt; V2\n  M4 --&gt; V3\n  M4 --&gt; V4\n  M4 --&gt; V5\n\n  V1 --&gt; S1\n  V1 --&gt; S2\n  V1 --&gt; S3\n  V1 --&gt; S4\n  V1 --&gt; S5\n  V1 --&gt; S6\n\n  V2 --&gt; S1\n  V2 --&gt; S3\n  V2 --&gt; S5\n  V2 --&gt; S7\n\n  V4 --&gt; S4\n\n  V1 --&gt; MD\n  V2 --&gt; MD\n  V3 --&gt; MD\n  V4 --&gt; MD\n  V5 --&gt; MD\n  MD --&gt; DB\n\n  V1 --&gt; RC\n  V2 --&gt; RC\n  V1 --&gt; FS\n  V2 --&gt; FS\n  V5 --&gt; FS\n\n  V1 --&gt; TP\n  V2 --&gt; TP\n  TP --&gt; TT\n\n  H1 --&gt; H2\n  H1 --&gt; H4\n  H1 --&gt; H3\n  H3 --&gt;|token-gated internal POST| V4\n  H4 --&gt; RC</code></pre>"},{"location":"BOOTSTRAP_SERVER/","title":"Bootstrap the server","text":"<p>Use <code>scripts/bootstrap_day1.sh</code>.</p> <p>It will: - update packages - enable UFW + fail2ban - install Docker + Compose - set Docker log rotation limits - create <code>/srv/classhub</code> folder structure</p> <p>After bootstrapping: - add SSH keys for deploy user - (optionally) enable SSH hardening - point DNS when domain is known - install/configure the LLM backend (Ollama by default)</p>"},{"location":"CLASS_CODE_AUTH/","title":"Class-code auth (student)","text":""},{"location":"CLASS_CODE_AUTH/#mvp-behavior","title":"MVP behavior","text":"<ul> <li>Students do not have email/password.</li> <li>A student joins a class by entering:</li> <li>Class code</li> <li>Display name</li> <li>On first join, we create a <code>StudentIdentity</code>, issue a short <code>return_code</code>, and store   the student id in the session cookie.</li> <li>Rejoin from the same browser/device can reclaim identity automatically when class code</li> <li>display name match a valid signed device hint cookie.</li> <li>Rejoin from a different browser/device requires class code + display name + <code>return_code</code>.</li> </ul>"},{"location":"CLASS_CODE_AUTH/#recovery","title":"Recovery","text":"<p>If cookies are cleared, the student can rejoin using the same class code and their return code.</p>"},{"location":"CLASS_CODE_AUTH/#security-notes","title":"Security notes","text":"<ul> <li>Class codes should be rotatable.</li> <li>Joining can be locked per class.</li> <li><code>/join</code> should be rate-limited to discourage brute force.</li> </ul>"},{"location":"CLASS_CODE_AUTH/#join-flow-map-d1","title":"Join flow (Map D1)","text":"<pre><code>sequenceDiagram\n  participant B as Browser\n  participant MW as Middleware\n  participant V as student.join_class\n  participant DB as Postgres\n  participant R as Redis/cache\n\n  B-&gt;&gt;MW: POST /join (class_code, display_name)\n  MW-&gt;&gt;V: request (site mode + session guardrails)\n  V-&gt;&gt;R: rate limit check (fail-open on cache issues)\n  V-&gt;&gt;DB: lookup Class by join code\n  V-&gt;&gt;DB: create/update StudentIdentity + session binding\n  V-&gt;&gt;DB: write StudentEvent (details minimized)\n  V-&gt;&gt;B: JSON (return_code) + Cache-Control: no-store</code></pre>"},{"location":"CONTRIBUTING_DOCS/","title":"Docs Development","text":""},{"location":"CONTRIBUTING_DOCS/#summary","title":"Summary","text":"<p>Use this page for local MkDocs setup and verification before pushing docs changes.</p>"},{"location":"CONTRIBUTING_DOCS/#what-to-do-now","title":"What to do now","text":"<ol> <li>Create a Python virtual environment.</li> <li>Install docs dependencies.</li> <li>Run local serve/build checks.</li> </ol>"},{"location":"CONTRIBUTING_DOCS/#verification-signal","title":"Verification signal","text":"<p><code>mkdocs build --strict</code> exits with code <code>0</code>.</p>"},{"location":"CONTRIBUTING_DOCS/#local-setup","title":"Local setup","text":"<pre><code>cd /path/to/ClassHub\npython -m venv .venv_docs\nsource .venv_docs/bin/activate\npip install -r requirements-docs.txt\n</code></pre>"},{"location":"CONTRIBUTING_DOCS/#run-docs-locally","title":"Run docs locally","text":"<pre><code>mkdocs serve\n</code></pre> <p>Open the local URL shown in terminal (usually <code>http://127.0.0.1:8000</code>).</p>"},{"location":"CONTRIBUTING_DOCS/#strict-build-check","title":"Strict build check","text":"<pre><code>mkdocs build --strict\n</code></pre>"},{"location":"CONTRIBUTING_DOCS/#ci-workflow","title":"CI workflow","text":"<ul> <li>Docs deploy workflow: <code>.github/workflows/docs.yml</code></li> <li>Triggered when docs files, <code>mkdocs.yml</code>, or <code>requirements-docs.txt</code> change.</li> </ul>"},{"location":"COURSE_AUTHORING/","title":"Course Authoring Guide","text":"<p>This project loads courses directly from disk. No backend changes are required.</p>"},{"location":"COURSE_AUTHORING/#course-folder-structure","title":"Course folder structure","text":"<pre><code>services/classhub/content/courses/&lt;course_slug&gt;/\n  course.yaml\n  lessons/\n    01-lesson-slug.md\n    02-lesson-slug.md\n    ...\n</code></pre>"},{"location":"COURSE_AUTHORING/#create-a-new-course-scaffold","title":"Create a new course (scaffold)","text":"<pre><code>python3 scripts/new_course_scaffold.py \\\n  --slug robotics_intro \\\n  --title \"Robotics: Sensors + Motion\" \\\n  --sessions 8 \\\n  --duration 75 \\\n  --age-band \"5th-7th\"\n</code></pre> <p>This creates: - <code>course.yaml</code> (manifest) - lesson markdown stubs - a helper reference file at <code>services/homework_helper/tutor/reference/&lt;slug&gt;.md</code></p>"},{"location":"COURSE_AUTHORING/#create-a-course-from-a-syllabus-markdown-or-docx","title":"Create a course from a syllabus (Markdown or DOCX)","text":"<p>If you have a teacher-facing session plan file in <code>.md</code> or <code>.docx</code>, you can ingest it:</p> <pre><code>python3 scripts/ingest_syllabus_md.py \\\n  --sessions-md /path/to/teacher_plan.md \\\n  --overview-md /path/to/public_syllabus.md \\\n  --slug scratch_game_design \\\n  --title \"Scratch Game Design + Cutscenes Lab\"\n</code></pre> <p>Dry run (no files written):</p> <pre><code>python3 scripts/ingest_syllabus_md.py \\\n  --sessions-md /path/to/teacher_plan.docx \\\n  --overview-md /path/to/public_syllabus.docx \\\n  --slug scratch_game_design \\\n  --title \"Scratch Game Design + Cutscenes Lab\" \\\n  --dry-run\n</code></pre> <p>Notes: - The script looks for headings like <code># Session 01: Title</code> (or <code>Session 01: Title</code> in DOCX). - It maps sections to lesson front matter:   - Mission \u2192 <code>makes</code>   - Materials \u2192 <code>needs</code>   - Checkpoints \u2192 <code>done_looks_like</code>   - Common stuck points + fixes \u2192 <code>help.quick_fixes</code>   - Extensions \u2192 <code>extend</code>   - Teacher prep \u2192 <code>teacher_panel.prep</code> - Headings such as Teacher prep, Agenda, Materials, Checkpoints, and   Common stuck points + fixes are treated as teacher-facing sections in the app.   They are hidden on learner lesson pages and shown in teacher tools (<code>/teach/lessons</code>   and class dashboard rows). - DOCX works best if section titles are on their own line (e.g., \u201cMaterials\u201d, \u201cAgenda\u201d). - The script prints a warning if no <code>Session 01: Title</code> headers are found.</p>"},{"location":"COURSE_AUTHORING/#generate-teacher-templates-md-docx","title":"Generate teacher templates (<code>.md</code> + <code>.docx</code>)","text":"<p>If teachers need a pre-formatted starter file, generate templates keyed by course slug:</p> <pre><code>python3 scripts/generate_authoring_templates.py \\\n  --slug scratch_game_design \\\n  --title \"Scratch Game Design + Cutscenes Lab\" \\\n  --sessions 12 \\\n  --duration 75 \\\n  --age-band \"5th-7th\"\n</code></pre> <p>Default output folder:</p> <ul> <li><code>docs/examples/course_authoring/&lt;slug&gt;-teacher-plan-template.md</code></li> <li><code>docs/examples/course_authoring/&lt;slug&gt;-teacher-plan-template.docx</code></li> <li><code>docs/examples/course_authoring/&lt;slug&gt;-public-overview-template.md</code></li> <li><code>docs/examples/course_authoring/&lt;slug&gt;-public-overview-template.docx</code></li> </ul> <p>These files are formatted to match the ingest parser in <code>scripts/ingest_syllabus_md.py</code> (<code>Session NN: Title</code>, <code>Mission</code>, <code>Teacher prep</code>, <code>Materials</code>, <code>Checkpoints</code>, <code>Common stuck points + fixes</code>, <code>Extensions</code>).</p> <p>Teacher UI option: - Staff users can generate the same templates from <code>/teach</code> (Teacher Portal home)   by filling in the same four fields: slug, title, sessions, duration. - The same card shows direct download links for any generated files for that slug.</p>"},{"location":"COURSE_AUTHORING/#change-the-course-title-after-scaffolding","title":"Change the course title after scaffolding","text":"<p>1) Update the course manifest:    - <code>services/classhub/content/courses/&lt;course_slug&gt;/course.yaml</code>    - Change <code>title: \"...\"</code>.</p> <p>2) (Optional) Update lesson titles:    - <code>services/classhub/content/courses/&lt;course_slug&gt;/lessons/*.md</code>    - Edit the <code>title:</code> field in the front matter (<code>---</code> block).</p> <p>No backend changes are required; the app reads these files at runtime.</p>"},{"location":"COURSE_AUTHORING/#rename-a-course-slug-manual-steps","title":"Rename a course slug (manual steps)","text":"<p>If you need to change the course slug after creating content, follow this order:</p> <p>1) Rename the course folder:    - <code>services/classhub/content/courses/&lt;old_slug&gt;/</code> \u2192 <code>&lt;new_slug&gt;/</code></p> <p>2) Update <code>course.yaml</code>:    - Change <code>slug: &lt;new_slug&gt;</code></p> <p>3) Update lesson front matter:    - In every lesson file, change <code>course: &lt;new_slug&gt;</code></p> <p>4) Update helper references (optional):    - If you use <code>helper_reference: &lt;old_slug&gt;</code>, update to <code>&lt;new_slug&gt;</code>    - Ensure a matching reference file exists:      - <code>services/homework_helper/tutor/reference/&lt;new_slug&gt;.md</code></p> <p>5) Validate:    - Visit <code>/course/&lt;new_slug&gt;/&lt;lesson_slug&gt;</code> and confirm the page renders.</p>"},{"location":"COURSE_AUTHORING/#lesson-front-matter-template-recommended-fields","title":"Lesson front matter template (recommended fields)","text":"<pre><code>---\ncourse: &lt;course slug&gt;\nsession: 1\nslug: s01-&lt;lesson-slug&gt;\ntitle: &lt;Lesson Title&gt;\navailable_on: YYYY-MM-DD  # optional: intro-only until this date\nduration_minutes: 75\nmakes: &lt;short outcome&gt;\nneeds:\n  - &lt;materials or tools&gt;\nprivacy:\n  - &lt;privacy guardrails&gt;\nvideos: []\nsubmission:\n  type: file\n  accepted:\n    - .&lt;ext&gt;\n  naming: &lt;example&gt;\ndone_looks_like:\n  - &lt;objective check&gt;\nhelp:\n  quick_fixes:\n    - &lt;common fix&gt;\nextend:\n  - &lt;optional stretch&gt;\nteacher_panel:\n  purpose: &lt;goal&gt;\n  snags:\n    - &lt;common pitfalls&gt;\n  assessment:\n    - &lt;what to look for&gt;\n---\n</code></pre> <p>Release scheduling: - Set <code>available_on</code> in lesson front matter to keep lessons in intro-only mode until that date. - You can also set <code>available_on</code> on each lesson entry in <code>course.yaml</code>. - Until the date, students can open the lesson intro but cannot access full lesson sections or submit uploads. - Staff users still see full lesson content. - Teachers can override release dates per class from <code>/teach/lessons</code> or <code>/teach/class/&lt;id&gt;</code>:   - set a date,   - toggle hard lock,   - open now,   - reset back to content defaults.</p> <p>To render videos on lesson pages, add <code>url</code> (or <code>youtube_id</code>) in each <code>videos</code> entry:</p> <pre><code>videos:\n  - id: V01\n    title: \"Boot + desktop tour\"\n    minutes: 4\n    outcome: \"Reach desktop and identify key icons.\"\n    url: \"https://www.youtube.com/watch?v=VIDEO_ID\"\n</code></pre> <p><code>youtube_id</code> and <code>url</code> are both supported; when either resolves to YouTube, the lesson page will embed the video and also show an external link.</p>"},{"location":"COURSE_AUTHORING/#homework-dropbox-behavior","title":"Homework dropbox behavior","text":"<p>When you run <code>import_coursepack</code>, each lesson with:</p> <pre><code>submission:\n  type: file\n</code></pre> <p>gets a <code>Homework dropbox</code> material automatically. Accepted file extensions are taken from <code>submission.accepted</code> (or inferred from <code>submission.naming</code> if needed). Students can open the dropbox from the lesson page and from <code>/student</code>.</p>"},{"location":"COURSE_AUTHORING/#helper-configuration-optional","title":"Helper configuration (optional)","text":"<ul> <li>Per-course reference: set <code>helper_reference</code> in <code>course.yaml</code>.</li> <li>Per-lesson reference: set <code>helper_reference</code> in the lesson entry in <code>course.yaml</code>.</li> <li>Per-lesson allowed topics: add <code>helper_allowed_topics</code> in lesson front matter.</li> </ul> <p>Auto-generate allowed topics:</p> <pre><code>python3 scripts/add_helper_allowed_topics.py \\\n  --lessons-dir services/classhub/content/courses/&lt;course_slug&gt;/lessons \\\n  --write\n</code></pre>"},{"location":"COURSE_AUTHORING/#validate-video-introduction-order","title":"Validate video introduction order","text":"<p>To ensure foundational videos are introduced in sequence (<code>V01</code>, <code>V02</code>, ...):</p> <pre><code>python3 scripts/validate_lesson_video_order.py \\\n  --lessons-dir services/classhub/content/courses/&lt;course_slug&gt;/lessons\n</code></pre> <p>This reports where each video first appears and fails if a higher-numbered video is introduced before a lower-numbered one.</p> <p>Default behavior checks: - <code>V01</code> appears in the first video-bearing session. - <code>videos:</code> in front matter matches the <code>## Watch</code> headings in each lesson.</p> <p>Strict full-course check:</p> <pre><code>python3 scripts/validate_lesson_video_order.py \\\n  --lessons-dir services/classhub/content/courses/&lt;course_slug&gt;/lessons \\\n  --strict-global\n</code></pre> <p>Strict mode also checks: - Video IDs are ascending inside each lesson. - Lower-numbered videos are introduced before higher-numbered videos.</p> <p>Auto-fix Watch heading order/sync to match front matter:</p> <pre><code>python3 scripts/validate_lesson_video_order.py \\\n  --lessons-dir services/classhub/content/courses/&lt;course_slug&gt;/lessons \\\n  --fix-watch-sync\n</code></pre>"},{"location":"COURSE_AUTHORING/#pre-deploy-content-gate","title":"Pre-deploy content gate","text":"<p>Run content checks before deployment:</p> <pre><code>bash scripts/content_preflight.sh &lt;course_slug&gt;\n</code></pre> <p>Strict global mode:</p> <pre><code>bash scripts/content_preflight.sh &lt;course_slug&gt; --strict-global\n</code></pre>"},{"location":"DAY1_DEPLOY_CHECKLIST/","title":"Day 1 deploy checklist (Ubuntu)","text":"<p>See <code>scripts/bootstrap_day1.sh</code> for an automated starter.</p> <pre><code>flowchart TD\n  A[Provision server] --&gt; B[Copy compose/.env]\n  B --&gt; C[Set secrets + domain vars]\n  C --&gt; D[validate_env_secrets]\n  D --&gt; E[migration_gate]\n  E --&gt; F[deploy_with_smoke]\n  F --&gt; G[system_doctor]\n  G --&gt; H[Verify /teach + /healthz]</code></pre>"},{"location":"DAY1_DEPLOY_CHECKLIST/#essentials","title":"Essentials","text":"<ul> <li>Create non-root deploy user</li> <li>Enable firewall (SSH/80/443 only)</li> <li>Install Docker + Compose</li> <li>Set Docker log limits</li> <li>Create <code>/srv/classhub</code> directory spine</li> <li>Put backups off-server</li> </ul>"},{"location":"DAY1_DEPLOY_CHECKLIST/#run","title":"Run","text":"<ul> <li>Copy <code>compose/.env.example</code> \u2192 <code>compose/.env</code></li> <li>Set a strong <code>DJANGO_SECRET_KEY</code> (do not keep placeholder/default values)</li> <li>Keep admin 2FA enforcement enabled: <code>DJANGO_ADMIN_2FA_REQUIRED=1</code></li> <li>For domain/TLS mode, set:</li> <li><code>DJANGO_SECURE_SSL_REDIRECT=1</code></li> <li><code>CADDY_HSTS_MAX_AGE=31536000</code> (after initial validation)</li> <li>Confirm proxy body limits for your workload:</li> <li><code>CADDY_CLASSHUB_MAX_BODY</code> (uploads; default <code>650MB</code>)</li> <li><code>CADDY_HELPER_MAX_BODY</code> (helper API; default <code>1MB</code>)</li> <li>Configure LLM backend (default is Ollama; ensure it is running)</li> <li>Configure smoke-check credentials in <code>compose/.env</code> (for strict mode):</li> <li><code>SMOKE_BASE_URL</code></li> <li><code>SMOKE_CLASS_CODE</code></li> <li><code>SMOKE_TEACHER_USERNAME</code></li> <li><code>SMOKE_TEACHER_PASSWORD</code></li> <li>Optional: use fixture-backed golden smoke mode to avoid managing static smoke credentials:</li> <li><code>DEPLOY_SMOKE_MODE=golden bash scripts/deploy_with_smoke.sh</code></li> <li>Run content preflight checks (blocks bad lesson video/copy sync):</li> <li><code>bash scripts/content_preflight.sh piper_scratch_12_session</code></li> <li>Validate deploy secrets and routing env:</li> <li><code>bash scripts/validate_env_secrets.sh</code></li> <li>Run migration gate:</li> <li><code>bash scripts/migration_gate.sh</code></li> <li>Run deterministic production deploy + smoke:</li> <li><code>bash scripts/deploy_with_smoke.sh</code></li> <li>Run one-command end-to-end diagnostic:</li> <li><code>bash scripts/system_doctor.sh</code></li> <li>Manual production compose fallback (if needed):</li> <li><code>docker compose -f docker-compose.yml up -d --build</code></li> <li>Create first superuser</li> <li>Create at least one staff teacher account (<code>is_staff=True</code>, non-superuser preferred for daily use), e.g.:</li> <li><code>docker compose exec classhub_web python manage.py create_teacher --username teacher1 --email teacher1@example.org --password CHANGE_ME</code></li> <li>Verify health endpoints</li> <li>Verify teacher routes:</li> <li><code>/teach</code></li> <li><code>/teach/lessons</code></li> </ul>"},{"location":"DAY1_DEPLOY_CHECKLIST/#routing-mode-switch-local-vs-domain","title":"Routing mode switch (local vs domain)","text":"<p>Use <code>.env</code> as the single selector (no ad-hoc file renames):</p> <ul> <li>Local/day-1 mode:</li> <li><code>CADDYFILE_TEMPLATE=Caddyfile.local</code></li> <li><code>DOMAIN</code> can stay placeholder</li> <li>Domain/TLS mode:</li> <li><code>CADDYFILE_TEMPLATE=Caddyfile.domain</code></li> <li>set real <code>DOMAIN=...</code></li> <li>point DNS A/AAAA record to server</li> <li>Domain/TLS + separate asset host:</li> <li><code>CADDYFILE_TEMPLATE=Caddyfile.domain.assets</code></li> <li>set <code>DOMAIN=...</code> and <code>ASSET_DOMAIN=...</code></li> <li>set <code>CLASSHUB_ASSET_BASE_URL=https://$ASSET_DOMAIN</code></li> <li>if using sibling subdomains, set:<ul> <li><code>DJANGO_SESSION_COOKIE_DOMAIN=.yourdomain.tld</code></li> <li><code>DJANGO_CSRF_COOKIE_DOMAIN=.yourdomain.tld</code></li> </ul> </li> </ul> <p>Then deploy/reload:</p> <pre><code>cd compose\ndocker compose -f docker-compose.yml up -d --build\n</code></pre> <p>If you need a manual fallback (older docs/scripts), use explicit copy commands:</p> <pre><code>cp compose/Caddyfile.local compose/Caddyfile\ncp compose/Caddyfile.domain compose/Caddyfile\n</code></pre> <p>PowerShell equivalents:</p> <pre><code>Copy-Item compose/Caddyfile.local compose/Caddyfile -Force\nCopy-Item compose/Caddyfile.domain compose/Caddyfile -Force\n</code></pre>"},{"location":"DAY1_DEPLOY_CHECKLIST/#verification-commands-run-in-both-modes","title":"Verification commands (run in both modes)","text":"<p>Local mode expectations (<code>CADDYFILE_TEMPLATE=Caddyfile.local</code>):</p> <pre><code>cd compose\ndocker compose ps\ncurl -i http://localhost/healthz\ncurl -i http://localhost/upstream-healthz\ncurl -i http://localhost/helper/healthz\ncurl -I http://localhost/\n</code></pre> <p>Expected behavior: health endpoints return <code>200</code> on <code>http://localhost</code>; no TLS required.</p> <p>Domain mode expectations (<code>CADDYFILE_TEMPLATE=Caddyfile.domain</code>):</p> <pre><code>cd compose\ndocker compose ps\ncurl -i https://$DOMAIN/healthz\ncurl -i https://$DOMAIN/upstream-healthz\ncurl -i https://$DOMAIN/helper/healthz\ncurl -I http://$DOMAIN/\ncurl -I https://$DOMAIN/\n</code></pre> <p>Expected behavior: HTTPS endpoints return <code>200</code>; HTTP redirects to HTTPS (<code>301</code>/<code>308</code>).</p> <p>Asset-domain mode expectations (<code>CADDYFILE_TEMPLATE=Caddyfile.domain.assets</code>):</p> <pre><code>cd compose\ndocker compose ps\ncurl -i https://$DOMAIN/healthz\ncurl -i https://$DOMAIN/upstream-healthz\ncurl -i https://$ASSET_DOMAIN/healthz\ncurl -i https://$ASSET_DOMAIN/upstream-healthz\ncurl -I https://$ASSET_DOMAIN/lesson-video/1/stream\n</code></pre> <p>Expected behavior: both hosts answer health checks; asset host serves only <code>/lesson-asset/*</code> and <code>/lesson-video/*</code>.</p> <p>Service exposure defaults: - Postgres/Redis are internal-only on Docker networking. - Ollama (<code>11434</code>) and MinIO console (<code>9001</code>) bind to <code>127.0.0.1</code> on host.</p>"},{"location":"DECISIONS/","title":"Decisions (active)","text":"<p>This file tracks current live decisions and constraints. Historical implementation logs and superseded decisions are archived by month in <code>docs/decisions/archive/</code>.</p>"},{"location":"DECISIONS/#active-decisions-snapshot","title":"Active Decisions Snapshot","text":"<ul> <li>Auth model: student access</li> <li>Service boundary: Homework Helper separate service</li> <li>Routing mode: local vs domain Caddy configs</li> <li>Documentation as first-class product surface</li> <li>Secret handling: env-only secret sources</li> <li>Request safety and helper access posture</li> <li>Observability and retention boundaries</li> <li>Deployment guardrails</li> <li>Teacher authoring templates</li> <li>Teacher UI comfort mode</li> <li>Helper scope signing</li> <li>Helper event ingestion boundary</li> <li>Helper grounding for Piper hardware</li> <li>Helper lesson citations</li> <li>Production transport hardening</li> <li>Content parse caching</li> <li>Admin access 2FA</li> <li>Teacher onboarding invites + 2FA</li> <li>Teacher route 2FA enforcement</li> <li>Lesson asset delivery hardening</li> <li>Optional separate asset origin</li> <li>Upload content validation</li> <li>Deployment timezone by environment</li> <li>Migration execution at deploy time</li> <li>Teacher daily digest + closeout workflow</li> <li>Student portfolio export</li> <li>Automated retention maintenance</li> <li>Release verdict: 2026-02-21 hardening/polish push</li> </ul>"},{"location":"DECISIONS/#archive-index","title":"Archive Index","text":"<ul> <li>decisions/archive/2026-02.md</li> <li>decisions/archive/2026-01.md</li> </ul>"},{"location":"DECISIONS/#release-verdict-2026-02-21-hardeningpolish-push","title":"Release verdict: 2026-02-21 hardening/polish push","text":"<p>Current decision: - Treat the 2026-02-21 hardening/polish push as deploy-ready. - Keep <code>/teach</code> strict-smoke credential/session setup as an operational prerequisite, not a code blocker. - Keep the observed server timeout in this validation window classified as expected/non-regression until new evidence shows user-facing impact.</p> <p>Verification evidence (server run): - <code>classhub</code> targeted tests passed: <code>hub.tests.StudentDataControlsTests</code> + <code>hub.tests.TeacherPortalTests</code> (22 tests, OK). - <code>helper</code> targeted tests passed: <code>tutor.tests.HelperChatAuthTests</code> (27 tests, OK). - Smoke checks passed for <code>/healthz</code>, <code>/helper/healthz</code>, <code>/join</code>, and <code>/helper/chat</code>. - Remaining strict-smoke failure was <code>/teach</code> login path using static credentials, consistent with OTP/session setup mismatch rather than application regression.</p> <p>Why this remains active: - Keeps the release record honest about what is truly green vs what is environment configuration debt. - Preserves an auditable boundary between product regressions and operator prerequisites.</p>"},{"location":"DECISIONS/#auth-model-student-access","title":"Auth model: student access","text":"<p>Current decision: - Students join with class code + display name. - Same-device rejoin can use a signed HTTP-only device hint cookie. - Cross-device rejoin uses student return code. - Teachers/admins authenticate with Django auth credentials.</p> <p>Why this remains active: - Keeps student friction low while limiting impersonation risk. - Maintains minimal student PII collection in MVP.</p>"},{"location":"DECISIONS/#admin-access-2fa","title":"Admin access 2FA","text":"<p>Current decision: - Django admin uses OTP-verified superuser sessions by default in both services. - <code>DJANGO_ADMIN_2FA_REQUIRED=1</code> is the expected production posture. - OTP enrollment is provisioned operationally via <code>bootstrap_admin_otp</code> command.</p> <p>Why this remains active: - Reduces risk from password reuse/phishing against admin accounts. - Preserves clear separation: teacher workflow in <code>/teach</code>, hardened ops workflow in <code>/admin</code>.</p>"},{"location":"DECISIONS/#teacher-onboarding-invites-2fa","title":"Teacher onboarding invites + 2FA","text":"<p>Current decision: - Superusers can create teacher staff accounts from <code>/teach</code> and trigger invite emails. - Invite email carries a signed, expiring link to <code>/teach/2fa/setup</code>. - <code>/teach/2fa/setup</code> provisions and confirms teacher TOTP devices via QR + manual secret fallback. - SMTP remains environment-configured; local default is console backend for safe non-production testing.</p> <p>Why this remains active: - Removes CLI-only OTP provisioning friction during teacher onboarding. - Keeps enrollment self-service while preserving short-lived, signed invite boundaries.</p>"},{"location":"DECISIONS/#teacher-route-2fa-enforcement","title":"Teacher route 2FA enforcement","text":"<p>Current decision: - <code>/teach/*</code> now requires OTP-verified staff sessions by default (<code>DJANGO_TEACHER_2FA_REQUIRED=1</code>). - <code>/teach/2fa/setup</code> and <code>/teach/logout</code> stay exempt so enrollment/recovery remains reachable. - Middleware redirects unverified staff to <code>/teach/2fa/setup?next=&lt;requested_teach_path&gt;</code>.</p> <p>Why this remains active: - Teacher routes can rotate join codes, manage rosters, and access submissions; password-only is insufficient. - Keeps teacher onboarding usable while enforcing stronger session posture on operational pages.</p>"},{"location":"DECISIONS/#lesson-asset-delivery-hardening","title":"Lesson asset delivery hardening","text":"<p>Current decision: - Lesson assets are served as attachments by default. - Inline rendering is restricted to allow-listed media/PDF MIME types only. - Asset responses include <code>X-Content-Type-Options: nosniff</code>; inline responses include CSP sandbox.</p> <p>Why this remains active: - Reduces stored-XSS risk from HTML/script-like teacher uploads served on the LMS origin. - Preserves inline behavior for expected classroom media types.</p>"},{"location":"DECISIONS/#optional-separate-asset-origin","title":"Optional separate asset origin","text":"<p>Current decision: - Set <code>CLASSHUB_ASSET_BASE_URL</code> to rewrite lesson media URLs (<code>/lesson-asset/*</code>, <code>/lesson-video/*</code>) to a separate origin. - Markdown-rendered lesson links and teacher asset/video copy links both use this rewrite when configured. - Leave <code>CLASSHUB_ASSET_BASE_URL</code> empty for same-origin behavior.</p> <p>Why this remains active: - Gives operators an incremental path to isolate uploaded media origin without changing teacher authoring flow. - Keeps local/day-1 deployments simple while enabling stricter production hosting topologies.</p>"},{"location":"DECISIONS/#upload-content-validation","title":"Upload content validation","text":"<p>Current decision: - Extension checks remain, but uploads now include lightweight content checks before storage. - <code>.sb3</code> uploads must be valid zip archives and include <code>project.json</code>. - Magic-byte checks reject obvious extension/content mismatches for common file types.</p> <p>Why this remains active: - Reduces support churn from corrupted/mislabeled files. - Adds cheap safety checks without introducing heavyweight scanning dependencies.</p>"},{"location":"DECISIONS/#deployment-timezone-by-environment","title":"Deployment timezone by environment","text":"<p>Current decision: - Both services read <code>DJANGO_TIME_ZONE</code> (default <code>America/Chicago</code>) instead of hardcoding UTC. - Operators set local classroom timezone in <code>compose/.env</code> (for example <code>America/Chicago</code>).</p> <p>Why this remains active: - Release-date gating uses <code>timezone.localdate()</code>, so deployment timezone must match classroom expectations. - Prevents off-by-one-day release behavior around local midnight.</p>"},{"location":"DECISIONS/#migration-execution-at-deploy-time","title":"Migration execution at deploy time","text":"<p>Current decision: - Deploy/doctor/golden scripts explicitly run <code>manage.py migrate --noinput</code> for both services. - Production defaults set <code>RUN_MIGRATIONS_ON_START=0</code>; local/dev can opt into boot-time migrations explicitly.</p> <p>Why this remains active: - Explicit migration steps are safer for multi-instance deployment workflows. - Prevents migration races when multiple app containers start concurrently.</p>"},{"location":"DECISIONS/#large-upload-reliability-timeout","title":"Large upload reliability timeout","text":"<p>Current decision: - Class Hub Gunicorn timeout is configurable via <code>CLASSHUB_GUNICORN_TIMEOUT_SECONDS</code> (default <code>1200</code>). - Upload body limits remain controlled separately by <code>CLASSHUB_UPLOAD_MAX_MB</code> and <code>CADDY_CLASSHUB_MAX_BODY</code>.</p> <p>Why this remains active: - Classroom upload reliability is dominated by slow/shared Wi-Fi conditions. - A low app worker timeout causes avoidable upload failures even when body limits are configured correctly.</p>"},{"location":"DECISIONS/#service-boundary-homework-helper-separate-service","title":"Service boundary: Homework Helper separate service","text":"<p>Current decision: - Homework Helper remains a separate Django service. - Routing is under <code>/helper/*</code> through Caddy. - Helper policy, limits, and failure handling are isolated from Class Hub page delivery.</p> <p>Why this remains active: - Protects classroom materials from helper outages. - Preserves independent scaling and policy controls as helper traffic grows.</p>"},{"location":"DECISIONS/#routing-mode-local-vs-domain-caddy-configs","title":"Routing mode: local vs domain Caddy configs","text":"<p>Current decision: - Unknown/no domain: use <code>compose/Caddyfile.local</code>. - Known domain: use <code>compose/Caddyfile.domain</code> with Caddy-managed TLS. - Optional separate asset host: use <code>compose/Caddyfile.domain.assets</code> + <code>ASSET_DOMAIN</code>. - Template selection is explicit via <code>CADDYFILE_TEMPLATE</code> in <code>compose/.env</code>.</p> <p>Why this remains active: - Keeps local setup simple while preserving production-safe HTTPS behavior. - Reduces configuration drift during deployment.</p>"},{"location":"DECISIONS/#documentation-as-first-class-product-surface","title":"Documentation as first-class product surface","text":"<p>Current decision: - Documentation is treated as a core deliverable, not a trailing artifact. - Role-based entrypoint remains START_HERE.md. - Documentation contract and standards are centralized in index.md. - Guided, hands-on learning tracks are maintained in LEARNING_PATHS.md. - Symptom-first operational triage is maintained in TROUBLESHOOTING.md. - Documentation pedagogy and maintainer writing standards are maintained in TEACHING_PLAYBOOK.md.</p> <p>Why this remains active: - This repository is both an operational system and a teaching object. - Maintainers need repeatable onboarding and incident handling, not tribal knowledge. - Shipping docs in lockstep with code reduces deployment and handoff risk.</p>"},{"location":"DECISIONS/#secret-handling-env-only-secret-sources","title":"Secret handling: env-only secret sources","text":"<p>Current decision: - Secrets are injected via environment (<code>compose/.env</code> or deployment environment), never committed to git. - <code>DJANGO_SECRET_KEY</code> is required in both services. - <code>.env.example</code> stays non-sensitive and documents required knobs.</p> <p>Why this remains active: - Prevents insecure fallback secret boot behavior. - Supports basic secret hygiene for self-hosted operations. - Keeps rotation/update workflow operationally simple.</p>"},{"location":"DECISIONS/#request-safety-and-helper-access-posture","title":"Request safety and helper access posture","text":"<p>Current decision: - Helper chat requires either authenticated staff context or valid student classroom session context. - Student session validation checks classhub identity rows when table access is available, and fails open when classhub tables are unavailable. - Shared request-safety helpers are canonical for proxy-aware client IP parsing and cache-backed limiter behavior. - Shared limiter helpers fail open when cache backends error, and emit request-id-tagged warnings when available. - Helper admin follows superuser-only access, matching classhub admin posture.</p> <p>Why this remains active: - Prevents policy drift between services. - Reduces abuse risk while keeping classroom usage workable behind proxies.</p>"},{"location":"DECISIONS/#observability-and-retention-boundaries","title":"Observability and retention boundaries","text":"<p>Current decision: - Teacher/staff mutations emit append-only <code>AuditEvent</code> records. - Student join/rejoin/upload/helper-access metadata emits append-only <code>StudentEvent</code> records. - Retention is operator-managed using prune commands. - Student event prune supports optional CSV snapshot export before deletion (<code>prune_student_events --export-csv &lt;path&gt;</code>). - File-backed upload models use delete/replacement cleanup signals to prevent orphan file accumulation. - Orphan file scavenger is available for legacy cleanup (<code>scavenge_orphan_uploads</code>, report-first).</p> <p>Why this remains active: - Preserves incident traceability and accountability. - Keeps privacy boundaries explicit by storing metadata rather than raw helper prompt/file content in event logs. - Supports audit handoff and offline review before destructive retention actions. - Keeps upload storage bounded and predictable after roster resets, asset/video deletes, and file replacements.</p>"},{"location":"DECISIONS/#deployment-guardrails","title":"Deployment guardrails","text":"<p>Current decision: - Deploy path uses migration gate + smoke checks + deterministic compose invocation. - Caddy mount source must match the expected compose config file. - <code>scripts/system_doctor.sh</code> is the canonical one-command stack diagnostic. - Golden-path smoke can auto-provision fixtures via <code>scripts/golden_path_smoke.sh</code>. - Class Hub static assets are collected during image build; runtime migrations stay disabled in production (<code>RUN_MIGRATIONS_ON_START=0</code>) while deploy scripts run explicit migrations. - Edge health remains <code>/healthz</code> and upstream app health is exposed at <code>/upstream-healthz</code> for monitoring clarity. - Smoke checks default to <code>http://localhost</code> when <code>CADDYFILE_TEMPLATE=Caddyfile.local</code>, regardless of placeholder <code>SMOKE_BASE_URL</code> values in env examples. - CI doctor smoke uses <code>HELPER_LLM_BACKEND=mock</code> to keep <code>/helper/chat</code> deterministic without runtime model pull dependencies. - Golden smoke issues a server-side staff session key for <code>/teach</code> checks so admin-login form changes (OTP/superuser prompts) do not create false negatives. - Regression coverage is required for helper auth/admin hardening and backend retry/circuit behavior.</p> <p>Why this remains active: - Prevents avoidable outages from config drift. - Catches regressions before users encounter them. - Reduces operator setup friction for smoke checks that previously depended on static credentials. - Reduces startup-time healthcheck failures from long runtime <code>collectstatic</code> work. - Prevents CI from accidentally probing external placeholder domains while validating local compose stacks. - Prevents CI flakes when local model servers are reachable but model weights are not yet loaded. - Keeps strict smoke focused on route authorization outcomes instead of brittle intermediate login form internals.</p>"},{"location":"DECISIONS/#retention-defaults-are-nonzero","title":"Retention defaults are nonzero","text":"<p>Current decision: - <code>compose/.env.example</code> sets:   - <code>CLASSHUB_SUBMISSION_RETENTION_DAYS=90</code>   - <code>CLASSHUB_STUDENT_EVENT_RETENTION_DAYS=180</code> - Operators can still set either value to <code>0</code> as an explicit opt-out.</p> <p>Why this remains active: - Avoids accidental \u201cindefinite forever\u201d storage when pilots become long-running deployments. - Keeps privacy defaults aligned with documented retention posture.</p>"},{"location":"DECISIONS/#teacher-invite-token-hardening","title":"Teacher invite token hardening","text":"<p>Current decision: - Teacher 2FA setup invite links are one-time use. - Invite links are consumed when first opened and immediately redirected to a tokenless setup URL. - Default invite TTL is 24 hours (<code>TEACHER_2FA_INVITE_MAX_AGE_SECONDS=86400</code>).</p> <p>Why this remains active: - Reduces bearer-token exposure via browser history, screenshots, and accidental link reuse. - Preserves simple onboarding while adding practical replay resistance.</p>"},{"location":"DECISIONS/#linteditor-baseline","title":"Lint/editor baseline","text":"<p>Current decision: - Repo-level lint baseline is defined in <code>pyproject.toml</code> (Ruff). - Editor defaults are defined in <code>.editorconfig</code>. - CI lint runs <code>ruff check services scripts</code> against that shared baseline.</p> <p>Why this remains active: - Keeps code-style drift low across contributors and machines. - Prevents silent mismatch between local lint runs and CI behavior.</p>"},{"location":"DECISIONS/#teacher-authoring-templates","title":"Teacher authoring templates","text":"<p>Current decision: - Provide a script (<code>scripts/generate_authoring_templates.py</code>) that outputs both <code>.md</code> and <code>.docx</code> teacher templates keyed by course slug. - Keep template sections aligned with <code>scripts/ingest_syllabus_md.py</code> parsing rules so teachers can fill in and import without manual reformatting. - Expose the generator in the teacher landing page (<code>/teach</code>) with four required fields: slug, title, sessions, and duration. - Provide staff-only direct download links for generated files from the same <code>/teach</code> card. - Store UI-generated files under <code>CLASSHUB_AUTHORING_TEMPLATE_DIR</code> (default <code>/uploads/authoring_templates</code>) to avoid write dependencies on source mounts.</p> <p>Why this remains active: - Teachers can author in familiar formats (Markdown or Word) while preserving deterministic ingestion. - Reduces onboarding friction and avoids repeated format mistakes in session-plan documents.</p>"},{"location":"DECISIONS/#teacher-ui-comfort-mode","title":"Teacher UI comfort mode","text":"<p>Current decision: - Teacher pages opt into a dedicated readability mode via <code>body.teacher-comfort</code>. - Comfort mode increases card/table/form spacing, reduces motion emphasis, and removes decorative orb overlays. - Student-facing pages keep existing visual behavior.</p> <p>Why this remains active: - Reduces visual fatigue during long grading/planning sessions. - Improves scanability of dense teacher workflows without a full redesign.</p>"},{"location":"DECISIONS/#helper-scope-signing","title":"Helper scope signing","text":"<p>Current decision: - Class Hub now signs helper scope metadata (context/topics/allowed-topics/reference) and sends it as <code>scope_token</code>. - Homework Helper verifies <code>scope_token</code> server-side and ignores tamperable client scope fields. - Student helper requests require a valid scope token. - Staff can be forced to require scope tokens by setting <code>HELPER_REQUIRE_SCOPE_TOKEN_FOR_STAFF=1</code>.</p> <p>Why this remains active: - Prevents students from broadening helper scope by editing browser requests. - Preserves lesson-scoped helper behavior without coupling helper directly to classhub content mounts.</p>"},{"location":"DECISIONS/#helper-event-ingestion-boundary","title":"Helper event ingestion boundary","text":"<p>Current decision: - Homework Helper no longer writes directly to Class Hub tables. - Helper emits metadata-only chat access events to <code>POST /internal/events/helper-chat-access</code> on Class Hub. - Endpoint is authenticated with <code>CLASSHUB_INTERNAL_EVENTS_TOKEN</code> and appends <code>StudentEvent</code> rows server-side.</p> <p>Why this remains active: - Removes raw cross-service SQL writes and keeps ownership of <code>StudentEvent</code> writes inside Class Hub. - Preserves append-only telemetry behavior while reducing coupling between services.</p>"},{"location":"DECISIONS/#helper-grounding-for-piper-hardware","title":"Helper grounding for Piper hardware","text":"<p>Current decision: - Piper course helper references include explicit hardware troubleshooting context (breadboard/jumper/shared-ground/input-path checks), not only Scratch workflow guidance. - Per-lesson helper references include \"Common stuck issues (symptom -&gt; check -&gt; retest)\" snippets for deterministic coaching before open-ended hinting. - Early StoryMode lessons include hardware phrases in <code>helper_allowed_topics</code> so strict topic filtering still permits Piper control/wiring questions. - Helper chat uses a deterministic Piper hardware triage branch for wiring-style questions (clarify mission/step, one targeted check, retest request) before model generation. - Helper widget includes context-aware quick-action prompts (Piper vs Scratch vs general) that one-tap send structured help requests. - <code>scripts/eval_helper.py</code> supports lightweight rule-based scoring (including Piper hardware cases) so response regressions are easier to spot in CI/local checks.</p> <p>Why this remains active: - The Piper course includes both Scratch work and physical control wiring; helper grounding must reflect both to be useful in class. - Narrow topic filtering without hardware terms can incorrectly block or under-serve valid lesson questions.</p>"},{"location":"DECISIONS/#helper-lesson-citations","title":"Helper lesson citations","text":"<p>Current decision: - Helper now retrieves short lesson excerpts from the signed lesson reference file and includes up to 3 citations in each <code>/helper/chat</code> response. - Prompt policy tells the model to ground responses in those excerpts and cite bracket ids (for example <code>[L1]</code>) when relevant. - Student helper widget renders returned citations under the answer so grounding is visible to the learner.</p> <p>Why this remains active: - Makes helper output more inspectable and less likely to drift away from lesson intent. - Gives teachers/students quick traceability from advice back to lesson material.</p>"},{"location":"DECISIONS/#production-transport-hardening","title":"Production transport hardening","text":"<p>Current decision: - Internal services remain private by default (Postgres/Redis internal network only; Ollama/MinIO host bindings are localhost-only). - Caddy uses default reverse-proxy forwarded headers for Django client IP/proto awareness. - Proxy-header trust is explicit opt-in (<code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=0</code> by default). - Caddy enforces request-body limits per upstream (<code>CADDY_CLASSHUB_MAX_BODY</code>, <code>CADDY_HELPER_MAX_BODY</code>). - Class Hub and Helper emit enforced + report-only CSP baselines by default in production; <code>DJANGO_CSP_POLICY</code> and <code>DJANGO_CSP_REPORT_ONLY_POLICY</code> can override/tune them. - Both Django services reject weak/default secret keys when <code>DJANGO_DEBUG=0</code>. - Deploy flow includes automated <code>.env</code> validation via <code>scripts/validate_env_secrets.sh</code>. - Security headers and HTTPS controls are enabled in production through explicit env knobs (<code>DJANGO_SECURE_*</code>). - UI templates use local/system font stacks only (no Google Fonts network calls). - CI now guards against non-localhost published ports for internal services (<code>scripts/check_compose_port_exposure.py</code>). - CI now includes secret scanning and Python dependency vulnerability scanning (<code>.github/workflows/security.yml</code>). - CI stack-smoke now sets a non-placeholder <code>CLASSHUB_INTERNAL_EVENTS_TOKEN</code> before running <code>scripts/system_doctor.sh</code>.</p> <p>Why this remains active: - Reduces accidental public exposure of internal services. - Improves trust in proxy-aware rate limiting and secure-cookie behavior. - Drops oversized requests at the edge before they reach Django workers. - Prevents unsafe production boots with placeholder secrets. - Removes third-party font calls from student/teacher/admin page loads. - Makes CSP rollout incremental without breaking inline-heavy templates. - Prevents accidental internal service exposure regressions during future compose edits. - Keeps proxy trust assumptions explicit and reviewable in deploy configuration.</p>"},{"location":"DECISIONS/#content-parse-caching","title":"Content parse caching","text":"<p>Current decision: - Course manifests and lesson markdown parsing are cached in-process using <code>(path, mtime)</code> keys. - Cache entries invalidate automatically when file modification times change. - Returned manifest/front-matter payloads are deep-copied on read to prevent accidental mutation leaks.</p> <p>Why this remains active: - Reduces repeated disk + YAML/markdown parsing overhead on hot lesson/class pages. - Keeps behavior deterministic for live content edits without requiring manual cache flushes.</p>"},{"location":"DECISIONS/#teacher-lesson-level-helper-tuning","title":"Teacher lesson-level helper tuning","text":"<p>Current decision: - Reuse <code>LessonRelease</code> as the per-class/per-lesson storage point for teacher helper-scope overrides. - Teachers can set optional overrides for helper context, focus topics, allowed-topic gate, and reference key directly from each lesson row in <code>/teach/class/&lt;id&gt;</code>. - Class Hub applies these overrides when issuing signed helper scope tokens for students in that class.</p> <p>Why this remains active: - Keeps helper tuning close to lesson release controls where teachers already manage pacing. - Avoids introducing a second override model/table for the same class+lesson keyspace.</p>"},{"location":"DECISIONS/#collapsed-teacher-course-controls-by-default","title":"Collapsed teacher course controls by default","text":"<p>Current decision: - On the teacher class dashboard, <code>Roster</code>, <code>Lesson Tracker</code>, and <code>Module Editor</code> are collapsed by default using explicit section toggles. - Content is shown only when the teacher opens a section.</p> <p>Why this remains active: - Reduces visual load in day-to-day teaching workflows while preserving full control paths. - Makes the class dashboard easier to scan during live instruction.</p>"},{"location":"DECISIONS/#progressive-docs-layering-for-non-developers","title":"Progressive docs layering for non-developers","text":"<p>Current decision: - Introduce a dedicated non-developer entry page: NON_DEVELOPER_GUIDE.md. - Keep START_HERE.md short and role-based with minimal links per audience. - Keep index.md as a concise docs index (not a wall of policy text). - Keep deep ops docs (RUNBOOK.md, TROUBLESHOOTING.md) in quick-action-first format with command blocks and symptom indexing.</p> <p>Why this remains active: - Most readers need task guidance, not full architecture context. - Progressive disclosure lowers cognitive load for teachers and staff while preserving deep technical docs for operators/developers.</p>"},{"location":"DECISIONS/#teacher-daily-digest-closeout-workflow","title":"Teacher daily digest + closeout workflow","text":"<p>Current decision: - <code>/teach</code> includes a per-class \"since yesterday\" digest (new students, uploads, helper usage, first-upload gaps, latest submission timestamp). - <code>/teach</code> includes collapsed closeout actions per class: lock class, export today's submissions zip, print join card. - Closeout export is local-day scoped (deployment timezone aware), with audit events for lock/export actions.</p> <p>Why this remains active: - Gives teachers a fast day-over-day signal without opening each class. - Standardizes end-of-class operations into one predictable flow.</p>"},{"location":"DECISIONS/#student-portfolio-export","title":"Student portfolio export","text":"<p>Current decision: - Students can download a personal portfolio ZIP from <code>/student/portfolio-export</code>. - The ZIP contains:   - <code>index.html</code> (offline summary with timestamps, lesson/module labels, notes),   - <code>files/...</code> entries for that student's own submissions only. - Export filenames are sanitized and scoped to the current authenticated student session.</p> <p>Why this remains active: - Gives students a take-home artifact without requiring full accounts. - Supports portability and parent/mentor sharing while preserving class privacy boundaries.</p>"},{"location":"DECISIONS/#automated-retention-maintenance","title":"Automated retention maintenance","text":"<p>Current decision: - Use <code>scripts/retention_maintenance.sh</code> as the single scheduled task entrypoint for:   - <code>prune_submissions</code>   - <code>prune_student_events</code> (with optional CSV export-before-delete)   - <code>scavenge_orphan_uploads</code> (report/delete/off modes) - Optional webhook notifications report failures (and optional success) for unattended runs. - Provide reference systemd units in <code>ops/systemd/</code> for daily execution.</p> <p>Why this remains active: - Moves retention from manual cleanup to reliable routine operations. - Surfaces cleanup failures early and keeps uploads/event tables bounded over time.</p>"},{"location":"DECISIONS/#defensive-hardening-pass-downloads-return-codes-rate-limits","title":"Defensive hardening pass (downloads, return codes, rate limits)","text":"<p>Current decision: - Submission downloads now force safer browser behavior:   - sanitized attachment filename   - <code>Content-Type: application/octet-stream</code>   - <code>X-Content-Type-Options: nosniff</code>   - <code>Content-Security-Policy: default-src 'none'; sandbox</code>   - <code>Referrer-Policy: no-referrer</code> - Return codes are masked by default in student and teacher pages, with explicit <code>Show/Hide</code> and <code>Copy</code> controls. - Return-code pages and submission downloads set <code>Cache-Control: private, no-store</code> to reduce shared-device/back-button exposure. - <code>join_class</code> responses now emit <code>Cache-Control: no-store</code> (+ <code>Pragma: no-cache</code>) because they carry student return codes in JSON. - <code>student_portfolio_export</code> now emits <code>Cache-Control: private, no-store</code> and <code>X-Content-Type-Options: nosniff</code>. - Student event payloads are reduced to low-sensitivity metadata (for example, join mode and file extension), avoiding display-name/class-code duplication. - Internal helper chat access events now enforce a strict details allowlist before persistence, silently dropping unknown keys. - Helper -&gt; ClassHub internal event forwarding now uses an ultra-short timeout by default (0.35s), stays best-effort, and logs only request-id/error metadata. - Cache-backed limiter helpers now tolerate corrupt cache state without raising request-path errors (fail-open with warning logs including request id). - Release archives now run a reusable artifact lint check (<code>scripts/lint_release_artifact.py</code>) and exclude local/runtime secrets and state (<code>compose/.env</code> + local backup variants, <code>data/</code>, <code>.deploy/</code>). - <code>safe_filename</code> now lives in a dedicated filename service module (<code>hub/services/filenames.py</code>) and is imported where needed. - TODO: If we need stronger return-code secrecy, move reveal-from-DOM to an authenticated fetch endpoint (<code>/student/return-code</code>) in a follow-up pass; deferred to avoid broad template/JS churn in this defensive sprint.</p> <p>Why this remains active: - Reduces content-sniffing and filename abuse risk on download endpoints. - Limits shoulder-surfing exposure for return codes during classroom use. - Preserves classroom availability during transient cache issues. - Keeps release bundles safer and reproducible across local and CI workflows.</p>"},{"location":"DECISIONS/#public-domain-hardening-pass-csp-enforcement-proxy-armor-degradation-modes","title":"Public-domain hardening pass (CSP enforcement, proxy armor, degradation modes)","text":"<p>Current decision: - Security header and cache ownership is documented in one place: SECURITY_BASELINE.md. - Class Hub and Helper now support enforced CSP via <code>DJANGO_CSP_POLICY</code> while still emitting report-only CSP via <code>DJANGO_CSP_REPORT_ONLY_POLICY</code>. - Security headers are attached consistently by middleware (<code>Permissions-Policy</code>, <code>Referrer-Policy</code>, <code>X-Frame-Options</code>, plus CSP headers). - Caddy templates now support optional teacher/admin edge armor:   - IP allowlist for <code>/admin*</code> and <code>/teach*</code> via <code>CADDY_STAFF_IP_ALLOWLIST_V4</code>/<code>CADDY_STAFF_IP_ALLOWLIST_V6</code>   - optional extra basic-auth gate for <code>/admin*</code> via <code>CADDY_ADMIN_BASIC_AUTH_*</code> - Added a single operator-controlled degradation switch: <code>CLASSHUB_SITE_MODE</code> with modes:   - <code>normal</code>   - <code>read-only</code>   - <code>join-only</code>   - <code>maintenance</code> - Helper chat now respects degraded site modes (<code>join-only</code>, <code>maintenance</code>) and returns explicit machine-readable <code>site_mode_restricted</code> responses.</p> <p>Why this remains active: - Moves CSP from passive observation toward active browser-enforced protection. - Lowers clickjacking/browser-capability exposure with stable default headers. - Adds defense-in-depth for public <code>/admin</code> discovery pressure. - Gives operators a predictable, low-chaos incident posture without code edits.</p>"},{"location":"DECISIONS/#privacy-control-surface-pass-consent-microcopy-self-service-deletion","title":"Privacy control-surface pass (consent microcopy + self-service deletion)","text":"<p>Current decision: - Add plain-language privacy microcopy directly on join, upload, and helper UI surfaces:   - what is stored,   - where it is stored,   - retention framing,   - where to delete now. - Add student self-service control surface at <code>/student/my-data</code> with:   - view submissions,   - portfolio export,   - delete submissions now,   - end session on this device. - Add teacher per-student data deletion control from class roster, with explicit confirmation and session invalidation. - Add explicit helper backend visibility in UI (<code>Local model (Ollama)</code> vs <code>Remote model (OpenAI)</code> badge). - Make remote helper mode (<code>openai</code>) require explicit operator acknowledgment (<code>HELPER_REMOTE_MODE_ACKNOWLEDGED=1</code>) before chat is allowed. - Add project-level PRIVACY-ADDENDUM.md as field-level source of truth for lifecycle and deletion paths.</p> <p>Why this remains active: - Makes the privacy bargain visible in-product, not only in repository docs. - Keeps deletion a control surface instead of an operator ticket. - Prevents accidental/silent enablement of remote helper mode. - Gives operators and reviewers a concrete, auditable privacy checklist.</p>"},{"location":"DECISIONS/#helper-timeout-budget-guardrail-prevent-helperchat-worker-timeouts","title":"Helper timeout budget guardrail (prevent <code>/helper/chat</code> worker timeouts)","text":"<p>Current decision: - Make helper Gunicorn runtime timeout configurable:   - <code>HELPER_GUNICORN_TIMEOUT_SECONDS</code> (default <code>180</code>)   - <code>HELPER_GUNICORN_WORKERS</code> (default <code>2</code>) - Add deploy-time env validation math in <code>scripts/validate_env_secrets.sh</code> for Ollama mode:   - compute worst-case helper request budget as:     - <code>HELPER_QUEUE_MAX_WAIT_SECONDS</code>     - <code>+ HELPER_BACKEND_MAX_ATTEMPTS * OLLAMA_TIMEOUT_SECONDS</code>     - <code>+ exponential HELPER_BACKOFF_SECONDS</code>     - <code>+ safety margin</code>   - fail fast when <code>HELPER_GUNICORN_TIMEOUT_SECONDS</code> is below this budget.</p> <p>Why this remains active: - Prevents intermittent <code>/helper/chat</code> 500s caused by Gunicorn worker timeout while waiting on backend model responses. - Converts a runtime failure into an early deploy-time config check.</p>"},{"location":"DEVELOPMENT/","title":"Development","text":"<p>This repo is optimized for fast local iteration with Docker Compose. By default, Docker Compose will load <code>compose/docker-compose.override.yml</code> if it exists, which enables hot reload for Django code and templates.</p> <p>Docs are first-class in this repo. If you change behavior, update docs in the same branch. Start with:</p> <pre><code>flowchart LR\n  A[Edit code/content] --&gt; B[docker compose up -d]\n  B --&gt; C[Autoreload / runserver]\n  C --&gt; D[Quick checks]\n  D --&gt; E[system_doctor --smoke-mode golden]\n  E --&gt; F[Update docs + decisions]\n  F --&gt; G[Open PR]</code></pre> <ul> <li>index.md (documentation contract)</li> <li>START_HERE.md (navigation map)</li> <li>TEACHING_PLAYBOOK.md (teaching-quality writing standards)</li> <li>MERGE_READINESS.md (merge gate expectations)</li> </ul>"},{"location":"DEVELOPMENT/#extension-map-where-to-change-what","title":"Extension map (where to change what)","text":"<p>Use this map to pick the right seam before you start coding.</p>"},{"location":"DEVELOPMENT/#what-to-do-now","title":"What to do now","text":"<ol> <li>Pick the lane below that matches your change.</li> <li>Edit only the primary files first, then run the lane tests.</li> <li>Update the linked docs page in the same branch.</li> </ol>"},{"location":"DEVELOPMENT/#verification-signal","title":"Verification signal","text":"<p>You can point to one lane, one focused test command, and one docs update for your PR.</p> Change type Primary edit locations Tests to run first Docs to update Student join/session behavior <code>services/classhub/hub/views/student.py</code>, <code>services/classhub/hub/middleware.py</code>, <code>services/classhub/hub/models.py</code> <code>python manage.py test hub.tests.JoinClassTests hub.tests_services.StudentSessionMiddlewareTests hub.tests.StudentDataControlsTests</code> <code>docs/CLASS_CODE_AUTH.md</code>, <code>docs/PRIVACY-ADDENDUM.md</code>, <code>docs/DECISIONS.md</code> Teacher flows, OTP, roster, teaching UI <code>services/classhub/hub/views/teacher.py</code>, <code>services/classhub/config/middleware.py</code>, <code>services/classhub/hub/forms.py</code> <code>python manage.py test hub.tests.TeacherPortalTests hub.tests.Teacher2FASetupTests</code> <code>docs/TEACHER_PORTAL.md</code>, <code>docs/SECURITY.md</code>, <code>docs/DECISIONS.md</code> Upload validation, scanning, and downloads <code>services/classhub/hub/services/upload_policy.py</code>, <code>services/classhub/hub/services/upload_validation.py</code>, <code>services/classhub/hub/services/upload_scan.py</code>, <code>services/classhub/hub/views/media.py</code> <code>python manage.py test hub.tests_services.UploadValidationServiceTests hub.tests_services.UploadScanServiceTests hub.tests.SubmissionDownloadHardeningTests</code> <code>docs/SECURITY.md</code>, <code>docs/PRIVACY-ADDENDUM.md</code>, <code>docs/RUNBOOK.md</code> Markdown/content rendering and embed behavior <code>services/classhub/hub/services/markdown_content.py</code>, <code>services/classhub/hub/services/content_links.py</code>, <code>services/classhub/hub/views/content.py</code>, templates under <code>services/classhub/templates/</code> <code>python manage.py test hub.tests_services.MarkdownContentServiceTests hub.tests_services.ContentLinksServiceTests</code> <code>docs/COURSE_AUTHORING.md</code>, <code>docs/DEVELOPMENT.md</code>, <code>docs/DECISIONS.md</code> Helper policy, response behavior, backend routing <code>services/homework_helper/tutor/policy.py</code>, <code>services/homework_helper/tutor/views.py</code>, <code>services/homework_helper/tutor/fixtures/policy_prompts.md</code> <code>python manage.py test tutor.tests.HelperChatAuthTests</code> <code>docs/HELPER_POLICY.md</code>, <code>docs/OPENAI_HELPER.md</code>, <code>docs/DECISIONS.md</code> Shared rate limiting / request safety / IP behavior <code>services/common/request_safety/__init__.py</code>, <code>services/common/helper_scope.py</code>, integration points in classhub/helper views <code>python manage.py test hub.tests_services.RequestSafetyRateLimitResilienceTests tutor.tests.HelperChatAuthTests</code> <code>docs/REQUEST_SAFETY.md</code>, <code>docs/SECURITY_BASELINE.md</code>, <code>docs/DECISIONS.md</code> New model fields or retention behavior <code>services/classhub/hub/models.py</code>, migrations in <code>services/classhub/hub/migrations/</code>, retention commands in <code>services/classhub/hub/management/commands/</code> <code>python manage.py test hub.tests.StudentEventRetentionCommandTests hub.tests.SubmissionRetentionCommandTests hub.tests.StudentDataControlsTests</code> <code>docs/PRIVACY-ADDENDUM.md</code>, <code>docs/RUNBOOK.md</code>, <code>docs/DISASTER_RECOVERY.md</code> Security headers / cache policy / browser hardening <code>services/classhub/config/settings.py</code>, <code>services/classhub/config/middleware.py</code>, <code>services/homework_helper/config/settings.py</code>, <code>services/homework_helper/config/middleware.py</code>, <code>services/classhub/hub/http/headers.py</code> <code>python manage.py test hub.tests_security_headers.SecurityHeaderDriftTests hub.tests.ClassHubSecurityHeaderTests tutor.tests.HelperSecurityHeaderTests</code> <code>docs/SECURITY.md</code>, <code>docs/SECURITY_BASELINE.md</code>, <code>docs/DECISIONS.md</code> Internal helper event ingest contract <code>services/classhub/hub/views/internal.py</code>, <code>services/homework_helper/tutor/views.py</code> (<code>helper-chat</code> forwarder) <code>python manage.py test hub.tests.InternalHelperEventEndpointTests tutor.tests.ClassHubEventForwardingTests</code> <code>docs/OPENAI_HELPER.md</code>, <code>docs/HELPER_EVALS.md</code>, <code>docs/DECISIONS.md</code> <p>Notes: - Avoid adding new behavior to <code>services/classhub/hub/views/_legacy.py</code>; keep new work in <code>student.py</code>, <code>teacher.py</code>, <code>content.py</code>, <code>media.py</code>, or <code>internal.py</code>. - If you change data models, include migrations in the same PR and run <code>bash scripts/migration_gate.sh</code> before push. - After lane tests pass, run <code>bash scripts/system_doctor.sh --smoke-mode golden</code> before opening a PR.</p>"},{"location":"DEVELOPMENT/#hot-reload-local-dev","title":"Hot reload (local dev)","text":"<p>The override file:</p> <ul> <li>bind-mounts the source into the containers</li> <li>runs Django's dev server (<code>runserver</code>)</li> <li>sets <code>DJANGO_DEBUG=1</code></li> </ul> <p>Start the stack:</p> <pre><code>cd compose\ndocker compose up -d\n</code></pre> <p>Then edit files under:</p> <ul> <li><code>services/common/</code> (shared request safety helpers)</li> <li><code>services/classhub/</code> (Class Hub Django app)</li> <li><code>services/homework_helper/</code> (Homework Helper Django app)</li> <li><code>services/classhub/content/</code> (markdown course packs)</li> </ul> <p>Django's autoreloader will pick up Python + template changes, and the lesson pages read markdown files from disk on each request.</p>"},{"location":"DEVELOPMENT/#local-llm-ollama","title":"Local LLM (Ollama)","text":"<p>By default, the helper uses Ollama. Make sure the model server is running:</p> <pre><code>cd compose\ndocker compose exec ollama ollama pull llama3.2:1b\n</code></pre> <p>If you run Ollama outside of Compose, set <code>OLLAMA_BASE_URL</code> in <code>compose/.env</code> so the container can reach it.</p>"},{"location":"DEVELOPMENT/#lesson-front-matter-hygiene","title":"Lesson front matter hygiene","text":"<p>Lesson front matter values containing colons must be quoted (e.g., <code>title: \"Save privately: Download...\"</code>). Run <code>scripts/quote_lesson_frontmatter.py</code> after editing any lesson file to auto-quote those values.</p> <p><code>hub.views</code> now validates front matter before parsing, so you get a clear <code>500</code> and the offending line if you forget to quote something.</p>"},{"location":"DEVELOPMENT/#content-only-updates","title":"Content-only updates","text":"<p>If you only want curriculum hot reload (not Python code), you can mount just the content directory instead of the full app:</p> <pre><code>services:\n  classhub_web:\n    volumes:\n      - ../services/classhub/content:/app/content\n      - ../data/classhub_uploads:/uploads\n</code></pre>"},{"location":"DEVELOPMENT/#rebuild-course-pack-in-db","title":"Rebuild course pack in DB","text":"<p>When lesson markdown or <code>course.yaml</code> changes, re-import the course pack to refresh Modules + Materials for a class:</p> <pre><code>CLASS_CODE=BZ2CYTTE scripts/rebuild_coursepack.sh\n</code></pre> <p>You can also pass flags directly:</p> <pre><code>scripts/rebuild_coursepack.sh --course-slug piper_scratch_12_session --class-code BZ2CYTTE\n</code></pre> <p>To create a brand-new class from the course title:</p> <pre><code>scripts/rebuild_coursepack.sh --course-slug piper_scratch_12_session --create-class\n</code></pre>"},{"location":"DEVELOPMENT/#when-rebuilds-are-required","title":"When rebuilds are required","text":"<p>You still need an image rebuild when you change:</p> <ul> <li><code>requirements.txt</code> (Python dependencies)</li> <li>Dockerfiles or OS-level packages</li> <li>production-only assets that rely on <code>collectstatic</code></li> </ul> <p>For production-style builds:</p> <pre><code>cd compose\ndocker compose up -d --build\n</code></pre> <p>The production container entrypoint already runs:</p>"},{"location":"DEVELOPMENT/#repo-hygiene-check","title":"Repo hygiene check","text":"<p>Quick guardrail before pushing:</p> <pre><code>bash scripts/repo_hygiene_check.sh\n</code></pre> <p>This fails if blocked runtime/local artifacts are tracked (for example <code>.venv/</code>, <code>__pycache__/</code>, <code>.env</code>, <code>*.sqlite3</code>, <code>media/</code>, <code>staticfiles/</code>).</p>"},{"location":"DEVELOPMENT/#lint-and-editor-baseline","title":"Lint and editor baseline","text":"<p>Run Ruff from repo root:</p> <pre><code>ruff check services scripts\n</code></pre> <p>Run Bandit with the same config/scope as CI:</p> <pre><code>pip install bandit==1.8.3\nbash scripts/run_bandit.sh\n</code></pre> <p>Optional modes: - <code>bash scripts/run_bandit.sh report /tmp/bandit-report.json</code> - <code>bash scripts/run_bandit.sh gate</code></p> <p>Repo formatting defaults are defined in: - <code>pyproject.toml</code> (Ruff baseline) - <code>.editorconfig</code> (line endings/indent/newline defaults)</p> <ul> <li><code>python manage.py migrate</code></li> <li><code>python manage.py collectstatic --noinput</code></li> <li>Gunicorn server</li> </ul>"},{"location":"DEVELOPMENT/#debug-vs-production-behavior","title":"Debug vs production behavior","text":"<p>With <code>DJANGO_DEBUG=1</code>:</p> <ul> <li>Django serves static assets directly (no <code>collectstatic</code> required)</li> <li>stack traces are shown in the browser</li> <li>do not use this in production</li> </ul> <p>In production, remove the override file or set <code>DJANGO_DEBUG=0</code> and rebuild the image.</p> <p>For production deploys, prefer:</p> <pre><code>bash scripts/deploy_with_smoke.sh\n</code></pre> <p>That path intentionally uses only <code>compose/docker-compose.yml</code> and adds smoke checks. If you are using a dedicated asset host, set <code>CADDYFILE_TEMPLATE=Caddyfile.domain.assets</code> and configure <code>ASSET_DOMAIN</code> + <code>CLASSHUB_ASSET_BASE_URL</code> in <code>compose/.env</code>.</p> <p>For one-command local confidence before pushing:</p> <pre><code>bash scripts/system_doctor.sh --smoke-mode golden\n</code></pre>"},{"location":"DISASTER_RECOVERY/","title":"Disaster Recovery (Start from Zero)","text":"<p>This is a quick checklist to rebuild the server from scratch after a total loss.</p> <pre><code>flowchart TD\n  A[Provision fresh server] --&gt; B[Clone repo]\n  B --&gt; C[Restore compose/.env secrets]\n  C --&gt; D[Restore Postgres/uploads/MinIO backups]\n  D --&gt; E[docker compose up -d --build]\n  E --&gt; F[migrate + smoke checks]\n  F --&gt; G[Verify /teach and student join]</code></pre>"},{"location":"DISASTER_RECOVERY/#1-provision-a-fresh-server","title":"1) Provision a fresh server","text":"<ul> <li>Ubuntu 24.04+ recommended.</li> <li>Install Docker + Docker Compose plugin.</li> </ul>"},{"location":"DISASTER_RECOVERY/#2-clone-the-repo","title":"2) Clone the repo","text":"<pre><code>cd /srv\ngit clone git@github.com:bseverns/selfhosted-classhub.git lms\ncd /srv/lms\n</code></pre>"},{"location":"DISASTER_RECOVERY/#3-set-environment-variables","title":"3) Set environment variables","text":"<p>Copy the example and fill in secrets:</p> <pre><code>cp compose/.env.example compose/.env\n</code></pre> <p>Important settings to restore (from your password manager/backups):</p> <p>Core: - <code>DOMAIN</code> (if using TLS / Caddy domain config) - <code>POSTGRES_DB</code>, <code>POSTGRES_USER</code>, <code>POSTGRES_PASSWORD</code> - <code>MINIO_ROOT_USER</code>, <code>MINIO_ROOT_PASSWORD</code> - <code>DJANGO_SECRET_KEY</code> - <code>DJANGO_ADMIN_2FA_REQUIRED</code> - <code>DJANGO_ALLOWED_HOSTS</code> (include server IP or domain) - <code>CSRF_TRUSTED_ORIGINS</code></p> <p>Helper: - <code>HELPER_LLM_BACKEND</code> (<code>ollama</code> or <code>openai</code>; <code>mock</code> is CI/test-only) - <code>HELPER_STRICTNESS</code>, <code>HELPER_SCOPE_MODE</code> - <code>HELPER_REFERENCE_DIR</code>, <code>HELPER_REFERENCE_FILE</code> - <code>HELPER_REFERENCE_MAP</code> (optional) - <code>HELPER_TOPIC_FILTER_MODE</code> - <code>HELPER_TEXT_LANGUAGE_KEYWORDS</code> - <code>HELPER_MAX_CONCURRENCY</code> - <code>HELPER_QUEUE_MAX_WAIT_SECONDS</code> - <code>HELPER_QUEUE_POLL_SECONDS</code> - <code>HELPER_QUEUE_SLOT_TTL_SECONDS</code></p> <p>Ollama: - <code>OLLAMA_BASE_URL</code> - <code>OLLAMA_MODEL</code> - <code>OLLAMA_TIMEOUT_SECONDS</code> - <code>OLLAMA_TEMPERATURE</code> - <code>OLLAMA_TOP_P</code></p> <p>OpenAI (optional): - <code>OPENAI_API_KEY</code> - <code>OPENAI_MODEL</code></p>"},{"location":"DISASTER_RECOVERY/#4-pick-the-right-caddyfile","title":"4) Pick the right Caddyfile","text":"<ul> <li>No domain yet: use <code>compose/Caddyfile.local</code> and HTTP.</li> <li>Domain available: use <code>compose/Caddyfile.domain</code> and TLS.</li> <li>Domain + dedicated asset host: use <code>compose/Caddyfile.domain.assets</code>.</li> </ul> <p>Copy to <code>compose/Caddyfile</code>:</p> <pre><code>cd compose\ncp Caddyfile.local Caddyfile\n</code></pre>"},{"location":"DISASTER_RECOVERY/#5-restore-data-if-you-have-backups","title":"5) Restore data (if you have backups)","text":"<p>If you have backups from: - <code>scripts/backup_postgres.sh</code> - <code>scripts/backup_minio.sh</code> - <code>scripts/backup_uploads.sh</code></p> <p>Restore Postgres + uploads + MinIO before bringing up the stack.</p>"},{"location":"DISASTER_RECOVERY/#6-start-services","title":"6) Start services","text":"<pre><code>cd /srv/lms/compose\ndocker compose up -d --build\n</code></pre>"},{"location":"DISASTER_RECOVERY/#7-pull-the-ollama-model-if-using-local-llm","title":"7) Pull the Ollama model (if using local LLM)","text":"<pre><code>cd /srv/lms/compose\ndocker compose exec ollama ollama pull llama3.2:1b\n</code></pre>"},{"location":"DISASTER_RECOVERY/#8-quick-smoke-tests","title":"8) Quick smoke tests","text":"<pre><code>curl http://localhost/healthz\ncurl http://localhost/helper/healthz\ncurl -i -X POST http://localhost/helper/chat \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"message\":\"What is 7 plus 5?\"}'\n</code></pre>"},{"location":"DISASTER_RECOVERY/#9-restore-teacheradmin-access","title":"9) Restore teacher/admin access","text":"<p>Create first admin:</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py createsuperuser\n</code></pre> <p>Provision admin OTP device:</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py bootstrap_admin_otp --username &lt;admin_username&gt; --with-static-backup\n</code></pre> <p>Create a staff teacher account:</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher1 \\\n  --email teacher1@example.org \\\n  --password CHANGE_ME\n</code></pre> <p>Verify: - <code>https://&lt;domain&gt;/teach</code> - <code>https://&lt;domain&gt;/teach/lessons</code></p>"},{"location":"HELPER_EVALS/","title":"Helper evals","text":"<p>We keep a small, human-reviewable eval set to track quality across grade bands and strictness modes.</p>"},{"location":"HELPER_EVALS/#prompt-set","title":"Prompt set","text":"<p>Default prompts:</p> <ul> <li><code>services/homework_helper/tutor/fixtures/eval_prompts.jsonl</code></li> </ul> <p>Each line is JSON with fields:</p> <ul> <li><code>id</code></li> <li><code>grade_band</code></li> <li><code>topic</code></li> <li><code>prompt</code></li> <li><code>expected_behavior</code></li> </ul>"},{"location":"HELPER_EVALS/#run-the-eval-script","title":"Run the eval script","text":"<pre><code>python scripts/eval_helper.py \\\n  --url http://localhost/helper/chat \\\n  --out /tmp/helper_eval_results.jsonl\n</code></pre> <p>Notes: - The script sleeps between requests by default to avoid rate limits. - Use <code>--limit</code> for quick smoke checks.</p>"},{"location":"HELPER_EVALS/#review-workflow","title":"Review workflow","text":"<p>1) Run once with <code>HELPER_STRICTNESS=light</code>. 2) Flip to <code>HELPER_STRICTNESS=strict</code> and run again. 3) Compare responses for policy adherence and grade-appropriateness.</p>"},{"location":"HELPER_POLICY/","title":"Helper policy","text":"<p>This doc describes the tutoring stance and the strictness switch. The canonical prompt behavior is captured in:</p> <ul> <li><code>services/homework_helper/tutor/fixtures/policy_prompts.md</code></li> </ul>"},{"location":"HELPER_POLICY/#strictness-switch","title":"Strictness switch","text":"<p>Set in <code>compose/.env</code>:</p> <pre><code>HELPER_STRICTNESS=light\n# or\nHELPER_STRICTNESS=strict\n</code></pre>"},{"location":"HELPER_POLICY/#light-default","title":"Light (default)","text":"<ul> <li>May provide direct answers when appropriate.</li> <li>Always explain reasoning and include a check-for-understanding question.</li> <li>Refuse clear cheating requests.</li> </ul>"},{"location":"HELPER_POLICY/#strict","title":"Strict","text":"<ul> <li>No final answers for graded work.</li> <li>Provide hints, steps, and clarifying questions instead.</li> </ul>"},{"location":"HELPER_POLICY/#notes-for-curriculum-teams","title":"Notes for curriculum teams","text":"<ul> <li>If a unit is assessment-heavy, flip to <code>strict</code>.</li> <li>For open-ended exploration, keep <code>light</code> but require reasoning in every answer.</li> </ul>"},{"location":"HELPER_POLICY/#ops-note","title":"Ops note","text":"<p>On CPU-only servers, use the helper queue settings in <code>compose/.env</code> to cap concurrency and avoid timeouts.</p> <p>Use rate limit envs to protect shared helper capacity:</p> <ul> <li><code>HELPER_RATE_LIMIT_PER_MINUTE</code></li> <li><code>HELPER_RATE_LIMIT_PER_IP_PER_MINUTE</code></li> </ul>"},{"location":"HELPER_POLICY/#scope-mode-lesson-focus","title":"Scope mode (lesson focus)","text":"<p>Set <code>HELPER_SCOPE_MODE</code> in <code>compose/.env</code>:</p> <ul> <li><code>soft</code>: lesson-first answers with gentle redirects</li> <li><code>strict</code>: refuse off-topic requests and ask the student to rephrase</li> </ul>"},{"location":"LEARNING_PATHS/","title":"Learning Paths","text":"<p>This repository is intentionally both a production tool and a teaching object. Use these paths to learn progressively with concrete checkpoints.</p> <p>How to use this page: - Pick one path and complete it end-to-end before jumping ahead. - Capture notes as \"what surprised me\" and \"what would fail silently.\" - Treat each lab as a production rehearsal, not a reading exercise.</p>"},{"location":"LEARNING_PATHS/#path-1-operator-fundamentals","title":"Path 1: Operator Fundamentals","text":"<p>Goal: - bring the system up safely - validate health and routing - recover from common outages</p> <p>Time budget: - 60 to 90 minutes</p> <p>Read in order: 1. START_HERE.md 2. DAY1_DEPLOY_CHECKLIST.md 3. RUNBOOK.md 4. TROUBLESHOOTING.md 5. SECURITY.md</p> <p>Hands-on lab:</p> <ol> <li>Start services: <pre><code>cd /srv/lms/app/compose\ndocker compose up -d --build\n</code></pre></li> <li>Verify health endpoints: <pre><code>curl -I http://localhost/healthz\ncurl -I http://localhost/helper/healthz\n</code></pre></li> <li>Verify caddy mount source: <pre><code>docker inspect classhub_caddy --format '{{range .Mounts}}{{println .Source \"-&gt;\" .Destination}}{{end}}'\n</code></pre></li> <li>Run safety guards: <pre><code>cd /srv/lms/app\nbash scripts/validate_env_secrets.sh\npython3 scripts/check_compose_port_exposure.py\n</code></pre></li> </ol> <p>Expected outcomes: - both health checks return <code>200</code> - caddy mount points to intended Caddyfile template - env and port guard scripts return success</p> <p>Deliverable: - a short run log containing command timestamps and outcomes.</p> <p>Debrief prompts: - Which check would have caught a bad domain config first? - Which output is the strongest signal that routing is correct?</p>"},{"location":"LEARNING_PATHS/#path-2-application-architecture","title":"Path 2: Application Architecture","text":"<p>Goal: - understand service boundaries - understand where identity/session/routing decisions live</p> <p>Time budget: - 75 to 120 minutes</p> <p>Read in order: 1. WHAT_WHERE_WHY.md 2. ARCHITECTURE.md 3. CLASS_CODE_AUTH.md 4. REQUEST_SAFETY.md 5. DECISIONS.md</p> <p>Hands-on lab:</p> <ol> <li>Trace helper request path:</li> <li>browser request to <code>/helper/chat</code></li> <li>caddy route to <code>helper_web</code></li> <li>helper auth + scope checks</li> <li>backend call and response envelope</li> <li>Trace student request path:</li> <li>join with class code</li> <li>session creation</li> <li>class material view</li> </ol> <p>Suggested verification commands: <pre><code>cd /srv/lms/app/compose\ndocker compose logs --tail=120 caddy\ndocker compose logs --tail=120 helper_web\ndocker compose logs --tail=120 classhub_web\n</code></pre></p> <p>Deliverable: - one diagram (whiteboard or markdown) that shows request flow for:   - <code>/student</code>   - <code>/helper/chat</code></p> <p>Debrief prompts: - What dependency does helper have on classhub data at request time? - Where can auth/session assumptions leak across service boundaries?</p>"},{"location":"LEARNING_PATHS/#path-3-helper-safety-and-scope-controls","title":"Path 3: Helper Safety and Scope Controls","text":"<p>Goal: - understand scope-token model - understand anti-cheating and topic filters - understand fail-open vs fail-closed knobs</p> <p>Time budget: - 60 to 90 minutes</p> <p>Read in order: 1. HELPER_POLICY.md 2. OPENAI_HELPER.md 3. REQUEST_SAFETY.md 4. SECURITY.md 5. HELPER_EVALS.md</p> <p>Key invariants to internalize: - students require signed scope tokens - unsigned scope fields are ignored - staff can be forced to require tokens (<code>HELPER_REQUIRE_SCOPE_TOKEN_FOR_STAFF=1</code>) - classhub table requirement is configurable (<code>HELPER_REQUIRE_CLASSHUB_TABLE</code>)</p> <p>Hands-on lab:</p> <ol> <li>Run helper auth tests: <pre><code>cd /srv/lms/app/compose\ndocker compose exec -T helper_web python manage.py test tutor.tests.HelperChatAuthTests\n</code></pre></li> <li>Run full helper suite: <pre><code>docker compose exec -T helper_web python manage.py test tutor.tests\n</code></pre></li> <li>Trigger strict policy behavior manually:</li> <li>ask out-of-scope question from student view</li> <li>confirm policy redirect language appears</li> </ol> <p>Expected outcomes: - helper auth suite passes. - strict mode produces policy guidance instead of unrestricted model output. - logs include structured auth/policy events with <code>request_id</code>.</p> <p>Deliverable: - a one-page \"trust boundaries\" note:   - trusted inputs   - untrusted inputs   - fallback behavior when classhub tables are unavailable</p> <p>Debrief prompts: - What attack is prevented by ignoring unsigned scope fields? - What user-facing tradeoff exists between strict and soft topic filtering?</p>"},{"location":"LEARNING_PATHS/#path-4-teacher-workflow-and-content-operations","title":"Path 4: Teacher Workflow and Content Operations","text":"<p>Goal: - manage classes and teacher onboarding safely - understand authoring and rebuild flows</p> <p>Time budget: - 60 to 100 minutes</p> <p>Read in order: 1. TEACHER_PORTAL.md 2. COURSE_AUTHORING.md 3. TEACHER_HANDOFF_CHECKLIST.md 4. TEACHER_HANDOFF_RECORD_TEMPLATE.md</p> <p>Hands-on lab:</p> <ol> <li>Create/update course pack: <pre><code>cd /srv/lms/app\nscripts/rebuild_coursepack.sh --course-slug piper_scratch_12_session --create-class\n</code></pre></li> <li>Verify teacher portal routes and actions:</li> <li><code>/teach</code></li> <li><code>/teach/lessons</code></li> <li><code>/teach/videos</code></li> <li>Validate invite and 2FA setup flow in staging before production use.</li> </ol> <p>Expected outcomes: - course content imports without parser errors. - teacher routes render and allow expected actions. - invite and OTP setup are reproducible on a clean teacher account.</p> <p>Deliverable: - a staging checklist run with pass/fail for:   - content rebuild   - teacher login   - invite setup   - OTP verification</p> <p>Debrief prompts: - Which teacher task is most likely to fail after content schema changes? - Which checks should be required before onboarding new staff?</p>"},{"location":"LEARNING_PATHS/#path-5-secure-change-delivery","title":"Path 5: Secure Change Delivery","text":"<p>Goal: - practice shipping changes with guardrails - connect local checks to CI checks</p> <p>Time budget: - 45 to 75 minutes</p> <p>Read in order: 1. DEVELOPMENT.md 2. MERGE_READINESS.md 3. SECURITY.md 4. DECISIONS.md</p> <p>Hands-on lab:</p> <ol> <li>Run lint/test/security checks locally (where available): <pre><code>cd /srv/lms/app\nbash scripts/migration_gate.sh\npython3 scripts/check_compose_port_exposure.py\n</code></pre></li> <li>Run deployment smoke checks: <pre><code>bash scripts/smoke_check.sh --strict\n</code></pre></li> <li>Run guarded deployment script in staging: <pre><code>bash scripts/deploy_with_smoke.sh\n</code></pre></li> <li>Run full stack doctor: <pre><code>bash scripts/system_doctor.sh --smoke-mode golden\n</code></pre></li> </ol> <p>Expected outcomes: - migration gate and smoke checks pass with no manual patch-up. - deployment command exits successfully with healthy services. - reviewer can map local checks directly to CI safety intent.</p> <p>Deliverable: - a mock change report with:   - risk statement   - checks run   - rollback trigger conditions</p> <p>Debrief prompts: - Which check most reduces the probability of a production outage? - Which failures are acceptable to defer, and which are hard stop?</p>"},{"location":"LEARNING_PATHS/#teaching-notes-for-maintainers","title":"Teaching notes for maintainers","text":"<p>When adding features, include: - one architecture sentence (\"what boundary changed\") - one decision sentence (\"why we chose this\") - one operator check (\"how to verify post-deploy\") - one failure mode (\"what breaks first if misconfigured\")</p> <p>That pattern keeps this repo teachable without inflating every doc page.</p>"},{"location":"MERGE_READINESS/","title":"Branch Merge Readiness Checklist","text":"<p>Use this before you ask for review. This is the \"no surprises\" ritual.</p>"},{"location":"MERGE_READINESS/#1-scope-intent-check-2-minutes","title":"1) Scope + intent check (2 minutes)","text":"<ul> <li>Can you explain the change in one sentence without buzzword fog?</li> <li>Does the change map to one of our North Star outcomes (reliable / inspectable / privacy-forward / fast to ship)?</li> <li>Did you avoid side quests unrelated to the branch goal?</li> </ul> <p>If any answer is \"no\", tighten scope before review.</p>"},{"location":"MERGE_READINESS/#2-product-constraint-check-hard-gates","title":"2) Product constraint check (hard gates)","text":"<ul> <li>Student access is still class code + display name in MVP.</li> <li>Teacher/admin auth still uses Django auth.</li> <li>Homework Helper still routes under <code>/helper/*</code>.</li> <li>Hosted LLM integrations are aligned with Responses API direction.</li> </ul> <p>If you break a hard constraint, this is not \"just a follow-up\" \u2014 fix it now or document a formal decision.</p>"},{"location":"MERGE_READINESS/#3-local-verification-commands","title":"3) Local verification commands","text":"<p>From repo root:</p> <pre><code>DJANGO_DEBUG=1 DJANGO_SECRET_KEY=dev-secret python services/classhub/manage.py check\nDJANGO_DEBUG=1 DJANGO_SECRET_KEY=dev-secret python services/classhub/manage.py test\nDJANGO_DEBUG=1 DJANGO_SECRET_KEY=dev-secret python services/homework_helper/manage.py check\nDJANGO_DEBUG=1 DJANGO_SECRET_KEY=dev-secret python services/homework_helper/manage.py test\n</code></pre> <p>For stack-level confidence:</p> <pre><code>bash scripts/smoke_check.sh\n</code></pre> <p>For full-stack confidence (recommended):</p> <pre><code>bash scripts/system_doctor.sh --smoke-mode golden\n</code></pre> <p>If any command fails because of local environment constraints, note that explicitly in PR notes.</p>"},{"location":"MERGE_READINESS/#4-docs-decision-hygiene","title":"4) Docs + decision hygiene","text":"<ul> <li>Updated docs for behavior changes (not just code).</li> <li>Added or amended DECISIONS.md when making a design/policy tradeoff.</li> <li>Kept language operator-usable and teacher-readable.</li> </ul> <p>No docs update for behavior change = incomplete branch.</p>"},{"location":"MERGE_READINESS/#5-review-ergonomics-make-reviewer-life-easy","title":"5) Review ergonomics (make reviewer life easy)","text":"<ul> <li>PR title says what changed and why.</li> <li>PR body includes:</li> <li>problem statement</li> <li>change summary</li> <li>risk + rollback notes</li> <li>exact validation commands + outcomes</li> <li>link to CI coverage artifacts (<code>coverage-classhub.xml</code>, <code>coverage-helper.xml</code>) when test-suite runs</li> <li>Keep commit history coherent (squash fixup noise if needed).</li> </ul>"},{"location":"MERGE_READINESS/#6-dataprivacy-sanity-check","title":"6) Data/privacy sanity check","text":"<ul> <li>No accidental PII expansion.</li> <li>No secrets committed.</li> <li>Logging changes preserve inspectability without oversharing student data.</li> </ul>"},{"location":"MERGE_READINESS/#7-deployment-sanity-check","title":"7) Deployment sanity check","text":"<ul> <li>Migration impact is explained.</li> <li>Any ops step changes reflected in runbook/checklists.</li> <li>Changes are reversible (or rollback strategy is documented).</li> </ul> <p>If this feels strict, good. We\u2019re optimizing for calm operations, not adrenaline deployments.</p>"},{"location":"NON_DEVELOPER_GUIDE/","title":"Non-Developer Guide (Teachers and School Staff)","text":"<p>If you are not writing code, start here.</p> <p>You do not need to read every docs file. For normal classroom use, this page plus TEACHER_PORTAL.md is enough.</p> <pre><code>flowchart LR\n  A[Before class&lt;br/&gt;5-min check] --&gt; B[During class&lt;br/&gt;Teach + monitor]\n  B --&gt; C[End of class&lt;br/&gt;Closeout]\n  C --&gt; D[If issues&lt;br/&gt;Troubleshooting]\n  D --&gt; A</code></pre>"},{"location":"NON_DEVELOPER_GUIDE/#what-this-system-does","title":"What this system does","text":"<ul> <li>Students join with a class code and display name.</li> <li>Teachers run classes and review work in the Teacher Portal (<code>/teach</code>).</li> <li>The Homework Helper gives hints inside lessons.</li> </ul>"},{"location":"NON_DEVELOPER_GUIDE/#5-minute-startup-check-before-class","title":"5-minute startup check (before class)","text":"<ol> <li>Open the site homepage.</li> <li>Open <code>/teach</code> and confirm your teacher login works.</li> <li>Open your class and confirm students can join.</li> <li>Open one lesson and test the Helper once.</li> <li>Confirm submission inbox is visible for your upload lesson.</li> </ol> <p>If any step fails, use TROUBLESHOOTING.md.</p>"},{"location":"NON_DEVELOPER_GUIDE/#during-class-what-to-do","title":"During class: what to do","text":"<ol> <li>Open your class in <code>/teach</code>.</li> <li>In <code>Lesson Tracker</code>, open only the lesson you are teaching now.</li> <li>Adjust lesson release (open/lock/date) as needed.</li> <li>Use <code>Helper tuning</code> in that lesson row if you want to narrow helper focus.</li> <li>Review missing submissions from the dropbox links.</li> </ol> <p>Deep walkthrough: TEACHER_PORTAL.md</p>"},{"location":"NON_DEVELOPER_GUIDE/#end-of-class-quick-closeout","title":"End of class: quick closeout","text":"<ol> <li>Review missing submissions.</li> <li>Rename student entries if needed.</li> <li>Lock lessons or set next lesson date.</li> <li>Export/check submissions if this is an assessment day.</li> </ol>"},{"location":"NON_DEVELOPER_GUIDE/#common-problems-plain-language","title":"Common problems (plain language)","text":"<ul> <li>\"Students cannot join\":   check class code and whether class is locked.</li> <li>\"Helper is not responding\":   check <code>/helper/healthz</code> and follow TROUBLESHOOTING.md.</li> <li>\"Teacher page looks empty\":   sections are collapsed by default; open <code>Lesson Tracker</code> and <code>Roster</code>.</li> <li>\"Uploads are failing\":   check allowed file types and upload size in module material settings.</li> </ul>"},{"location":"NON_DEVELOPER_GUIDE/#read-only-what-you-need-next","title":"Read only what you need next","text":"<ul> <li>Teacher workflow and screen-by-screen guide: TEACHER_PORTAL.md</li> <li>Day-1 setup (operators/admins): DAY1_DEPLOY_CHECKLIST.md</li> <li>Incident recovery: TROUBLESHOOTING.md</li> <li>Security and privacy boundaries (policy level): SECURITY.md</li> </ul>"},{"location":"OPENAI_HELPER/","title":"Homework Helper (LLM backend)","text":"<p>The helper service is a Django app that exposes:</p> <ul> <li><code>GET /helper/healthz</code></li> <li><code>POST /helper/chat</code></li> </ul> <p>By default, the helper is wired to a local LLM server (Ollama) for self-hosted reliability and predictable costs. OpenAI remains an explicit development/future path via the Responses API and must be intentionally acknowledged before use.</p> <pre><code>flowchart TD\n  A[POST /helper/chat] --&gt; B[Auth + scope token checks]\n  B --&gt; C[Rate limit + queue slot]\n  C --&gt; D{Backend}\n  D --&gt;|ollama| E[Local Ollama API]\n  D --&gt;|openai| F[OpenAI Responses API]\n  D --&gt;|mock| G[Deterministic test response]\n  E --&gt; H[Policy-shaped answer]\n  F --&gt; H\n  G --&gt; H\n  H --&gt; I[JSON response + request_id]</code></pre>"},{"location":"OPENAI_HELPER/#backend-selection","title":"Backend selection","text":"<p>Set the backend in <code>compose/.env</code>:</p> <pre><code>HELPER_LLM_BACKEND=ollama   # or \"openai\" or \"mock\" (CI/test only)\nHELPER_REMOTE_MODE_ACKNOWLEDGED=0\nHELPER_MOCK_RESPONSE_TEXT=\nHELPER_STRICTNESS=light     # or \"strict\"\nHELPER_SCOPE_MODE=strict    # or \"soft\"\nHELPER_REFERENCE_FILE=/app/tutor/reference/piper_scratch.md\nHELPER_REFERENCE_DIR=/app/tutor/reference\nHELPER_REFERENCE_MAP={\"piper_scratch\":\"piper_scratch.md\"}\nHELPER_SCOPE_TOKEN_MAX_AGE_SECONDS=7200\nHELPER_RESPONSE_MAX_CHARS=2200\nHELPER_MAX_CONCURRENCY=2\nHELPER_QUEUE_MAX_WAIT_SECONDS=10\nHELPER_QUEUE_POLL_SECONDS=0.2\nHELPER_QUEUE_SLOT_TTL_SECONDS=120\nHELPER_BACKEND_MAX_ATTEMPTS=2\nHELPER_BACKOFF_SECONDS=0.4\nHELPER_CIRCUIT_BREAKER_FAILURES=5\nHELPER_CIRCUIT_BREAKER_TTL_SECONDS=30\nHELPER_TOPIC_FILTER_MODE=strict\nHELPER_TEXT_LANGUAGE_KEYWORDS=pascal,python,java,javascript,typescript,c++,c#,csharp,ruby,php,go,golang,rust,swift,kotlin\n</code></pre>"},{"location":"OPENAI_HELPER/#ollama-local","title":"Ollama (local)","text":"<p>Required env:</p> <pre><code>OLLAMA_BASE_URL=http://ollama:11434\nOLLAMA_MODEL=llama3.2:1b\nOLLAMA_TIMEOUT_SECONDS=30\nOLLAMA_TEMPERATURE=0.2\nOLLAMA_TOP_P=0.9\nOLLAMA_NUM_PREDICT=400\n</code></pre> <p>Ollama is included in <code>compose/docker-compose.yml</code> and persists models at <code>data/ollama/</code>. Pull a model with:</p> <pre><code>cd compose\ndocker compose exec ollama ollama pull llama3.2:1b\n</code></pre> <p>On CPU-only servers with limited RAM, keep the model small (1B\u20132B range). Larger models may be too slow or may not fit in memory.</p> <p>If you run Ollama outside of Compose, set <code>OLLAMA_BASE_URL</code> to the host address that containers can reach.</p>"},{"location":"OPENAI_HELPER/#openai-optional-explicit-opt-in","title":"OpenAI (optional, explicit opt-in)","text":"<p>If you want to re-enable OpenAI later:</p> <pre><code>HELPER_LLM_BACKEND=openai\nHELPER_REMOTE_MODE_ACKNOWLEDGED=1\nOPENAI_API_KEY=...\nOPENAI_MODEL=gpt-5.2\nOPENAI_MAX_OUTPUT_TOKENS=400\n</code></pre> <p>Safety behavior: - If <code>HELPER_LLM_BACKEND=openai</code> and <code>HELPER_REMOTE_MODE_ACKNOWLEDGED!=1</code>, <code>/helper/chat</code> returns <code>remote_backend_not_acknowledged</code>. - This prevents remote mode from becoming a silent default.</p> <p><code>openai</code> is already included in <code>services/homework_helper/requirements.txt</code>.</p>"},{"location":"OPENAI_HELPER/#mock-backend-citest","title":"Mock backend (CI/test)","text":"<p>For deterministic CI smoke checks without external model dependencies:</p> <pre><code>HELPER_LLM_BACKEND=mock\nHELPER_MOCK_RESPONSE_TEXT=Optional fixed reply text\n</code></pre>"},{"location":"OPENAI_HELPER/#tutor-stance-and-strictness","title":"Tutor stance and strictness","text":"<p>We support two modes:</p> <ul> <li><code>HELPER_STRICTNESS=light</code> (default): may give direct answers, but must explain   reasoning and include a check-for-understanding question.</li> <li><code>HELPER_STRICTNESS=strict</code>: no final answers for graded work; respond with   hints, steps, and questions.</li> </ul> <p>The strictness switch is intentionally simple so teachers can \u201cthrow the switch\u201d without code changes.</p>"},{"location":"OPENAI_HELPER/#lesson-context-metadata","title":"Lesson context metadata","text":"<p>Lesson pages now sign contextual metadata and pass it to the helper as a scope token:</p> <ul> <li><code>data-helper-scope-token</code>: signed payload containing:</li> <li><code>context</code></li> <li><code>topics</code></li> <li><code>allowed_topics</code></li> <li><code>reference</code></li> </ul> <p>Homework Helper verifies this token server-side and uses only the signed scope for student requests. This prevents client-side request edits from widening lesson scope.</p>"},{"location":"OPENAI_HELPER/#allowed-topics-per-lesson","title":"Allowed topics (per lesson)","text":"<p>You can provide an explicit allowed-topics list in lesson front matter to keep students on the intended scope. Add either of these:</p> <pre><code>helper_allowed_topics:\n  - sprites\n  - motion blocks\n  - saving .sb3\n</code></pre> <p>The helper will gently redirect questions outside this list when <code>HELPER_TOPIC_FILTER_MODE=soft</code> (no blocking) and will redirect when set to <code>strict</code>.</p> <p>You can also auto-generate a starter list from lesson markdown:</p> <pre><code>python3 scripts/add_helper_allowed_topics.py \\\n  --lessons-dir services/classhub/content/courses/piper_scratch_12_session/lessons \\\n  --write\n</code></pre>"},{"location":"OPENAI_HELPER/#new-course-scaffold","title":"New course scaffold","text":"<p>To create a brand-new course folder + lesson stubs + a reference file:</p> <pre><code>python3 scripts/new_course_scaffold.py \\\n  --slug robotics_intro \\\n  --title \"Robotics: Sensors + Motion\" \\\n  --sessions 8 \\\n  --duration 75 \\\n  --age-band \"5th-7th\"\n</code></pre>"},{"location":"OPENAI_HELPER/#course-reference-facts","title":"Course reference facts","text":"<p>You can reinforce subject expertise by providing a reference file with concrete facts and workflows for the course. The helper will include this text in the system instructions:</p> <pre><code>HELPER_REFERENCE_FILE=/app/tutor/reference/piper_scratch.md\n</code></pre> <p>The example <code>piper_scratch.md</code> lives in the helper image and can be edited to match your curriculum.</p>"},{"location":"OPENAI_HELPER/#multiple-reference-files-per-course-or-lesson","title":"Multiple reference files (per course or lesson)","text":"<p>Use a reference key in <code>course.yaml</code> or <code>lesson</code> entries:</p> <pre><code>helper_reference: piper_scratch\n</code></pre> <p>Then configure a map in <code>.env</code> so the helper can resolve the key to a file:</p> <pre><code>HELPER_REFERENCE_DIR=/app/tutor/reference\nHELPER_REFERENCE_MAP={\"piper_scratch\":\"piper_scratch.md\"}\n</code></pre> <p>This keeps file access safe and lets you swap references per lesson or course.</p>"},{"location":"OPENAI_HELPER/#per-lesson-references-generated-from-content","title":"Per-lesson references generated from content","text":"<p>For lesson-specific expertise, generate one reference file per lesson slug. The helper will load <code>reference_dir/&lt;lesson_slug&gt;.md</code> when a lesson sets <code>helper_reference: &lt;lesson_slug&gt;</code> in <code>course.yaml</code>.</p> <p>Generate references from the course markdown:</p> <pre><code>python scripts/generate_lesson_references.py \\\n  --course services/classhub/content/courses/piper_scratch_12_session/course.yaml \\\n  --out services/homework_helper/tutor/reference\n</code></pre>"},{"location":"OPENAI_HELPER/#scope-mode","title":"Scope mode","text":"<p>Use <code>HELPER_SCOPE_MODE</code> to control how strictly the helper stays within the lesson:</p> <ul> <li><code>soft</code> (default): prefer lesson scope, gently redirect off-topic requests</li> <li><code>strict</code>: refuse unrelated questions and ask students to rephrase</li> </ul>"},{"location":"OPENAI_HELPER/#queue-concurrency-limits","title":"Queue / concurrency limits","text":"<p>On CPU-only servers, limit concurrent model calls to avoid overload. The helper uses a small Redis-backed slot queue:</p> <ul> <li><code>HELPER_MAX_CONCURRENCY</code>: maximum simultaneous LLM calls (default: 2)</li> <li><code>HELPER_QUEUE_MAX_WAIT_SECONDS</code>: how long to wait for a slot (default: 10)</li> <li><code>HELPER_QUEUE_POLL_SECONDS</code>: polling interval (default: 0.2)</li> <li><code>HELPER_QUEUE_SLOT_TTL_SECONDS</code>: auto-release safety timeout (default: 120)</li> </ul>"},{"location":"OPENAI_HELPER/#response-length-controls","title":"Response length controls","text":"<ul> <li><code>HELPER_RESPONSE_MAX_CHARS</code>: hard cap on returned assistant text length (default: <code>2200</code>, minimum enforced <code>200</code>)</li> <li><code>OPENAI_MAX_OUTPUT_TOKENS</code>: optional Responses API output-token cap (set <code>0</code> to disable)</li> <li><code>OLLAMA_NUM_PREDICT</code>: optional Ollama generation-token cap (set <code>0</code> to use model default)</li> </ul>"},{"location":"OPENAI_HELPER/#backend-resilience-telemetry","title":"Backend resilience + telemetry","text":"<p>The helper now retries transient backend failures before returning an error.</p> <ul> <li><code>HELPER_BACKEND_MAX_ATTEMPTS</code>: total backend attempts per request (default: 2)</li> <li><code>HELPER_BACKOFF_SECONDS</code>: base exponential backoff (default: 0.4)</li> <li><code>HELPER_CIRCUIT_BREAKER_FAILURES</code>: consecutive failures before temporary open-circuit (default: 5)</li> <li><code>HELPER_CIRCUIT_BREAKER_TTL_SECONDS</code>: open-circuit duration and failure-window TTL (default: 30)</li> </ul> <p><code>POST /helper/chat</code> responses now include: - <code>request_id</code> (also returned as <code>X-Request-ID</code> response header) - <code>attempts</code> - timing fields (<code>queue_wait_ms</code>, <code>total_ms</code>) on successful calls - <code>truncated</code> when response text was clipped by <code>HELPER_RESPONSE_MAX_CHARS</code></p> <p>Service logs now emit structured helper chat events (rate limits, queue busy, backend failures, successful calls) for easier operational tracing.</p>"},{"location":"OPENAI_HELPER/#access-boundary","title":"Access boundary","text":"<p><code>POST /helper/chat</code> now requires an authenticated classroom context:</p> <ul> <li>student session (<code>student_id</code> + <code>class_id</code> in Django session), or</li> <li>staff-authenticated teacher session.</li> </ul> <p>This prevents anonymous/public use of helper capacity. CSRF protection remains enabled.</p>"},{"location":"OPENAI_HELPER/#end-to-end-helper-flow-map-d3","title":"End-to-end helper flow (Map D3)","text":"<pre><code>sequenceDiagram\n  participant B as Browser\n  participant MW as Middleware\n  participant H as Helper chat endpoint\n  participant RS as request_safety\n  participant LLM as LLM backend (local preferred)\n  participant CH as ClassHub internal events\n\n  B-&gt;&gt;MW: POST /helper/chat (message, scope token)\n  MW-&gt;&gt;H: request\n  H-&gt;&gt;RS: rate limit + concurrency gate\n  H-&gt;&gt;LLM: bounded prompt (scope-enforced)\n  LLM--&gt;&gt;H: response\n  H--&gt;&gt;B: JSON response (request_id, no-store)\n  H-&gt;&gt;CH: best-effort POST /internal/events/helper-chat-access</code></pre> <p>Canonical policy notes live in:</p> <ul> <li><code>services/homework_helper/tutor/fixtures/policy_prompts.md</code></li> <li>HELPER_POLICY.md</li> </ul>"},{"location":"OPENAI_HELPER/#rag-planned","title":"RAG (planned)","text":"<p>Phase 2 will retrieve relevant snippets from class materials and include citations.</p>"},{"location":"OPENAI_HELPER/#evals-recommended","title":"Evals (recommended)","text":"<ul> <li><code>services/homework_helper/tutor/fixtures/eval_prompts.jsonl</code></li> <li>HELPER_EVALS.md</li> </ul>"},{"location":"PILOT_PLAYBOOK/","title":"Pilot Playbook (18-student run)","text":""},{"location":"PILOT_PLAYBOOK/#summary","title":"Summary","text":"<p>This page is the \u201chow we ran it\u201d guide for a small pilot (\u224818 students) of ClassHub.</p> <p>It exists to: - keep the operator calm - keep the teacher unblocked - keep student data minimal and deletable - generate a shareable story others can replicate</p> <p>If you are deploying for the first time, do DAY1_DEPLOY_CHECKLIST.md first. If you are teaching tomorrow, do NON_DEVELOPER_GUIDE.md + TEACHER_PORTAL.md.</p>"},{"location":"PILOT_PLAYBOOK/#what-to-do-now","title":"What to do now","text":"<ol> <li>Copy the \u201cPilot config profile\u201d section into <code>compose/.env</code> as deltas (do not overwrite secrets).</li> <li>Run a full dry run with <code>bash scripts/system_doctor.sh --smoke-mode strict</code>.</li> <li>Teach one \u201cempty-room rehearsal\u201d class: join \u2192 lesson \u2192 helper \u2192 upload \u2192 <code>/student/my-data</code> delete/end-session.</li> <li>Decide the retention window for this pilot and enable the retention timer after you are comfortable.</li> </ol>"},{"location":"PILOT_PLAYBOOK/#verification-signal","title":"Verification signal","text":"<p>On class day, you can answer \u201care we healthy?\u201d in under 60 seconds: - <code>/healthz</code> returns 200 - <code>/helper/healthz</code> returns 200 - smoke check passes: join + helper chat + teacher portal</p>"},{"location":"PILOT_PLAYBOOK/#pilot-framing-what-this-run-is-and-isnt","title":"Pilot framing: what this run is (and isn\u2019t)","text":""},{"location":"PILOT_PLAYBOOK/#goals","title":"Goals","text":"<ul> <li>Run a classroom loop with low friction:</li> <li>join by class code</li> <li>lesson delivery</li> <li>submissions</li> <li>optional helper hints</li> <li>Practice \u201ckid gloves + armor\u201d:</li> <li>explicit data controls (<code>/student/my-data</code>)</li> <li>no ad-tech posture</li> <li>safe downloads</li> <li>minimal event payloads</li> <li>Build a replicable playbook for other teachers/operators.</li> </ul>"},{"location":"PILOT_PLAYBOOK/#non-goals-for-this-pilot","title":"Non-goals (for this pilot)","text":"<ul> <li>No remote LLM backend.</li> <li>No large-scale roster/account systems for students.</li> <li>No complex analytics beyond operational safety logs.</li> <li>No \u201cperfect\u201d retention automation on day 1 (we phase it in).</li> </ul>"},{"location":"PILOT_PLAYBOOK/#pilot-config-profile-recommended-defaults","title":"Pilot config profile (recommended defaults)","text":"<p>These are deltas for <code>compose/.env</code>. Keep your secrets and host values intact.</p> <pre><code># Keep the site usable under classroom conditions.\nCLASSHUB_SITE_MODE=normal\n\n# Student privacy posture (pilot-safe defaults).\nCLASSHUB_PORTFOLIO_FILENAME_MODE=generic\nCLASSHUB_STUDENT_EVENT_IP_MODE=truncate\nCLASSHUB_STUDENT_EVENT_RETENTION_DAYS=180\nCLASSHUB_SUBMISSION_RETENTION_DAYS=90\n\n# Keep uploads within expected classroom reality.\nCLASSHUB_UPLOAD_MAX_MB=200\nCADDY_CLASSHUB_MAX_BODY=220MB\n\n# Helper stays local for this pilot.\nHELPER_LLM_BACKEND=ollama\nHELPER_REMOTE_MODE_ACKNOWLEDGED=0\nHELPER_STRICTNESS=light\nHELPER_SCOPE_MODE=strict\nHELPER_TOPIC_FILTER_MODE=strict\nHELPER_MAX_CONCURRENCY=2\n\n# Join rate limit (protect against accidental hammering / refresh storms).\nCLASSHUB_JOIN_RATE_LIMIT_PER_MINUTE=20\n\n# Retention maintenance script defaults (safe starting point).\nRETENTION_SUBMISSION_DAYS=90\nRETENTION_EVENT_DAYS=180\nRETENTION_SCAVENGE_MODE=report\n</code></pre>"},{"location":"PRIVACY-ADDENDUM/","title":"Privacy Addendum (ClassHub)","text":""},{"location":"PRIVACY-ADDENDUM/#summary","title":"Summary","text":"<p>This addendum lists exactly what ClassHub stores, where it lives, how long it is retained, and how to delete it now.</p>"},{"location":"PRIVACY-ADDENDUM/#what-to-do-now","title":"What to do now","text":"<ol> <li>Confirm your retention defaults in <code>compose/.env</code> (<code>CLASSHUB_SUBMISSION_RETENTION_DAYS</code>, <code>CLASSHUB_STUDENT_EVENT_RETENTION_DAYS</code>).</li> <li>Verify student self-service controls at <code>/student/my-data</code>.</li> <li>Verify teacher delete control at <code>/teach/class/&lt;id&gt;</code> (roster table).</li> <li>If enabling remote LLM mode later, set <code>HELPER_REMOTE_MODE_ACKNOWLEDGED=1</code> intentionally.</li> </ol>"},{"location":"PRIVACY-ADDENDUM/#verification-signal","title":"Verification signal","text":"<p>A student can open <code>/student/my-data</code> and perform download/delete/end-session without filing a ticket.</p>"},{"location":"PRIVACY-ADDENDUM/#student-data-lifecycle-and-controls-map-b","title":"Student data lifecycle and controls (Map B)","text":"<pre><code>flowchart LR\n  subgraph J[\"Student Journey\"]\n    J1[\"Join class (class code + display name)\"]\n    J2[\"View lesson content\"]\n    J3[\"Ask helper (optional)\"]\n    J4[\"Upload submission\"]\n    J5[\"My Data: show, download, delete, end session\"]\n  end\n\n  subgraph D[\"Data Stores\"]\n    D1[\"Postgres: students, classes, submissions metadata, student events\"]\n    D2[\"File storage: submissions and portfolio zips\"]\n    D3[\"Redis cache: rate limits, queue state, session helpers\"]\n  end\n\n  subgraph P[\"Policies and Protections\"]\n    P1[\"No-store caching on sensitive pages and exports\"]\n    P2[\"Safe downloads: attachment, nosniff, sandbox CSP\"]\n    P3[\"Event minimization: no names, codes, filenames\"]\n    P4[\"IP coarsening in truncate mode\"]\n    P5[\"Retention maintenance: report then delete\"]\n  end\n\n  J1 --&gt;|creates/updates| D1\n  J2 --&gt;|reads| D1\n  J3 --&gt;|rate-limit and session checks| D3\n  J3 -. optional .-&gt; H[\"Helper service\"]\n  H --&gt;|best-effort safe event| D1\n\n  J4 --&gt;|file bytes| D2\n  J4 --&gt;|metadata| D1\n\n  J5 --&gt;|list submissions| D1\n  J5 --&gt;|download zip| D2\n  J5 --&gt;|delete now| D1\n  J5 --&gt;|delete now| D2\n\n  P1 -.-&gt; J1\n  P1 -.-&gt; J5\n  P2 -.-&gt; J5\n  P3 -.-&gt; D1\n  P4 -.-&gt; D1\n  P5 -.-&gt; D1\n  P5 -.-&gt; D2</code></pre>"},{"location":"PRIVACY-ADDENDUM/#data-categories-exact-fields","title":"Data Categories (Exact Fields)","text":"<ul> <li>Student identity: <code>StudentIdentity.display_name</code>, <code>StudentIdentity.return_code</code>, <code>StudentIdentity.created_at</code>, <code>StudentIdentity.last_seen_at</code>, class link.</li> <li>Student submissions: <code>Submission.original_filename</code>, <code>Submission.file</code>, <code>Submission.note</code>, <code>Submission.uploaded_at</code>, material/student links.</li> <li>Student events (metadata-only): <code>StudentEvent.event_type</code>, <code>StudentEvent.source</code>, <code>StudentEvent.details</code>, minimized <code>StudentEvent.ip_address</code>, <code>StudentEvent.created_at</code>, optional classroom/student links.</li> <li>Teacher/admin accounts: Django auth user fields (<code>username</code>, <code>email</code>, password hash, staff/superuser flags, auth/session metadata).</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#storage-locations","title":"Storage Locations","text":"<ul> <li>Primary relational data: Postgres (<code>classhub_postgres</code>).</li> <li>Uploaded files: filesystem volume mounted at <code>/uploads</code> in <code>classhub_web</code>.</li> <li>Lesson assets/videos: upload storage under the same app storage backend.</li> <li>Operational logs: container logs (<code>classhub_web</code>, <code>helper_web</code>, <code>caddy</code>).</li> <li>Backups (if enabled): operator-defined backup locations for Postgres/uploads/MinIO.</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#retention-defaults-and-tuning","title":"Retention Defaults and Tuning","text":"<ul> <li>Submission retention default: <code>CLASSHUB_SUBMISSION_RETENTION_DAYS=90</code>.</li> <li><code>0</code> means no automatic age-based deletion.</li> <li>Student event retention default: <code>CLASSHUB_STUDENT_EVENT_RETENTION_DAYS=180</code>.</li> <li><code>0</code> means no automatic age-based deletion.</li> <li>Student event IP precision default: <code>CLASSHUB_STUDENT_EVENT_IP_MODE=truncate</code>.</li> <li><code>truncate</code>: IPv4 <code>/24</code>, IPv6 <code>/56</code> network address only.</li> <li><code>full</code>: store full client IP.</li> <li><code>none</code>: do not store IP on student events.</li> <li>Portfolio export download filename default: <code>CLASSHUB_PORTFOLIO_FILENAME_MODE=generic</code>.</li> <li><code>generic</code>: <code>portfolio_YYYYMMDD.zip</code>.</li> <li><code>descriptive</code>: <code>&lt;class&gt;_&lt;student&gt;_portfolio_YYYYMMDD.zip</code>.</li> <li>Retention maintenance entrypoint: <code>scripts/retention_maintenance.sh</code>.</li> <li>Backups should be pruned with the same policy window used for live data.</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#data-that-stays-local","title":"Data That Stays Local","text":"<ul> <li>With <code>HELPER_LLM_BACKEND=ollama</code>, helper inference is local to your infrastructure.</li> <li>With <code>HELPER_LLM_BACKEND=mock</code>, helper responses are deterministic local test data.</li> <li>OpenAI mode is an explicit development/future path and must not be enabled silently.</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#remote-helper-mode-explicit-consent-switch","title":"Remote Helper Mode (Explicit Consent Switch)","text":"<ul> <li>To use remote helper mode (<code>HELPER_LLM_BACKEND=openai</code>), set:</li> <li><code>HELPER_REMOTE_MODE_ACKNOWLEDGED=1</code></li> <li>If this acknowledgment is not set, <code>/helper/chat</code> returns <code>remote_backend_not_acknowledged</code> and remote mode stays blocked.</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#deletion-paths","title":"Deletion Paths","text":"<ul> <li>Student self-service:</li> <li><code>/student/my-data</code> -&gt; <code>Delete my work now</code> (deletes submissions + upload-event records).</li> <li><code>/student/my-data</code> -&gt; <code>End my session on this device</code>.</li> <li>Teacher control:</li> <li><code>/teach/class/&lt;id&gt;</code> roster -&gt; <code>Delete student data</code> (student identity + related submissions/events).</li> <li>Class reset:</li> <li><code>/teach/class/&lt;id&gt;</code> -&gt; <code>Reset roster now</code> (deletes all students/submissions in class and bumps session epoch).</li> <li>Admin/ops retention:</li> <li><code>manage.py prune_submissions</code></li> <li><code>manage.py prune_student_events</code></li> <li><code>scripts/retention_maintenance.sh</code></li> </ul>"},{"location":"PRIVACY-ADDENDUM/#operational-logging","title":"Operational Logging","text":"<ul> <li>Logged:</li> <li>request id (<code>request_id</code>), route-level status/error class, timing (<code>queue_wait_ms</code>, <code>total_ms</code>), backend name.</li> <li>Not logged by design:</li> <li>student names, return codes, raw helper prompts, submission file contents, filenames in helper event forwarding logs.</li> <li>Log rotation/retention:</li> <li>enforce at container runtime/host policy (for example Docker <code>max-size</code> + <code>max-file</code>) and align with school policy.</li> </ul>"},{"location":"PRIVACY-ADDENDUM/#anti-surveillance-statement","title":"Anti-Surveillance Statement","text":"<ul> <li>No ad-tech beacons.</li> <li>No third-party analytics trackers by default.</li> <li>No data broker sharing.</li> <li>No shadow telemetry beyond operational safety/error logging.</li> </ul>"},{"location":"PUBLIC_OVERVIEW/","title":"Public Overview","text":""},{"location":"PUBLIC_OVERVIEW/#summary","title":"Summary","text":"<p>Class Hub is a classroom-first, self-hosted micro-LMS with a separate Homework Helper service. It is designed for calm classroom operations, low-friction student access, and operator control over infrastructure and data.</p>"},{"location":"PUBLIC_OVERVIEW/#what-to-do-now","title":"What to do now","text":"<ol> <li>Decide if this fits your context (quick bullets below).</li> <li>Try the local demo path in TRY_IT_LOCAL.md.</li> <li>If you plan public deployment, read SECURITY.md, then DAY1_DEPLOY_CHECKLIST.md and RUNBOOK.md.</li> </ol>"},{"location":"PUBLIC_OVERVIEW/#verification-signal","title":"Verification signal","text":"<p>If this page is useful, you should be able to answer: who this is for, what it deliberately does not do, and the next 2 docs to read for an evaluation.</p>"},{"location":"PUBLIC_OVERVIEW/#what-it-is","title":"What it is","text":"<ul> <li>A self-hosted learning hub for classes, modules, and lesson materials.</li> <li>A simple student join flow (<code>class code + display name</code>) without student password accounts in MVP.</li> <li>A teacher/admin workflow built on Django auth, with safety controls for public-domain operation.</li> </ul>"},{"location":"PUBLIC_OVERVIEW/#who-it-is-for","title":"Who it is for","text":"<ul> <li>Small schools and programs that want self-hosted control.</li> <li>Makerspaces, after-school labs, and classroom pilots.</li> <li>Teams that prefer simple operational primitives over large platform complexity.</li> </ul>"},{"location":"PUBLIC_OVERVIEW/#what-makes-it-different","title":"What makes it different","text":"<ul> <li>Privacy-first defaults (minimal student identity model, explicit retention controls).</li> <li>Calm student join model (no student email/password in MVP).</li> <li>Public-domain hardening options (CSP, site-mode degradation, proxy guardrails).</li> <li>Self-hosted architecture with boring, inspectable components (Django, Postgres, Redis, Caddy).</li> </ul>"},{"location":"PUBLIC_OVERVIEW/#what-it-will-not-do","title":"What it will not do","text":"<ul> <li>No surveillance analytics posture.</li> <li>No ad-tech or data resale model.</li> <li>No dark-pattern growth loops.</li> <li>No hidden SaaS lock-in requirement for core operation.</li> </ul>"},{"location":"PUBLIC_OVERVIEW/#try-it-in-10-minutes","title":"Try it in 10 minutes","text":"<ul> <li>Local demo path: TRY_IT_LOCAL.md</li> </ul>"},{"location":"PUBLIC_OVERVIEW/#screenshots-placeholders","title":"Screenshots (placeholders)","text":"<ul> <li>Student join screen: <code>press/screenshots/01-student-join.png</code></li> <li>Teacher dashboard: <code>press/screenshots/03-teacher-dashboard.png</code></li> <li>Lesson page with helper: <code>press/screenshots/05-lesson-with-helper.png</code></li> </ul>"},{"location":"PUBLIC_OVERVIEW/#ops-and-security-links","title":"Ops and security links","text":"<ul> <li>SECURITY.md</li> <li>PRIVACY-ADDENDUM.md</li> <li>DAY1_DEPLOY_CHECKLIST.md</li> <li>RUNBOOK.md</li> </ul>"},{"location":"RELEASING/","title":"Releasing","text":"<p>Use this when creating a shareable source archive.</p> <p>Canonical rule: - Only publish artifacts generated by <code>scripts/make_release_zip.sh</code>. - Manual zips (<code>zip -r</code>, Finder/Explorer compression, ad-hoc tarballs) are unsupported and should be treated as invalid.</p> <pre><code>flowchart LR\n  A[Source tree] --&gt; B[make_release_zip.sh]\n  B --&gt; C[dist/*.zip]\n  C --&gt; D[lint_release_artifact.py]\n  D --&gt; E{Forbidden files present?}\n  E --&gt;|No| F[Publish/share artifact]\n  E --&gt;|Yes| G[Fix excludes and rebuild]</code></pre>"},{"location":"RELEASING/#build-release-zip","title":"Build release zip","text":"<pre><code>cd /srv/lms/app\nbash scripts/make_release_zip.sh\n</code></pre> <p>Optional output path:</p> <pre><code>bash scripts/make_release_zip.sh /srv/lms/releases/classhub_release.zip\n</code></pre>"},{"location":"RELEASING/#what-is-excluded","title":"What is excluded","text":"<p>Release archives intentionally exclude local/runtime artifacts, including:</p> <ul> <li><code>.git/</code></li> <li><code>.venv/</code></li> <li><code>__pycache__/</code></li> <li><code>media/</code></li> <li><code>staticfiles/</code></li> <li><code>data/</code></li> <li><code>.deploy/</code></li> <li><code>compose/.env</code> and local backup variants (<code>compose/.env.bak*</code>, <code>compose/.env.local*</code>)</li> <li><code>dist/</code></li> <li>common OS metadata (<code>.DS_Store</code>, <code>__MACOSX</code>)</li> </ul>"},{"location":"RELEASING/#verify-artifact-contents-locally","title":"Verify artifact contents locally","text":"<pre><code>export ZIP_PATH=\"$(ls -t dist/classhub_release_*.zip | head -n1)\"\npython3 scripts/lint_release_artifact.py \"${ZIP_PATH}\"\n</code></pre> <p>CI enforces this same rule in <code>.github/workflows/test-suite.yml</code> (<code>release-artifact-check</code>).</p>"},{"location":"RELEASING/#ops-security-notes-per-release","title":"Ops + Security Notes (per release)","text":"<p>Use this as the standard release appendix/checklist.</p>"},{"location":"RELEASING/#operational-doctrine","title":"Operational doctrine","text":"<ul> <li>Production deploys use <code>RUN_MIGRATIONS_ON_START=0</code>. Migrations run explicitly during deploy (<code>scripts/deploy_with_smoke.sh</code>).</li> <li>Health checks:</li> <li><code>/healthz</code> = edge/proxy health</li> <li><code>/upstream-healthz</code> = ClassHub upstream health</li> <li>Backups: Postgres + uploaded media (and MinIO if enabled). See DISASTER_RECOVERY.md.</li> </ul>"},{"location":"RELEASING/#access-controls","title":"Access controls","text":"<ul> <li>Staff surfaces require OTP when enabled:</li> <li>Admin: <code>DJANGO_ADMIN_2FA_REQUIRED=1</code></li> <li>Teacher portal: <code>DJANGO_TEACHER_2FA_REQUIRED=1</code></li> <li>Proxy safety defaults:</li> <li>Do not trust forwarded headers unless <code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=1</code> is explicitly set for known reverse-proxy deployments.</li> </ul>"},{"location":"RELEASING/#data-minimization-and-retention","title":"Data minimization and retention","text":"<ul> <li>Student identity is minimal by design (no default email/password accounts required).</li> <li>Retention is configurable:</li> <li><code>CLASSHUB_SUBMISSION_RETENTION_DAYS</code> (default <code>90</code>)</li> <li><code>CLASSHUB_STUDENT_EVENT_RETENTION_DAYS</code> (default <code>180</code>)</li> <li>Student self-service:</li> <li><code>/student/my-data</code> export/delete controls exist for student data control.</li> </ul>"},{"location":"RELEASING/#content-and-xss-safety","title":"Content and XSS safety","text":"<ul> <li>Markdown rendering is sanitized (Bleach allowlist) before display.</li> <li>Images are optional and gated by config; external hosts may be allowlisted.</li> </ul>"},{"location":"RELEASING/#uploads-and-file-safety","title":"Uploads and file safety","text":"<ul> <li>Upload limits are enforced at both layers:</li> <li>Caddy <code>max_body_size</code></li> <li>Django upload limits</li> <li>Upload validation includes filetype policy; optional AV scanning can be enabled.</li> <li>If AV scanning is enabled, consider fail-closed for maximum safety.</li> </ul>"},{"location":"RELEASING/#homework-helper-boundary","title":"Homework Helper boundary","text":"<ul> <li>Helper is a separate service routed behind <code>/helper/*</code>.</li> <li>Requests are constrained (<code>1MB</code>) and rate limited.</li> <li>Helper scope tokens constrain context; events record access metadata, not prompt content.</li> </ul>"},{"location":"RELEASING/#reproducibility","title":"Reproducibility","text":"<ul> <li>Core infra images are pinned in compose where possible (<code>Caddy</code>, <code>Postgres</code>, <code>Redis</code>).</li> <li>Supporting services may intentionally track <code>latest</code> depending on operator preference.</li> </ul>"},{"location":"RELEASING/#operator-checklist","title":"Operator checklist","text":"<ul> <li>Confirm <code>.env</code> has no placeholder secrets (<code>bash scripts/validate_env_secrets.sh</code>).</li> <li>Confirm OTP works for <code>/teach/*</code> and <code>/admin/*</code>.</li> <li>Confirm <code>/upstream-healthz</code> returns OK after deploy.</li> <li>Confirm retention jobs/timers are configured if using pruning.</li> </ul>"},{"location":"REQUEST_SAFETY/","title":"Request Safety (Shared)","text":"<p>Shared package: <code>services/common/request_safety/</code></p> <p>Use this package in both Django services for: - proxy-aware client IP parsing - cache-backed rate limit helpers - optional actor key builders (staff/student session identity)</p>"},{"location":"REQUEST_SAFETY/#canonical-usage","title":"Canonical usage","text":"<p>Python import:</p> <pre><code>from common.request_safety import (\n    build_staff_or_student_actor_key,\n    client_ip_from_request,\n    fixed_window_allow,\n)\n</code></pre> <p>Typical request flow: 1. Build actor key (if needed): <code>build_staff_or_student_actor_key(request)</code> 2. Parse IP safely: <code>client_ip_from_request(request, trust_proxy_headers=..., xff_index=...)</code> 3. Enforce burst limit: <code>fixed_window_allow(key, limit=..., window_seconds=60, cache_backend=cache)</code></p> <p>Optional advanced limiter: - <code>token_bucket_allow(...)</code> for smoother refill behavior. - Both limiter helpers are fail-open on cache backend errors (requests continue). - Pass <code>request_id=...</code> when available so cache warnings can be traced in logs.</p>"},{"location":"REQUEST_SAFETY/#shared-env-knobs","title":"Shared env knobs","text":"<p>Set once in <code>compose/.env</code> (applies to both services):</p> <ul> <li><code>REQUEST_SAFETY_TRUST_PROXY_HEADERS</code></li> <li><code>0</code> (default): use only <code>REMOTE_ADDR</code></li> <li><code>1</code>: trust <code>X-Forwarded-For</code></li> <li><code>REQUEST_SAFETY_XFF_INDEX</code></li> <li>default <code>0</code> (left-most IP in <code>X-Forwarded-For</code>)</li> <li>use another index if your proxy chain requires it</li> </ul>"},{"location":"REQUEST_SAFETY/#service-specific-limit-knobs","title":"Service-specific limit knobs","text":"<p>Class Hub: - <code>CLASSHUB_JOIN_RATE_LIMIT_PER_MINUTE</code></p> <p>Homework Helper: - <code>HELPER_RATE_LIMIT_PER_MINUTE</code> - <code>HELPER_RATE_LIMIT_PER_IP_PER_MINUTE</code></p> <p>Keep service limits separate, but keep parsing + limiter mechanics centralized in <code>common.request_safety</code>.</p>"},{"location":"REQUEST_SAFETY/#proxy-note","title":"Proxy note","text":"<p>Keep <code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=0</code> unless your immediate upstream proxy is trusted and overwrites <code>X-Forwarded-*</code> headers.</p> <p>The compose Caddy configs set <code>X-Forwarded-For</code>, <code>X-Real-IP</code>, and <code>X-Forwarded-Proto</code> from the immediate connection values before proxying to Django. When Caddy is your first hop, set <code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=1</code> for deterministic rate-limit IP parsing.</p>"},{"location":"RUNBOOK/","title":"Runbook","text":"<p>This is the operator playbook for running the stack safely in production.</p> <p>If you are new, start with START_HERE.md and DAY1_DEPLOY_CHECKLIST.md first.</p> <pre><code>flowchart TD\n  A[Deploy/Operate] --&gt; B[validate_env_secrets]\n  B --&gt; C[migration_gate]\n  C --&gt; D[deploy_with_smoke]\n  D --&gt; E{Smoke pass?}\n  E --&gt;|Yes| F[Record good state]\n  E --&gt;|No| G[Rollback hook / triage]\n  G --&gt; H[system_doctor + logs]</code></pre>"},{"location":"RUNBOOK/#working-directories","title":"Working directories","text":"<ul> <li>Repo root (server): <code>/srv/lms/app</code></li> <li>Compose folder: <code>/srv/lms/app/compose</code></li> </ul> <p>Use repo root unless a section explicitly says otherwise.</p>"},{"location":"RUNBOOK/#60-second-quick-command-set","title":"60-second quick command set","text":"<pre><code>cd /srv/lms/app\nbash scripts/system_doctor.sh\n\ncd /srv/lms/app/compose\ndocker compose ps\ndocker compose logs --tail=200 classhub_web helper_web caddy\n</code></pre> <p>If <code>system_doctor</code> passes, the platform is usually in good shape.</p>"},{"location":"RUNBOOK/#standard-operations","title":"Standard operations","text":""},{"location":"RUNBOOK/#start-stop-stack","title":"Start / stop stack","text":"<pre><code>cd /srv/lms/app/compose\n# Start\ndocker compose up -d\n# Stop\ndocker compose down\n</code></pre> <p>Verify:</p> <pre><code>docker compose ps\ncurl -fsS http://localhost/healthz\ncurl -fsS http://localhost/upstream-healthz\ncurl -fsS http://localhost/helper/healthz\n</code></pre>"},{"location":"RUNBOOK/#guardrailed-deploy-recommended","title":"Guardrailed deploy (recommended)","text":"<pre><code>cd /srv/lms/app\nbash scripts/deploy_with_smoke.sh\n</code></pre> <p>What this deploy command enforces:</p> <ul> <li>environment and secret validation</li> <li>migration gate for both Django services</li> <li>runtime <code>manage.py migrate --noinput</code> for both Django services</li> <li>compose launch via <code>compose/docker-compose.yml</code> only</li> <li>Caddy template mount sanity checks</li> <li>smoke checks (<code>/healthz</code>, <code>/helper/healthz</code>, join, helper chat, teacher login)</li> </ul> <p>Optional rollback hook:</p> <pre><code>cd /srv/lms/app\nROLLBACK_CMD='echo \"replace with your rollback command\"' bash scripts/deploy_with_smoke.sh\n</code></pre>"},{"location":"RUNBOOK/#full-stack-self-check-doctor","title":"Full stack self-check (doctor)","text":"<pre><code>cd /srv/lms/app\nbash scripts/system_doctor.sh\n</code></pre> <p>Useful variants:</p> <pre><code># Strict smoke using existing SMOKE_* env values\nbash scripts/system_doctor.sh --smoke-mode strict\n\n# Fast baseline smoke\nbash scripts/system_doctor.sh --smoke-mode basic\n\n# Infra/content checks only\nbash scripts/system_doctor.sh --smoke-mode off\n</code></pre>"},{"location":"RUNBOOK/#smoke-checks-only","title":"Smoke checks only","text":"<pre><code>cd /srv/lms/app\nbash scripts/smoke_check.sh --strict\n</code></pre> <p>Golden-path smoke (auto fixture bootstrap):</p> <pre><code>cd /srv/lms/app\nbash scripts/golden_path_smoke.sh\n</code></pre>"},{"location":"RUNBOOK/#public-domain-deployment-notes","title":"Public domain deployment notes","text":"<p>When running behind Caddy on a real domain, use these defaults to avoid false rate-limit identity and upload mismatches:</p> <ul> <li>Proxy/IP trust:</li> <li>Set <code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=1</code> so Django rate limiting sees client IPs forwarded by Caddy.</li> <li>Keep <code>REQUEST_SAFETY_XFF_INDEX=0</code> when Caddy is the first trusted hop.</li> <li>Upload size alignment:</li> <li>Set <code>CADDY_CLASSHUB_MAX_BODY</code> slightly above <code>CLASSHUB_UPLOAD_MAX_MB</code> (for example, <code>650MB</code> vs <code>600</code>).</li> <li><code>CLASSHUB_UPLOAD_MAX_MB</code> controls Django request body cap for class uploads.</li> <li>Keep <code>CLASSHUB_GUNICORN_TIMEOUT_SECONDS</code> high enough for large uploads on classroom Wi-Fi (default <code>1200</code> seconds).</li> <li>Keep <code>HELPER_GUNICORN_TIMEOUT_SECONDS</code> above helper queue/retry budget (<code>HELPER_QUEUE_MAX_WAIT_SECONDS</code>, <code>HELPER_BACKEND_MAX_ATTEMPTS</code>, <code>OLLAMA_TIMEOUT_SECONDS</code>, <code>HELPER_BACKOFF_SECONDS</code>); <code>scripts/validate_env_secrets.sh</code> now blocks unsafe combinations.</li> <li>Retention timer:</li> <li>Enable the <code>classhub-retention.timer</code> unit so submission/event cleanup runs automatically.</li> <li>Timer setup commands are in Automate retention + orphan cleanup.</li> <li>Teacher/admin proxy armor:</li> <li>Optional IP allowlist for <code>/admin*</code> + <code>/teach*</code>:<ul> <li><code>CADDY_STAFF_IP_ALLOWLIST_V4</code></li> <li><code>CADDY_STAFF_IP_ALLOWLIST_V6</code></li> </ul> </li> <li>Optional extra basic-auth gate for <code>/admin*</code>:<ul> <li><code>CADDY_ADMIN_BASIC_AUTH_ENABLED=1</code></li> <li><code>CADDY_ADMIN_BASIC_AUTH_USER</code></li> <li><code>CADDY_ADMIN_BASIC_AUTH_HASH</code></li> </ul> </li> </ul>"},{"location":"RUNBOOK/#incident-degradation-modes","title":"Incident degradation modes","text":"<p>Use <code>CLASSHUB_SITE_MODE</code> in <code>compose/.env</code>, then redeploy:</p> <ul> <li><code>normal</code></li> <li><code>read-only</code></li> <li><code>join-only</code></li> <li><code>maintenance</code></li> </ul> <p>Example:</p> <pre><code>cd /srv/lms/app\nsed -i.bak 's/^CLASSHUB_SITE_MODE=.*/CLASSHUB_SITE_MODE=join-only/' compose/.env\nbash scripts/deploy_with_smoke.sh\n</code></pre> <p>Optional status message shown to users on blocked routes:</p> <ul> <li><code>CLASSHUB_SITE_MODE_MESSAGE</code></li> </ul>"},{"location":"RUNBOOK/#health-and-logs","title":"Health and logs","text":""},{"location":"RUNBOOK/#health-checks","title":"Health checks","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose ps\ncurl -I http://localhost/healthz\ncurl -I http://localhost/upstream-healthz\ncurl -I http://localhost/helper/healthz\n</code></pre>"},{"location":"RUNBOOK/#tail-logs","title":"Tail logs","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose logs -f --tail=200 classhub_web\ndocker compose logs -f --tail=200 helper_web\ndocker compose logs -f --tail=200 caddy\n</code></pre> <p>Helper logs include structured events like <code>success</code>, <code>queue_busy</code>, and <code>backend_transport_error</code> with <code>request_id</code>.</p>"},{"location":"RUNBOOK/#migration-and-content-gates","title":"Migration and content gates","text":""},{"location":"RUNBOOK/#migration-gate-only","title":"Migration gate only","text":"<pre><code>cd /srv/lms/app\nbash scripts/migration_gate.sh\n</code></pre> <p><code>migration_gate.sh</code> checks that migration files are committed. It does not apply DB migrations.</p>"},{"location":"RUNBOOK/#apply-runtime-migrations","title":"Apply runtime migrations","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose exec -T classhub_web python manage.py migrate --noinput\ndocker compose exec -T helper_web python manage.py migrate --noinput\n</code></pre> <p><code>RUN_MIGRATIONS_ON_START=0</code> is the production default to avoid boot-time migration races; keep it <code>1</code> only for local/dev workflows where container boot should self-migrate.</p>"},{"location":"RUNBOOK/#content-preflight","title":"Content preflight","text":"<pre><code>cd /srv/lms/app\nbash scripts/content_preflight.sh piper_scratch_12_session\n</code></pre> <p>Strict global sequence checks:</p> <pre><code>cd /srv/lms/app\nbash scripts/content_preflight.sh piper_scratch_12_session --strict-global\n</code></pre>"},{"location":"RUNBOOK/#helper-backend-operations","title":"Helper backend operations","text":""},{"location":"RUNBOOK/#ollama-model-setup","title":"Ollama model setup","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose exec ollama ollama pull llama3.2:1b\ncurl http://localhost:11434/api/tags\n</code></pre> <p>Note: Ollama is host-bound at <code>127.0.0.1:11434</code> by default.</p>"},{"location":"RUNBOOK/#helper-queue-tuning-cpu-focused","title":"Helper queue tuning (CPU-focused)","text":"<p>Set in <code>compose/.env</code>:</p> <pre><code>HELPER_MAX_CONCURRENCY=2\nHELPER_QUEUE_MAX_WAIT_SECONDS=10\nHELPER_QUEUE_POLL_SECONDS=0.2\nHELPER_QUEUE_SLOT_TTL_SECONDS=120\n</code></pre>"},{"location":"RUNBOOK/#security-and-edge-limits","title":"Security and edge limits","text":""},{"location":"RUNBOOK/#envsecret-gate-only","title":"Env/secret gate only","text":"<pre><code>cd /srv/lms/app\nbash scripts/validate_env_secrets.sh\n</code></pre>"},{"location":"RUNBOOK/#caddy-request-size-limits","title":"Caddy request size limits","text":"<p>Set in <code>compose/.env</code>:</p> <pre><code>CADDY_CLASSHUB_MAX_BODY=650MB\nCADDY_HELPER_MAX_BODY=1MB\n</code></pre>"},{"location":"RUNBOOK/#teacheradmin-operations","title":"Teacher/admin operations","text":""},{"location":"RUNBOOK/#teacher-account-workflow","title":"Teacher account workflow","text":"<ul> <li>TEACHER_PORTAL.md</li> <li>TEACHER_HANDOFF_CHECKLIST.md</li> <li>TEACHER_HANDOFF_RECORD_TEMPLATE.md</li> </ul> <p>Helper script:</p> <ul> <li><code>scripts/examples/teacher_accounts.sh</code> (dry-run by default; set <code>RUN=1</code> to execute)</li> </ul>"},{"location":"RUNBOOK/#admin-otp-bootstrap","title":"Admin OTP bootstrap","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py bootstrap_admin_otp --username &lt;admin_username&gt; --with-static-backup\n</code></pre> <p>Use <code>--rotate</code> to replace an existing device name.</p>"},{"location":"RUNBOOK/#backups-and-recovery-hooks","title":"Backups and recovery hooks","text":"<p>Backup scripts:</p> <ul> <li><code>scripts/backup_postgres.sh</code></li> <li><code>scripts/backup_minio.sh</code></li> <li><code>scripts/backup_uploads.sh</code></li> </ul> <p>Disaster recovery guide:</p> <ul> <li>DISASTER_RECOVERY.md</li> </ul> <p>Recommended restore drill:</p> <ol> <li>Restore Postgres dump into a temporary DB.</li> <li>Confirm both Django services migrate and boot.</li> <li>Run <code>bash scripts/system_doctor.sh --smoke-mode basic</code>.</li> </ol>"},{"location":"RUNBOOK/#release-artifact-packaging","title":"Release artifact packaging","text":"<p>Create a shareable source zip without local machine clutter (<code>.venv</code>, <code>.git</code>, macOS metadata, caches):</p> <pre><code>cd /srv/lms/app\nbash scripts/make_release_zip.sh\n</code></pre> <p>Optional output path:</p> <pre><code>bash scripts/make_release_zip.sh /srv/lms/releases/classhub_release.zip\n</code></pre> <p>Validate the generated archive explicitly:</p> <pre><code>python3 scripts/lint_release_artifact.py /srv/lms/releases/classhub_release.zip\n</code></pre> <p>Release packaging policy and verification details:</p> <ul> <li>RELEASING.md</li> </ul>"},{"location":"RUNBOOK/#retention-operations","title":"Retention operations","text":""},{"location":"RUNBOOK/#submission-retention","title":"Submission retention","text":"<p>Dry run:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_submissions --older-than-days 90 --dry-run\n</code></pre> <p>Apply:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_submissions --older-than-days 90\n</code></pre> <p>Optional default (<code>compose/.env</code>):</p> <pre><code>CLASSHUB_SUBMISSION_RETENTION_DAYS=90\n</code></pre>"},{"location":"RUNBOOK/#student-event-retention","title":"Student event retention","text":"<p>Dry run:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_student_events --older-than-days 180 --dry-run\n</code></pre> <p>Dry run with CSV export snapshot:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_student_events --older-than-days 180 --dry-run --export-csv /tmp/student_events_older_than_180d.csv\n</code></pre> <p>Apply:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_student_events --older-than-days 180\n</code></pre> <p>Apply with export-before-delete snapshot:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py prune_student_events --older-than-days 180 --export-csv /srv/lms/backups/student_events_before_prune_$(date +%Y%m%d).csv\n</code></pre> <p>Optional default (<code>compose/.env</code>):</p> <pre><code>CLASSHUB_STUDENT_EVENT_RETENTION_DAYS=180\n</code></pre>"},{"location":"RUNBOOK/#orphan-upload-scavenger-legacy-cleanup","title":"Orphan upload scavenger (legacy cleanup)","text":"<p>Report orphaned upload files (files on disk with no matching DB row):</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py scavenge_orphan_uploads\n</code></pre> <p>Delete orphans (use after reviewing report output):</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py scavenge_orphan_uploads --delete\n</code></pre>"},{"location":"RUNBOOK/#legacy-temp-zip-cleanup-one-time","title":"Legacy temp ZIP cleanup (one-time)","text":"<p>Older builds could leave export zips in <code>/tmp</code>.</p> <p>Inspect:</p> <pre><code>ls -lh /tmp/classhub_closeout_*.zip /tmp/classhub_latest_*.zip 2&gt;/dev/null || true\n</code></pre> <p>Delete:</p> <pre><code>rm -f /tmp/classhub_closeout_*.zip /tmp/classhub_latest_*.zip\n</code></pre>"},{"location":"RUNBOOK/#helper-event-ingest-check","title":"Helper event ingest check","text":"<p>Helper chat telemetry now forwards through an authenticated internal Class Hub endpoint.</p> <p>Required env:</p> <ul> <li><code>CLASSHUB_INTERNAL_EVENTS_URL</code></li> <li><code>CLASSHUB_INTERNAL_EVENTS_TOKEN</code></li> </ul> <p>Quick validation:</p> <pre><code>cd /srv/lms/app\nbash scripts/validate_env_secrets.sh\nbash scripts/system_doctor.sh --smoke-mode golden\n</code></pre>"},{"location":"RUNBOOK/#automate-retention-orphan-cleanup","title":"Automate retention + orphan cleanup","text":"<p>Run once manually:</p> <pre><code>cd /srv/lms/app\nbash scripts/retention_maintenance.sh --compose-mode prod\n</code></pre> <p>Optional webhook alerts (for unattended runs):</p> <pre><code>export RETENTION_ALERT_WEBHOOK_URL=\"https://hooks.example.org/classhub\"\nbash scripts/retention_maintenance.sh --compose-mode prod --alert-on-success\n</code></pre> <p>Systemd timer (recommended):</p> <pre><code>sudo cp /srv/lms/app/ops/systemd/classhub-retention.service /etc/systemd/system/\nsudo cp /srv/lms/app/ops/systemd/classhub-retention.timer /etc/systemd/system/\nsudo systemctl daemon-reload\nsudo systemctl enable --now classhub-retention.timer\nsudo systemctl status classhub-retention.timer\n</code></pre> <p>Before enabling, edit <code>/etc/systemd/system/classhub-retention.service</code> if your app path or runtime user differs from <code>/srv/lms/app</code>.</p> <p>Review last run:</p> <pre><code>systemctl list-timers | grep classhub-retention\njournalctl -u classhub-retention.service -n 200 --no-pager\n</code></pre>"},{"location":"RUNBOOK/#escalate-when","title":"Escalate when","text":"<p>Move to incident workflow (TROUBLESHOOTING.md, then DISASTER_RECOVERY.md) when any of these are true:</p> <ul> <li>health checks still fail after config verification</li> <li>migrations fail in production</li> <li>repeated auth failures without expected config drift</li> <li>data integrity issues (missing classes/submissions without intended prune/reset)</li> </ul>"},{"location":"SECURITY/","title":"Security","text":"<p>This page is the practical security baseline for this project. Canonical ownership map for edge vs app headers: SECURITY_BASELINE.md.</p>"},{"location":"SECURITY/#reporting-security-issues","title":"Reporting security issues","text":"<p>For private vulnerability reports, contact: <code>security@your-org.example</code>.</p> <ul> <li>Do not include exploit details in public issues.</li> <li>Include reproduction steps, affected version/commit, and impact.</li> <li>Expect an initial acknowledgement within 3 business days.</li> </ul> <p>If you only do three things before production:</p> <ol> <li>set strong secrets and <code>DJANGO_DEBUG=0</code></li> <li>require TLS and 2FA for admin + teacher users</li> <li>run <code>bash scripts/validate_env_secrets.sh</code></li> </ol> <pre><code>flowchart LR\n  U[Users] --&gt; C[Caddy edge]\n  C --&gt; H1[Security headers]\n  C --&gt; H2[Route armor&lt;br/&gt;/admin + /teach]\n  C --&gt; A[Class Hub]\n  C --&gt; B[Homework Helper]\n  A --&gt; D[Django auth + OTP]\n  B --&gt; E[Scope token + rate limits]\n  A --&gt; F[(Postgres/Redis)]\n  B --&gt; F</code></pre>"},{"location":"SECURITY/#security-posture-at-a-glance","title":"Security posture at a glance","text":"Area Current posture Student identity Pseudonymous (<code>class code + display name</code>) Teacher/admin auth Django auth; OTP required by default for <code>/admin</code> and <code>/teach</code> Transport Caddy at edge; HTTPS expected in production Service exposure Postgres/Redis internal-only; Ollama/MinIO localhost-bound on host Browser hardening Enforced CSP + report-only CSP + Permissions-Policy + Referrer-Policy + frame protections Helper scope protection Student helper calls require signed <code>scope_token</code> Upload access Not public <code>/media</code>; downloads are permission-checked views Auditing Staff mutations logged as immutable <code>AuditEvent</code> rows Helper event ingest Authenticated internal endpoint (token-gated)"},{"location":"SECURITY/#day-1-production-checklist","title":"Day-1 production checklist","text":"<ol> <li>Set <code>DJANGO_DEBUG=0</code>.</li> <li>Set a strong <code>DJANGO_SECRET_KEY</code> (non-default, 32+ chars).</li> <li>Enable HTTPS behavior for domain deployments:</li> <li><code>DJANGO_SECURE_SSL_REDIRECT=1</code></li> <li><code>CADDY_HSTS_MAX_AGE</code> (edge-owned HSTS; recommend <code>&gt;=31536000</code> after verification)</li> <li>Keep <code>DJANGO_ADMIN_2FA_REQUIRED=1</code>.</li> <li>Keep <code>DJANGO_TEACHER_2FA_REQUIRED=1</code>.</li> <li>Set deployment timezone (for lesson release dates):</li> <li><code>DJANGO_TIME_ZONE=America/Chicago</code> (or your local timezone)</li> <li>If using separate asset subdomain under same parent domain, set cookie domains:</li> <li><code>DJANGO_SESSION_COOKIE_DOMAIN=.yourdomain.tld</code></li> <li><code>DJANGO_CSRF_COOKIE_DOMAIN=.yourdomain.tld</code></li> <li>Validate secrets and guardrails:</li> <li><code>bash scripts/validate_env_secrets.sh</code></li> <li>Confirm edge request size limits are set:</li> <li><code>CADDY_CLASSHUB_MAX_BODY</code></li> <li><code>CADDY_HELPER_MAX_BODY</code></li> <li>Set a strong cross-service event token:</li> <li><code>CLASSHUB_INTERNAL_EVENTS_TOKEN</code></li> </ol>"},{"location":"SECURITY/#authentication-and-authorization-boundaries","title":"Authentication and authorization boundaries","text":"<ul> <li>Students do not have passwords in MVP.</li> <li>Teachers should be <code>is_staff=True</code>, <code>is_superuser=False</code> for daily use.</li> <li><code>/teach/*</code> requires OTP-verified staff session when <code>DJANGO_TEACHER_2FA_REQUIRED=1</code>.</li> <li>Superusers should be limited to operational tasks.</li> <li>Helper chat requires either:</li> <li>valid student classroom session, or</li> <li>authenticated staff session.</li> <li>Student helper requests must include a valid signed scope token.</li> <li>Staff can also be forced to require signed scope tokens:</li> <li><code>HELPER_REQUIRE_SCOPE_TOKEN_FOR_STAFF=1</code></li> </ul> <p>Admin 2FA bootstrap command:</p> <pre><code>docker compose exec classhub_web python manage.py bootstrap_admin_otp --username &lt;admin_username&gt; --with-static-backup\n</code></pre>"},{"location":"SECURITY/#network-and-proxy-trust-model","title":"Network and proxy trust model","text":"<ul> <li>Caddy is the public edge.</li> <li>Postgres and Redis are not published on host ports.</li> <li>Ollama and MinIO are bound to <code>127.0.0.1</code> on the host for local/admin access.</li> <li>Proxy header trust is explicit opt-in:</li> <li><code>REQUEST_SAFETY_TRUST_PROXY_HEADERS=0</code> by default</li> <li>set to <code>1</code> only when your first-hop proxy is trusted and rewrites <code>X-Forwarded-*</code>.</li> </ul>"},{"location":"SECURITY/#proxy-armor-for-teacheradmin-routes","title":"Proxy armor for teacher/admin routes","text":"<p>Optional Caddy controls for <code>/admin*</code> and <code>/teach*</code>:</p> <ul> <li>IP allowlist:</li> <li><code>CADDY_STAFF_IP_ALLOWLIST_V4</code> / <code>CADDY_STAFF_IP_ALLOWLIST_V6</code> (defaults allow all)</li> <li>Extra <code>/admin*</code> basic-auth gate:</li> <li><code>CADDY_ADMIN_BASIC_AUTH_ENABLED=1</code></li> <li><code>CADDY_ADMIN_BASIC_AUTH_USER</code></li> <li><code>CADDY_ADMIN_BASIC_AUTH_HASH</code> (bcrypt hash)</li> </ul> <p>These controls are additive to Django auth + OTP.</p>"},{"location":"SECURITY/#data-handling-and-retention","title":"Data handling and retention","text":"<p>Field-level lifecycle details (exact fields, TTL knobs, deletion controls): PRIVACY-ADDENDUM.md.</p>"},{"location":"SECURITY/#student-submissions","title":"Student submissions","text":"<ul> <li>Stored under <code>data/classhub_uploads/</code>.</li> <li>Not served as public static media.</li> <li>Access is permission-checked (<code>/submission/&lt;id&gt;/download</code>).</li> <li>Files use randomized server-side names; original filename is metadata only.</li> <li>Upload checks now include lightweight content validation (for example <code>.sb3</code> must be a valid zip with <code>project.json</code>).</li> <li>File cleanup signals remove stored files on row delete/cascade delete and file replacement.</li> </ul>"},{"location":"SECURITY/#upload-flow-map-d2","title":"Upload flow (Map D2)","text":"<pre><code>sequenceDiagram\n  participant B as Browser\n  participant MW as Middleware\n  participant V as student.material_upload\n  participant UV as upload_validation\n  participant FS as MEDIA storage\n  participant DB as Postgres\n  participant R as Redis/cache\n\n  B-&gt;&gt;MW: POST /material/&lt;id&gt;/upload (file)\n  MW-&gt;&gt;V: request (mode/headers/session)\n  V-&gt;&gt;R: rate limits (fail-open for student continuity)\n  V-&gt;&gt;UV: validate size + allowlist + magic bytes + scan hook\n  UV--&gt;&gt;V: ok / reject\n  V-&gt;&gt;FS: save file bytes\n  V-&gt;&gt;DB: create Submission (metadata)\n  V-&gt;&gt;DB: StudentEvent (ext + size only)\n  V-&gt;&gt;B: 200/redirect + user-visible message</code></pre>"},{"location":"SECURITY/#lesson-assets","title":"Lesson assets","text":"<ul> <li>Lesson assets are permission-checked (<code>/lesson-asset/&lt;id&gt;/download</code>).</li> <li>Unsafe file types (for example <code>.html</code>) are forced to download, not inline render.</li> <li>Inline rendering is restricted to allow-listed media/PDF types and includes <code>X-Content-Type-Options: nosniff</code>.</li> <li>Optional: set <code>CLASSHUB_ASSET_BASE_URL</code> to serve lesson asset/video links from a separate origin.</li> </ul> <p>Retention commands:</p> <pre><code>python manage.py prune_submissions --older-than-days &lt;N&gt;\npython manage.py prune_student_events --older-than-days &lt;N&gt;\npython manage.py prune_student_events --older-than-days &lt;N&gt; --export-csv /path/to/student_events_before_prune.csv\npython manage.py scavenge_orphan_uploads\n</code></pre> <p>Scheduled maintenance entrypoint:</p> <pre><code>bash scripts/retention_maintenance.sh --compose-mode prod\n</code></pre>"},{"location":"SECURITY/#event-logging","title":"Event logging","text":"<ul> <li><code>AuditEvent</code> logs staff actions in <code>/teach/*</code>.</li> <li><code>StudentEvent</code> stores metadata (status/request IDs/timing) only.</li> <li>No raw helper prompt text and no file contents are stored in <code>StudentEvent.details</code>.</li> </ul>"},{"location":"SECURITY/#helper-specific-controls","title":"Helper-specific controls","text":"<ul> <li>Unsigned helper scope fields (<code>context/topics/allowed_topics/reference</code>) are ignored.</li> <li>Helper access telemetry is forwarded to Class Hub via authenticated internal endpoint:</li> <li><code>CLASSHUB_INTERNAL_EVENTS_URL</code></li> <li><code>CLASSHUB_INTERNAL_EVENTS_TOKEN</code></li> <li>Student helper session-table checks are configurable:</li> <li>default: fail-open when classhub tables are unavailable</li> <li>production hardening option: <code>HELPER_REQUIRE_CLASSHUB_TABLE=1</code> (fail-closed)</li> <li>Local LLM (<code>Ollama</code>) keeps inference on your infrastructure, but logs and prompt handling still require governance.</li> </ul>"},{"location":"SECURITY/#upload-malware-scanning-optional","title":"Upload malware scanning (optional)","text":"<p>Enable command-based scanning (for example ClamAV):</p> <ul> <li><code>CLASSHUB_UPLOAD_SCAN_ENABLED=1</code></li> <li><code>CLASSHUB_UPLOAD_SCAN_COMMAND</code> (example: <code>clamscan --no-summary --stdout</code>)</li> <li><code>CLASSHUB_UPLOAD_SCAN_FAIL_CLOSED=1</code> to block uploads on scanner errors/timeouts</li> </ul>"},{"location":"SECURITY/#csp-and-browser-security-headers","title":"CSP and browser security headers","text":"<p>Class Hub and Homework Helper attach these headers by default:</p> <ul> <li><code>Content-Security-Policy</code> (enforced)</li> <li><code>Content-Security-Policy-Report-Only</code> (for visibility while tuning)</li> <li><code>Permissions-Policy</code></li> <li><code>Referrer-Policy</code></li> <li><code>X-Frame-Options</code></li> </ul> <p>Primary knobs:</p> <ul> <li><code>DJANGO_CSP_POLICY</code></li> <li><code>DJANGO_CSP_REPORT_ONLY_POLICY</code></li> <li><code>DJANGO_PERMISSIONS_POLICY</code></li> <li><code>DJANGO_SECURE_REFERRER_POLICY</code></li> </ul> <p>Rollout strategy:</p> <ol> <li>Keep report-only enabled while reviewing violations.</li> <li>Tighten directives (especially <code>script-src</code>, <code>style-src</code>, <code>connect-src</code>, <code>frame-src</code>).</li> <li>Keep enforced + report-only in parallel until violation noise stabilizes.</li> </ol> <p>Embed notes:</p> <ul> <li>YouTube embeds use privacy-enhanced <code>youtube-nocookie.com</code>; keep <code>frame-src https://www.youtube-nocookie.com</code>.</li> <li>Separate asset origins require matching updates in <code>img-src</code>, <code>media-src</code>, and <code>connect-src</code>.</li> </ul>"},{"location":"SECURITY/#site-degradation-modes","title":"Site degradation modes","text":"<p><code>CLASSHUB_SITE_MODE</code> can narrow behavior during incidents:</p> <ul> <li><code>normal</code></li> <li><code>read-only</code> (uploads/write actions blocked)</li> <li><code>join-only</code> (student entry paths available, heavy routes paused)</li> <li><code>maintenance</code> (student-facing routes paused)</li> </ul> <p>Optional operator message override:</p> <ul> <li><code>CLASSHUB_SITE_MODE_MESSAGE</code></li> </ul>"},{"location":"SECURITY/#future-hardening-candidates","title":"Future hardening candidates","text":"<ul> <li>Google SSO for teacher accounts.</li> <li>Separate databases per service if isolation requirements increase.</li> <li>Keep <code>RUN_MIGRATIONS_ON_START=0</code> in production so migrations run only through explicit deploy steps.</li> </ul>"},{"location":"SECURITY_BASELINE/","title":"Security Baseline","text":"<p>This is the single source of truth for edge-vs-app security ownership.</p>"},{"location":"SECURITY_BASELINE/#edge-owned-caddy","title":"Edge-Owned (Caddy)","text":"<ul> <li>Request body size limits:</li> <li><code>CADDY_CLASSHUB_MAX_BODY</code> (default <code>650MB</code>)</li> <li><code>CADDY_HELPER_MAX_BODY</code> (default <code>1MB</code>)</li> <li>Route armor for <code>/admin*</code> and <code>/teach*</code>:</li> <li>IP allowlists: <code>CADDY_STAFF_IP_ALLOWLIST_V4</code>, <code>CADDY_STAFF_IP_ALLOWLIST_V6</code></li> <li>Optional basic auth gate for <code>/admin*</code>: <code>CADDY_ADMIN_BASIC_AUTH_*</code></li> <li>TLS redirect/termination (domain templates) and HSTS:</li> <li><code>Strict-Transport-Security: max-age=${CADDY_HSTS_MAX_AGE}</code> (default <code>31536000</code>)</li> <li>Compression (<code>encode gzip</code>)</li> </ul>"},{"location":"SECURITY_BASELINE/#app-owned-django","title":"App-Owned (Django)","text":"<ul> <li>CSP:</li> <li>Enforced: <code>Content-Security-Policy</code> from <code>DJANGO_CSP_POLICY</code> (production default baseline)</li> <li>Report-only: <code>Content-Security-Policy-Report-Only</code> from <code>DJANGO_CSP_REPORT_ONLY_POLICY</code></li> <li>Framing policy:</li> <li>Primary: CSP <code>frame-ancestors 'self'</code></li> <li>Fallback: <code>X-Frame-Options: SAMEORIGIN</code> (<code>DJANGO_X_FRAME_OPTIONS</code>)</li> <li><code>Permissions-Policy</code> from <code>DJANGO_PERMISSIONS_POLICY</code></li> <li><code>Referrer-Policy</code> from <code>DJANGO_SECURE_REFERRER_POLICY</code></li> <li>Cache policy:</li> <li>Sensitive responses: <code>Cache-Control: private, no-store</code> (+ <code>Pragma: no-cache</code> where set)</li> <li>Join JSON carrying return codes: <code>Cache-Control: no-store</code> (+ <code>Pragma: no-cache</code>)</li> <li>Inline authenticated lesson assets: <code>Cache-Control: private, max-age=60</code></li> <li>Sensitive download hardening:</li> <li><code>X-Content-Type-Options: nosniff</code></li> <li><code>Content-Security-Policy: default-src 'none'; sandbox</code></li> <li><code>Referrer-Policy: no-referrer</code></li> <li>Site mode responses (<code>read-only</code>, <code>join-only</code>, <code>maintenance</code>) return <code>Cache-Control: no-store</code></li> </ul>"},{"location":"SECURITY_BASELINE/#header-inventory-drift-table","title":"Header Inventory (Drift Table)","text":"Header Set by (current) Current value(s) Intended owner Final intended value <code>Content-Security-Policy</code> Django middleware + some download views Default policy includes <code>frame-ancestors 'self'</code>; download views use <code>default-src 'none'; sandbox</code> Django Keep middleware policy; keep stricter per-download override <code>Content-Security-Policy-Report-Only</code> Django middleware Mirrors configured report-only policy Django Keep report-only during rollout, then tune/remove as needed <code>X-Frame-Options</code> Django middleware <code>SAMEORIGIN</code> default (<code>DJANGO_X_FRAME_OPTIONS</code>) Django <code>SAMEORIGIN</code> fallback, compatible with CSP <code>frame-ancestors 'self'</code> <code>Permissions-Policy</code> Django middleware Value from <code>DJANGO_PERMISSIONS_POLICY</code> Django Keep app-owned <code>Referrer-Policy</code> Django middleware + some download views Global <code>strict-origin-when-cross-origin</code>; downloads <code>no-referrer</code> Django Keep app-owned with per-download strict override <code>X-Content-Type-Options</code> Django (<code>SECURE_CONTENT_TYPE_NOSNIFF</code>) + download views Global <code>nosniff</code> in prod; explicit on sensitive downloads Django Keep app-owned; explicit per-download remains <code>Cache-Control</code> View-level + site-mode middleware Sensitive pages/downloads <code>private, no-store</code>; join JSON <code>no-store</code>; inline lesson assets <code>private, max-age=60</code> Django/views Keep category-based values as implemented <code>Pragma</code> Sensitive view responses <code>no-cache</code> on no-store JSON/download responses Django/views Keep as compatibility fallback <code>Strict-Transport-Security</code> Caddy domain templates <code>max-age=${CADDY_HSTS_MAX_AGE}</code> Caddy Keep edge-owned"},{"location":"SECURITY_BASELINE/#conflict-resolution-notes","title":"Conflict Resolution Notes","text":"<ul> <li>Framing conflict resolved: no contradictory <code>DENY</code> fallback against CSP <code>'self'</code>.</li> <li>Caddy no longer sets app-layer policy headers (<code>CSP</code>, <code>Permissions-Policy</code>, <code>Referrer-Policy</code>, <code>X-Frame-Options</code>), preventing split ownership drift.</li> </ul>"},{"location":"START_HERE/","title":"Start Here","text":""},{"location":"START_HERE/#summary","title":"Summary","text":"<p>This is the canonical docs landing page. Use it to pick the shortest path for your role.</p> <p>Evaluating whether this fits your org? Start with PUBLIC_OVERVIEW.md.</p>"},{"location":"START_HERE/#what-to-do-now","title":"What to do now","text":"<ol> <li>Pick your role from the table below.</li> <li>Open only the listed starting pages.</li> <li>Use the common URLs/commands section once the stack is running.</li> </ol>"},{"location":"START_HERE/#verification-signal","title":"Verification signal","text":"<p>You should be able to pick a role path in under 30 seconds and identify the exact next doc to open.</p> <pre><code>flowchart TD\n  A[Start Here] --&gt; B{Your role}\n  B --&gt;|Evaluator| C[PUBLIC_OVERVIEW]\n  C --&gt; D[TRY_IT_LOCAL]\n  B --&gt;|Teacher/Staff| E[NON_DEVELOPER_GUIDE]\n  E --&gt; F[TEACHER_PORTAL]\n  B --&gt;|Operator/Admin| G[DAY1_DEPLOY_CHECKLIST]\n  G --&gt; H[SECURITY + RUNBOOK]\n  B --&gt;|Developer| I[DEVELOPMENT]\n  I --&gt; J[ARCHITECTURE + DECISIONS]</code></pre>"},{"location":"START_HERE/#quick-picks-by-role","title":"Quick picks (by role)","text":"Role Start here Then read Evaluator / decision-maker PUBLIC_OVERVIEW.md TRY_IT_LOCAL.md, SECURITY.md Teacher / school staff NON_DEVELOPER_GUIDE.md TEACHER_PORTAL.md Operator / admin DAY1_DEPLOY_CHECKLIST.md SECURITY.md, RUNBOOK.md, TROUBLESHOOTING.md Developer DEVELOPMENT.md ARCHITECTURE.md, DECISIONS.md"},{"location":"START_HERE/#core-docs-map","title":"Core docs map","text":""},{"location":"START_HERE/#classroom-use","title":"Classroom use","text":"<ul> <li>NON_DEVELOPER_GUIDE.md</li> <li>TEACHER_PORTAL.md</li> <li>COURSE_AUTHORING.md</li> <li>TEACHER_HANDOFF_CHECKLIST.md</li> </ul>"},{"location":"START_HERE/#operations","title":"Operations","text":"<ul> <li>DAY1_DEPLOY_CHECKLIST.md</li> <li>SECURITY.md (public-domain posture and reporting)</li> <li>PRIVACY-ADDENDUM.md (field-level data lifecycle + deletion controls)</li> <li>SECURITY_BASELINE.md (edge vs app ownership)</li> <li>RUNBOOK.md</li> <li>TROUBLESHOOTING.md</li> <li>DISASTER_RECOVERY.md</li> </ul>"},{"location":"START_HERE/#engineering","title":"Engineering","text":"<ul> <li>DEVELOPMENT.md</li> <li>ARCHITECTURE.md</li> <li>OPENAI_HELPER.md</li> <li>HELPER_POLICY.md</li> <li>REQUEST_SAFETY.md</li> <li>HELPER_EVALS.md</li> </ul>"},{"location":"START_HERE/#design-rationale","title":"Design rationale","text":"<ul> <li>DECISIONS.md</li> <li>decisions/archive/2026-02.md</li> </ul>"},{"location":"START_HERE/#common-urls","title":"Common URLs","text":"<ul> <li>Student join: <code>/</code></li> <li>Student class view: <code>/student</code></li> <li>Teacher portal: <code>/teach</code></li> <li>Admin login: <code>/admin/login/</code></li> <li>Edge health: <code>/healthz</code></li> <li>Class Hub upstream health: <code>/upstream-healthz</code></li> <li>Helper health: <code>/helper/healthz</code></li> </ul>"},{"location":"START_HERE/#common-commands","title":"Common commands","text":"<ul> <li>Local demo path: TRY_IT_LOCAL.md</li> <li>Full health check: <code>bash scripts/system_doctor.sh</code></li> <li>Guardrailed deploy: <code>bash scripts/deploy_with_smoke.sh</code></li> </ul>"},{"location":"START_HERE/#if-you-are-overwhelmed","title":"If you are overwhelmed","text":"<p>Read one page only: - Evaluator: PUBLIC_OVERVIEW.md - Teacher/staff: NON_DEVELOPER_GUIDE.md - Operator: RUNBOOK.md - Developer: DEVELOPMENT.md</p>"},{"location":"TEACHER_HANDOFF_CHECKLIST/","title":"Teacher Handoff Checklist","text":"<p>Use this checklist when teacher staffing changes (new teacher, replacement, or role change).</p>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#1-prep","title":"1) Prep","text":"<ul> <li>Confirm you have admin access (<code>createsuperuser</code> account or equivalent).</li> <li>Confirm stack is running:</li> </ul> <pre><code>cd /srv/lms/compose\ndocker compose up -d\n</code></pre>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#2-create-the-incoming-teacher-account","title":"2) Create the incoming teacher account","text":"<pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username new_teacher \\\n  --email new_teacher@example.org \\\n  --password TEMP_PASSWORD\n</code></pre> <p>Notes: - Default behavior creates <code>is_staff=True</code>, <code>is_superuser=False</code>. - This is preferred for daily teaching access.</p>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#3-verify-access-with-the-incoming-teacher","title":"3) Verify access with the incoming teacher","text":"<ul> <li>Sign in via <code>/admin/login/</code>.</li> <li>Confirm they can open:</li> <li><code>/teach</code></li> <li><code>/teach/lessons</code></li> <li>Confirm they can open at least one class and submission queue.</li> </ul>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#4-rotate-password-after-handoff","title":"4) Rotate password after handoff","text":"<pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username new_teacher \\\n  --password FINAL_PASSWORD \\\n  --update\n</code></pre>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#5-offboard-old-teacher-account","title":"5) Offboard old teacher account","text":"<p>Disable old account (recommended instead of deleting):</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username old_teacher \\\n  --inactive \\\n  --update\n</code></pre>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#6-optional-role-changes","title":"6) Optional role changes","text":"<p>Promote to superuser only when needed:</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username new_teacher \\\n  --superuser \\\n  --update\n</code></pre> <p>Demote from superuser:</p> <pre><code>cd /srv/lms/compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username new_teacher \\\n  --no-superuser \\\n  --update\n</code></pre>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#7-recordkeeping","title":"7) Recordkeeping","text":"<ul> <li>Note who was onboarded/offboarded and when.</li> <li>Confirm old account can no longer log in.</li> <li>Store new credentials in your password manager.</li> </ul>"},{"location":"TEACHER_HANDOFF_CHECKLIST/#quick-links","title":"Quick links","text":"<ul> <li>Teacher account guide: TEACHER_PORTAL.md</li> <li>Command cookbook script: <code>scripts/examples/teacher_accounts.sh</code></li> <li>Handoff record template: TEACHER_HANDOFF_RECORD_TEMPLATE.md</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/","title":"Teacher Handoff Record (Template)","text":"<p>Use this record each time teacher access changes.</p>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#metadata","title":"Metadata","text":"<ul> <li>Date:</li> <li>Environment: (production / staging / local)</li> <li>Completed by:</li> <li>Reviewed by:</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#incoming-teacher","title":"Incoming teacher","text":"<ul> <li>Username:</li> <li>Email:</li> <li>Account created: (yes/no)</li> <li>Staff access verified at <code>/teach</code>: (yes/no)</li> <li>Lesson tracker verified at <code>/teach/lessons</code>: (yes/no)</li> <li>Final password rotated after handoff: (yes/no)</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#outgoing-teacher","title":"Outgoing teacher","text":"<ul> <li>Username:</li> <li>Account disabled (<code>--inactive --update</code>): (yes/no)</li> <li>Last access check completed: (yes/no)</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#privilege-checks","title":"Privilege checks","text":"<ul> <li>Incoming teacher is non-superuser for daily use: (yes/no)</li> <li>Any superuser changes made: (yes/no)</li> <li>If yes, reason + approver:</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#notes","title":"Notes","text":"<ul> <li>Classes affected:</li> <li>Issues encountered:</li> <li>Follow-up items:</li> </ul>"},{"location":"TEACHER_HANDOFF_RECORD_TEMPLATE/#command-log-optional","title":"Command log (optional)","text":"<pre><code># Paste executed commands here for traceability.\n</code></pre>"},{"location":"TEACHER_PORTAL/","title":"Teacher Portal + Accounts","text":"<p>This guide covers: - creating teacher accounts - accessing the teacher portal - common day-to-day workflows</p> <pre><code>flowchart TD\n  A[Superuser creates teacher] --&gt; B[Invite link: /teach/2fa/setup]\n  B --&gt; C[Teacher enrolls OTP]\n  C --&gt; D[Teacher opens /teach]\n  D --&gt; E[Lesson tracker + class dashboard]\n  E --&gt; F[Review uploads / manage releases]</code></pre>"},{"location":"TEACHER_PORTAL/#access-model","title":"Access model","text":"<ul> <li>Student access: class code + display name.</li> <li>Teacher portal: staff-only (<code>is_staff=True</code>) Django users.</li> <li>Django admin: usually superusers (<code>is_superuser=True</code>).</li> </ul> <p>Use superusers for setup and operations. Use staff (non-superuser) for daily teaching.</p>"},{"location":"TEACHER_PORTAL/#create-teacher-accounts","title":"Create teacher accounts","text":"<p>Prerequisite: stack is running.</p> <pre><code>cd compose\ndocker compose up -d\n</code></pre> <p>Create first admin (if needed):</p> <pre><code>cd compose\ndocker compose exec classhub_web python manage.py createsuperuser\n</code></pre> <p>Create a staff teacher account:</p> <pre><code>cd compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher1 \\\n  --email teacher1@example.org \\\n  --password CHANGE_ME\n</code></pre> <p>Or create teacher accounts from the teacher portal (<code>/teach</code>) as a superuser:</p> <ul> <li>Fill in username, name, email, and a starting password.</li> <li>Submit <code>Create teacher + send invite</code>.</li> <li>The invite email includes a one-click <code>/teach/2fa/setup?token=...</code> link where the teacher scans a QR and confirms a 6-digit OTP code.</li> <li>Optional checkbox: include temporary password in email (off by default).</li> </ul> <p>Reset a teacher password:</p> <pre><code>cd compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher1 \\\n  --password NEW_PASSWORD \\\n  --update\n</code></pre> <p>Disable teacher access without deleting account:</p> <pre><code>cd compose\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher1 \\\n  --inactive \\\n  --update\n</code></pre> <p>Useful flags: - <code>--update</code>: required when modifying an existing teacher. - <code>--clear-email</code>: clear existing email on update. - <code>--superuser</code> / <code>--no-superuser</code>: elevate or remove admin-level access. - <code>--active</code> / <code>--inactive</code>: explicitly control account state.</p>"},{"location":"TEACHER_PORTAL/#example-script","title":"Example script","text":"<p>A runnable command cookbook is provided at:</p> <ul> <li><code>scripts/examples/teacher_accounts.sh</code></li> </ul> <p>By default it prints commands only (dry-run). Execute for real:</p> <pre><code>RUN=1 bash scripts/examples/teacher_accounts.sh\n</code></pre> <p>Use production compose mode:</p> <pre><code>COMPOSE_MODE=prod RUN=1 bash scripts/examples/teacher_accounts.sh\n</code></pre> <p>Customize values when running the example script:</p> <pre><code>USERNAME=teacher2 \\\nEMAIL=teacher2@example.org \\\nPASSWORD=TEMP_PASSWORD \\\nNEW_PASSWORD=FINAL_PASSWORD \\\nRUN=1 \\\nbash scripts/examples/teacher_accounts.sh\n</code></pre>"},{"location":"TEACHER_PORTAL/#changing-personnel-new-or-different-teachers","title":"Changing personnel (new or different teachers)","text":"<p>Current behavior: any staff user can access any class in <code>/teach</code>. We do not yet have per-class teacher assignment/ownership.</p> <p>When a new person joins:</p> <ol> <li>Create a new staff account.</li> <li>Ask them to sign in and verify <code>/teach</code> + <code>/teach/lessons</code>.</li> <li>Keep old account active briefly during transition, then disable it.</li> </ol> <p>Commands:</p> <pre><code># 1) onboard new teacher\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher2 \\\n  --email teacher2@example.org \\\n  --password TEMP_PASSWORD\n\n# 2) rotate their password after first login or handoff\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher2 \\\n  --password FINAL_PASSWORD \\\n  --update\n\n# 3) offboard previous teacher account\ndocker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher1 \\\n  --inactive \\\n  --update\n</code></pre> <p>If contact info changes (same person, new email):</p> <pre><code>docker compose exec classhub_web python manage.py create_teacher \\\n  --username teacher2 \\\n  --email teacher2@newschool.org \\\n  --update\n</code></pre> <p>If login username should change, create a new account with the new username and disable the old account after handoff.</p> <p>Operational checklist: TEACHER_HANDOFF_CHECKLIST.md.</p>"},{"location":"TEACHER_PORTAL/#teacher-portal-routes","title":"Teacher portal routes","text":"<ul> <li><code>/teach</code>:</li> <li>class list</li> <li>one-click <code>Copy</code> for class join codes</li> <li>superuser-only teacher onboarding card (create account + send 2FA invite email)</li> <li>create class</li> <li>generate authoring templates (<code>.md</code> + <code>.docx</code>) by setting:<ul> <li><code>course slug</code></li> <li><code>course title</code></li> <li><code>sessions</code></li> <li><code>session duration (minutes)</code></li> </ul> </li> <li>download generated template files directly from the same card (per slug)</li> <li>recent submissions queue</li> <li><code>/teach/lessons</code>:</li> <li>lesson tracker grouped by class</li> <li>per-dropbox quick actions: <code>All</code>, <code>Missing</code>, <code>ZIP latest</code></li> <li>row shortcut: <code>Review missing now</code></li> <li>row shortcut: <code>Manage videos</code></li> <li><code>/teach/videos</code>:</li> <li>select course + lesson</li> <li>upload video file or add video URL</li> <li>bulk-upload multiple files in one action</li> <li>order videos for lesson playback</li> <li>publish/unpublish videos (draft visibility)</li> <li>remove lesson-tagged videos</li> <li><code>/teach/assets</code>:</li> <li>create reusable folder paths for reference files</li> <li>upload docs/images/PDFs and optionally tag by <code>course_slug</code> + <code>lesson_slug</code></li> <li>publish/hide/delete assets</li> <li>copy markdown-ready link snippets like <code>[GPIO map](/lesson-asset/12/download)</code></li> <li><code>/teach/class/&lt;id&gt;</code>:</li> <li>lesson tracker for one class</li> <li>module/material editor</li> <li><code>Copy</code> join code</li> <li><code>Printable join card</code> shortcut for in-room posting</li> <li>inline student rename controls</li> <li>roster reset action (clears student identities + submissions, invalidates active student sessions, optional join-code rotation)</li> <li><code>/teach/class/&lt;id&gt;/join-card</code>:</li> <li>print-friendly join instructions + class code</li> <li>prefilled join URL (<code>/?class_code=&lt;JOIN_CODE&gt;</code>)</li> <li><code>/teach/material/&lt;id&gt;/submissions</code>:</li> <li>submitted vs missing filters</li> <li>bulk download latest submissions as ZIP</li> <li><code>/teach/2fa/setup</code>:</li> <li>teacher self-service TOTP enrollment</li> <li>supports signed invite links from onboarding emails</li> <li>invite links are one-time use and expire after <code>TEACHER_2FA_INVITE_MAX_AGE_SECONDS</code> (default 24h)</li> <li>shows QR + manual secret and verifies one-time code</li> </ul>"},{"location":"TEACHER_PORTAL/#common-workflow","title":"Common workflow","text":"<ol> <li>Sign in at <code>/admin/login/</code> with a staff or superuser account.</li> <li>Open <code>/teach</code>.</li> <li>Open <code>Lessons</code> for the target class.</li> <li>Use <code>Manage videos</code> on a lesson row to add/update that lesson's video list.</li> <li>Use <code>Review missing now</code> to jump to students who still owe uploads.</li> <li>Use <code>ZIP latest</code> for batch review/download.</li> </ol>"},{"location":"TEACHER_PORTAL/#lesson-video-workflow","title":"Lesson video workflow","text":"<p>Use <code>/teach/videos</code> to tag media directly to <code>course_slug + lesson_slug</code>.</p> <ol> <li>Pick a course and lesson from the selectors.</li> <li>Add a title (+ optional minutes/outcome).</li> <li>Choose one source:</li> <li><code>Video URL</code> (self-hosted MP4/HLS or YouTube URL), or</li> <li><code>Upload video file</code> (stored as a private lesson asset).</li> <li>Save, then use <code>\u2191</code> / <code>\u2193</code> to set playback order.</li> <li>Use <code>Publish</code> / <code>Unpublish</code> to control whether students can see each video.</li> <li>Use <code>Bulk upload files</code> when adding many lesson clips at once (titles auto-generate from filenames).</li> </ol> <p>Large file note: - Upload request size is controlled by <code>CLASSHUB_UPLOAD_MAX_MB</code> (default <code>600</code>) in compose env. - Upload request timeout is controlled by <code>CLASSHUB_GUNICORN_TIMEOUT_SECONDS</code> (default <code>1200</code>). - After changing <code>.env</code>, restart <code>classhub_web</code> to apply.</p> <p>Lesson behavior: - Student lesson page video panels are collapsed by default. - Clicking a video heading opens that panel. - Opening a different heading closes the previous panel. - Uploaded files stream via <code>/lesson-video/&lt;id&gt;/stream</code> with permission checks. - Draft videos are hidden from students until published.</p>"},{"location":"TEACHER_PORTAL/#lesson-asset-workflow","title":"Lesson asset workflow","text":"<p>Use <code>/teach/assets</code> when a lesson needs reference files (for example GPIO maps or printable guides).</p> <ol> <li>Create a folder path (example: <code>piper-kits/gpio</code>).</li> <li>Upload one or more files into that folder.</li> <li>Keep <code>Publish immediately</code> checked when students should access the file now.</li> <li>Copy the generated snippet and paste it into lesson markdown or a text material:</li> <li><code>[GPIO map](/lesson-asset/&lt;asset_id&gt;/download)</code></li> <li>Use <code>Hide</code> to remove student access without deleting the file.</li> </ol>"},{"location":"TEACHER_PORTAL/#troubleshooting","title":"Troubleshooting","text":"<ul> <li>Invite emails not sending from <code>/teach</code>:</li> <li>set SMTP env values (<code>DJANGO_EMAIL_BACKEND</code>, <code>DJANGO_EMAIL_HOST</code>, <code>DJANGO_EMAIL_HOST_USER</code>, <code>DJANGO_EMAIL_HOST_PASSWORD</code>, etc.)</li> <li>restart <code>classhub_web</code> after env changes</li> <li> <p>for local verification only, keep <code>DJANGO_EMAIL_BACKEND=django.core.mail.backends.console.EmailBackend</code> and inspect container logs</p> </li> <li> <p>Redirect to <code>/admin/login/</code> when opening <code>/teach</code>:</p> </li> <li>account is not authenticated, or</li> <li>account does not have <code>is_staff=True</code>.</li> <li>Teacher can open <code>/teach</code> but should not have admin access:</li> <li>ensure <code>is_superuser=False</code>.</li> <li>No lesson rows in tracker:</li> <li>class modules may not include lesson links in <code>/course/&lt;course&gt;/&lt;lesson&gt;</code> format.</li> </ul>"},{"location":"TEACHING_PLAYBOOK/","title":"Teaching Playbook","text":"<p>This repository is intended to be both: - an operating system for classroom delivery - a teaching artifact for new maintainers</p> <p>This playbook defines how to write documentation that teaches, not just records.</p>"},{"location":"TEACHING_PLAYBOOK/#teaching-objective","title":"Teaching objective","text":"<p>Every meaningful change should help a reader answer:</p> <ol> <li>What changed?</li> <li>Why did we choose this design?</li> <li>How do I operate it safely?</li> <li>How do I detect and recover from failure?</li> </ol> <p>If docs only answer (1), they are notes. If docs answer all four, they are curriculum.</p>"},{"location":"TEACHING_PLAYBOOK/#audience-model","title":"Audience model","text":"<p>Write for three audiences in this order:</p> <ol> <li>On-call operator:</li> <li>needs short, reliable actions under pressure.</li> <li>New developer:</li> <li>needs architecture boundaries and decision logic.</li> <li>Future maintainer:</li> <li>needs enough context to refactor safely months later.</li> </ol> <p>When these needs conflict, favor operational clarity first.</p>"},{"location":"TEACHING_PLAYBOOK/#documentation-packet-per-feature","title":"Documentation packet per feature","text":"<p>For each non-trivial feature, ship a documentation packet:</p> <ol> <li>Architecture note:</li> <li>where the boundary moved (service, route, model, auth surface).</li> <li>Decision note:</li> <li>why this choice was made and what was rejected.</li> <li>Operator procedure:</li> <li>exact commands and expected outputs.</li> <li>Verification:</li> <li>tests, smoke checks, and one manual scenario.</li> <li>Failure mode:</li> <li>most likely break and first recovery action.</li> </ol> <p>Where each part should live: - architecture note: ARCHITECTURE.md or WHAT_WHERE_WHY.md - decision note: DECISIONS.md - operator procedure: RUNBOOK.md or TROUBLESHOOTING.md - verification: MERGE_READINESS.md and test commands in context docs - failure mode: TROUBLESHOOTING.md</p>"},{"location":"TEACHING_PLAYBOOK/#writing-style-contract","title":"Writing style contract","text":"<p>Use these rules for all teaching docs:</p> <ol> <li>Lead with intent:</li> <li>first line should say what problem this page helps solve.</li> <li>Name invariants:</li> <li>state what must remain true even as implementation changes.</li> <li>Show complete commands:</li> <li>include working directory and executable command.</li> <li>Show expected signals:</li> <li>include what \"healthy\" looks like.</li> <li>Add one anti-example:</li> <li>show a common wrong assumption and correction.</li> </ol>"},{"location":"TEACHING_PLAYBOOK/#example-packet-helper-scope-token-hardening","title":"Example packet: Helper scope token hardening","text":"<p>Change summary: - Class Hub signs helper scope metadata. - Helper verifies signature server-side. - Student requests without valid token are denied.</p> <p>Boundary moved: - trust moved from client-provided JSON fields to signed server token.</p> <p>Decision rationale: - students can tamper with browser requests, so unsigned scope is not trusted.</p> <p>Operational impact: - missing/invalid token events are expected logs in negative tests.</p> <p>Verification: <pre><code>cd /srv/lms/app/compose\ndocker compose up -d --build helper_web\ndocker compose exec -T helper_web python manage.py test tutor.tests.HelperChatAuthTests\n</code></pre></p> <p>Failure mode and recovery: - symptom: repeated <code>current transaction is aborted</code> during helper tests. - first action: validate helper event writes are best-effort and do not poison   transaction state; then rerun helper test suite. - reference: TROUBLESHOOTING.md.</p>"},{"location":"TEACHING_PLAYBOOK/#example-packet-dependency-security-upgrades","title":"Example packet: Dependency security upgrades","text":"<p>Change summary: - dependency scan flags vulnerable package versions in CI.</p> <p>Boundary moved: - minimum safe dependency version became part of release criteria.</p> <p>Decision rationale: - predictable security posture is easier than ad-hoc emergency patching.</p> <p>Operational impact: - pull requests can fail on <code>pip-audit</code> even when functional tests pass.</p> <p>Verification: <pre><code>cd /srv/lms/app\npip-audit -r services/classhub/requirements.txt --progress-spinner off\n</code></pre></p> <p>Recovery pattern: 1. bump dependency in pinned requirements. 2. rebuild image. 3. rerun service tests and security scan. 4. update docs if behavior changed across versions.</p>"},{"location":"TEACHING_PLAYBOOK/#anti-patterns-to-avoid","title":"Anti-patterns to avoid","text":"<ol> <li>\"Works on my machine\" steps:</li> <li>missing <code>cd</code> context and environment assumptions.</li> <li>Explanation-only docs:</li> <li>no executable commands or verification.</li> <li>Procedure-only docs:</li> <li>no rationale, so future refactors regress intent.</li> <li>Hidden failure cases:</li> <li>no mention of likely breakpoints.</li> <li>Orphan docs:</li> <li>page not linked from START_HERE.md or index.md.</li> </ol>"},{"location":"TEACHING_PLAYBOOK/#maintainer-review-ritual","title":"Maintainer review ritual","text":"<p>Before merging:</p> <ol> <li>Run through modified docs as if you were new to the repo.</li> <li>Copy/paste each new command in a clean shell context.</li> <li>Confirm one \"what\", one \"why\", one \"how\", and one \"verify\" statement exists.</li> <li>Ensure at least one failure mode is documented for each new operational flow.</li> <li>Link the change from a navigational page:</li> <li>START_HERE.md for pathing</li> <li>index.md for policy/contract</li> </ol>"},{"location":"TEACHING_PLAYBOOK/#change-log-discipline","title":"Change log discipline","text":"<p>If the change modifies behavior or operational posture:</p> <ol> <li>add/update entry in DECISIONS.md.</li> <li>archive superseded details in <code>docs/decisions/archive/</code> when needed.</li> <li>keep active decisions concise and linked to the deeper procedure docs.</li> </ol>"},{"location":"TROUBLESHOOTING/","title":"Troubleshooting Guide","text":"<p>Use this page when something is broken right now.</p> <p>Flow:</p> <ol> <li>confirm failure once</li> <li>capture logs</li> <li>classify symptom</li> <li>apply smallest reversible fix</li> </ol> <pre><code>flowchart TD\n  A[Incident] --&gt; B[system_doctor --smoke-mode basic]\n  B --&gt; C{First failing step}\n  C --&gt;|healthz/helper| D[Check container health + logs]\n  C --&gt;|TLS/domain| E[Check Caddy template + DNS]\n  C --&gt;|auth/teach| F[Check teacher/admin session + OTP]\n  C --&gt;|helper backend| G[Check Ollama/OpenAI config]\n  D --&gt; H[Apply smallest fix]\n  E --&gt; H\n  F --&gt; H\n  G --&gt; H</code></pre>"},{"location":"TROUBLESHOOTING/#3-minute-baseline","title":"3-minute baseline","text":"<pre><code>cd /srv/lms/app\nbash scripts/system_doctor.sh --smoke-mode basic\n</code></pre> <p>If this fails early, fix the first failing step before changing anything else.</p>"},{"location":"TROUBLESHOOTING/#fast-triage-commands","title":"Fast triage commands","text":"<pre><code>cd /srv/lms/app/compose\ndocker compose ps\ncurl -I http://localhost/healthz\ncurl -I http://localhost/upstream-healthz\ncurl -I http://localhost/helper/healthz\ndocker compose logs --tail=200 classhub_web helper_web caddy\n</code></pre>"},{"location":"TROUBLESHOOTING/#symptom-index","title":"Symptom index","text":"Symptom Check first Most likely area Site not loading over HTTPS Caddy logs + <code>.env</code> domain/template Edge routing/TLS <code>/helper/chat</code> failing (502 / <code>ollama_error</code>) <code>helper_web</code> logs + Ollama tags Helper backend/model Teacher login smoke fails smoke credentials + login response path Auth/config mismatch Container unhealthy/restarting service logs + DB auth Boot/runtime dependency Helper returns policy redirect unexpectedly topic filter mode + scope context Policy config Admin blocked by OTP admin device enrollment Auth hardening Content missing after reset/rebuild class/module records Data reset/reseed"},{"location":"TROUBLESHOOTING/#symptom-site-does-not-load-over-https","title":"Symptom: site does not load over HTTPS","text":"<p>Common causes:</p> <ul> <li>wrong Caddy template mounted</li> <li>wrong <code>DOMAIN</code></li> <li>ACME/DNS mismatch</li> </ul> <p>Checks:</p> <pre><code>cd /srv/lms/app/compose\ndocker inspect classhub_caddy --format '{{range .Mounts}}{{println .Source \"-&gt;\" .Destination}}{{end}}'\ndocker compose logs --tail=200 caddy\ngrep -E '^(CADDYFILE_TEMPLATE|DOMAIN)=' .env\n</code></pre> <p>Look for:</p> <ul> <li>expected template (<code>Caddyfile.domain</code> or <code>Caddyfile.domain.assets</code> for public TLS)</li> <li>correct domain in logs and <code>.env</code></li> <li>ACME identifier/certificate errors</li> </ul>"},{"location":"TROUBLESHOOTING/#symptom-helperchat-fails-with-502-or-ollama_error","title":"Symptom: <code>/helper/chat</code> fails with 502 or <code>ollama_error</code>","text":"<p>Common causes:</p> <ul> <li>Ollama not ready</li> <li>model not pulled</li> <li><code>OLLAMA_BASE_URL</code> mismatch</li> <li>helper worker timeout too strict for retry budget</li> </ul> <p>Checks:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose logs --tail=200 helper_web\ndocker compose logs --tail=200 classhub_ollama\ncurl http://localhost:11434/api/tags\ndocker compose exec -T helper_web env | grep -E '^(OLLAMA_BASE_URL|OLLAMA_MODEL|OLLAMA_TIMEOUT_SECONDS|HELPER_LLM_BACKEND|HELPER_GUNICORN_TIMEOUT_SECONDS|HELPER_BACKEND_MAX_ATTEMPTS|HELPER_QUEUE_MAX_WAIT_SECONDS|HELPER_BACKOFF_SECONDS)='\n</code></pre> <p>Fix pattern:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec ollama ollama pull llama3.2:1b\n# Keep helper timeout above queue+retry budget (env-check enforces this).\n# Fast safe defaults for deploy smoke:\n# HELPER_GUNICORN_TIMEOUT_SECONDS=180\n# OLLAMA_TIMEOUT_SECONDS=20\n# HELPER_BACKEND_MAX_ATTEMPTS=1\ndocker compose up -d helper_web\n</code></pre> <p>If using non-compose Ollama, ensure <code>OLLAMA_BASE_URL</code> points to a host reachable from containers.</p>"},{"location":"TROUBLESHOOTING/#symptom-smoke-says-teacher-login-failed","title":"Symptom: smoke says teacher login failed","text":"<p>Example failure signal: <code>teacher login returned 200</code>.</p> <p>Common causes:</p> <ul> <li>smoke credentials not present or stale</li> <li>login route returns form again instead of redirect/session success</li> <li>CSRF/host/cookie settings drift</li> </ul> <p>Checks:</p> <pre><code>cd /srv/lms/app/compose\ngrep -E '^(SMOKE_|DJANGO_ALLOWED_HOSTS|CSRF_TRUSTED_ORIGINS)=' .env\ndocker compose logs --tail=200 classhub_web\n</code></pre> <p>Then re-run strict smoke:</p> <pre><code>cd /srv/lms/app\nbash scripts/smoke_check.sh --strict\n</code></pre>"},{"location":"TROUBLESHOOTING/#symptom-helper-or-classhub-container-unhealthyrestarting","title":"Symptom: helper or classhub container unhealthy/restarting","text":"<p>Common causes:</p> <ul> <li>DB credential mismatch</li> <li>migration/import-time failure</li> <li>route/view symbol mismatch after partial deploy</li> </ul> <p>Checks:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose ps -a\ndocker compose logs --tail=200 helper_web\ndocker compose logs --tail=200 classhub_web\n</code></pre> <p>Look for:</p> <ul> <li><code>password authentication failed</code></li> <li>migration errors</li> <li>import/attribute errors</li> </ul>"},{"location":"TROUBLESHOOTING/#symptom-helper-tests-fail-with-current-transaction-is-aborted","title":"Symptom: helper tests fail with <code>current transaction is aborted</code>","text":"<p>Common cause:</p> <ul> <li>helper best-effort classhub table access in environments missing classhub tables</li> </ul> <p>Recovery:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose up -d --build helper_web\ndocker compose exec -T helper_web python manage.py test tutor.tests.HelperChatAuthTests\ndocker compose exec -T helper_web python manage.py test tutor.tests\n</code></pre> <p>Interpretation:</p> <ul> <li>warning logs about missing classhub tables can be expected</li> <li>hard failure is persistent transaction-aborted state on later queries</li> </ul>"},{"location":"TROUBLESHOOTING/#symptom-teacher-invite-email-fails","title":"Symptom: teacher invite email fails","text":"<p>Common causes:</p> <ul> <li>SMTP host typo</li> <li>DNS failure in container</li> <li>provider SMTP AUTH policy restrictions</li> </ul> <p>Checks:</p> <pre><code>cd /srv/lms/app/compose\ngrep -nE '^(DJANGO_EMAIL_|TEACHER_INVITE_FROM_EMAIL)=' .env\ndocker compose exec -T classhub_web env | grep -E '^(DJANGO_EMAIL_|TEACHER_INVITE_FROM_EMAIL)'\ndocker compose exec -T classhub_web python - &lt;&lt;'PY'\nimport os, socket\nhost = os.getenv(\"DJANGO_EMAIL_HOST\",\"\")\nprint(\"HOST:\", host)\nprint(\"DNS:\", socket.gethostbyname(host))\nPY\n</code></pre> <p>Office 365 baseline:</p> <ul> <li>host <code>smtp.office365.com</code></li> <li>port <code>587</code></li> <li><code>DJANGO_EMAIL_USE_TLS=1</code></li> </ul>"},{"location":"TROUBLESHOOTING/#symptom-helper-returns-policy-redirect-instead-of-answer","title":"Symptom: helper returns policy redirect instead of answer","text":"<p>Common cause:</p> <ul> <li>strict topic filtering and prompt outside allowed scope</li> </ul> <p>Check:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec -T helper_web env | grep -E '^HELPER_TOPIC_FILTER_MODE='\n</code></pre> <p>Behavior:</p> <ul> <li><code>strict</code> intentionally short-circuits out-of-scope prompts</li> <li><code>soft</code> is less restrictive</li> </ul>"},{"location":"TROUBLESHOOTING/#symptom-admin-login-blocked-by-otp-requirement","title":"Symptom: admin login blocked by OTP requirement","text":"<p>Cause:</p> <ul> <li>admin 2FA enforced with no enrolled device</li> </ul> <p>Fix:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose exec classhub_web python manage.py bootstrap_admin_otp --username &lt;admin_username&gt; --with-static-backup\n</code></pre> <p>If no superuser exists:</p> <pre><code>docker compose exec classhub_web python manage.py createsuperuser\n</code></pre>"},{"location":"TROUBLESHOOTING/#symptom-teach-redirects-to-teach2fasetup","title":"Symptom: <code>/teach</code> redirects to <code>/teach/2fa/setup</code>","text":"<p>Cause:</p> <ul> <li>staff account is authenticated but not OTP-verified</li> <li><code>DJANGO_TEACHER_2FA_REQUIRED=1</code> is enabled (default)</li> </ul> <p>Fix:</p> <ol> <li>Complete setup at <code>/teach/2fa/setup</code> for that account.</li> <li>If the account has no device yet, enroll one with the QR/manual secret flow.</li> <li>If this is temporary bootstrap only, set <code>DJANGO_TEACHER_2FA_REQUIRED=0</code>, restart, then re-enable after enrollment.</li> </ol>"},{"location":"TROUBLESHOOTING/#symptom-class-content-disappeared-after-rebuildreset","title":"Symptom: class content disappeared after rebuild/reset","text":"<p>Cause:</p> <ul> <li>DB or volume reset removed class/module/material records</li> </ul> <p>Recovery:</p> <pre><code>cd /srv/lms/app\nscripts/rebuild_coursepack.sh --course-slug piper_scratch_12_session --create-class\n</code></pre> <p>Then verify in <code>/teach</code> and <code>/student</code>.</p>"},{"location":"TROUBLESHOOTING/#symptom-ci-dependency-security-job-fails-pip-audit","title":"Symptom: CI dependency security job fails (<code>pip-audit</code>)","text":"<p>Cause:</p> <ul> <li>pinned package below a fixed advisory version</li> </ul> <p>Fix pattern:</p> <ol> <li>bump dependency pin</li> <li>rebuild services</li> <li>rerun service tests</li> <li>rerun CI/security workflow</li> </ol> <p>Verification pattern:</p> <pre><code>cd /srv/lms/app/compose\ndocker compose up -d --build classhub_web helper_web\ndocker compose exec -T classhub_web python manage.py test hub.tests hub.tests_services\ndocker compose exec -T helper_web python manage.py test tutor.tests\n</code></pre>"},{"location":"TROUBLESHOOTING/#escalation-criteria","title":"Escalation criteria","text":"<p>Escalate to full incident workflow (DISASTER_RECOVERY.md) when:</p> <ul> <li>health checks fail after restart and config verification</li> <li>migrations fail in production</li> <li>repeated auth failures with no config drift</li> <li>data integrity concerns (missing submissions/classes unexpectedly)</li> </ul>"},{"location":"TROUBLESHOOTING/#anti-patterns-to-avoid","title":"Anti-patterns to avoid","text":"<ol> <li>Rebuilding everything before capturing first-failure logs.</li> <li>Making multiple config changes at once.</li> <li>Ignoring warning logs without classification.</li> <li>Skipping health endpoint checks.</li> </ol>"},{"location":"TRY_IT_LOCAL/","title":"Try It Local (10 Minutes)","text":""},{"location":"TRY_IT_LOCAL/#summary","title":"Summary","text":"<p>This guide gets a local demo running with Docker Compose so you can verify student join, teacher login, and a preloaded demo course.</p>"},{"location":"TRY_IT_LOCAL/#what-to-do-now","title":"What to do now","text":"<ol> <li>Copy env defaults and start the stack.</li> <li>Create your admin account.</li> <li>Load the shipped demo coursepack.</li> <li>Open student + teacher URLs and verify core flows.</li> </ol>"},{"location":"TRY_IT_LOCAL/#verification-signal","title":"Verification signal","text":"<p>At the end, you should be able to: (a) join as a student using a class code, (b) sign in at <code>/admin/login/</code>, and (c) open <code>/teach</code> with a class that contains 2 demo lessons.</p>"},{"location":"TRY_IT_LOCAL/#prerequisites","title":"Prerequisites","text":"<ul> <li>Docker Engine</li> <li>Docker Compose v2</li> </ul> <p>Check:</p> <pre><code>docker --version\ndocker compose version\n</code></pre> <p>Expected: both commands print versions without errors.</p>"},{"location":"TRY_IT_LOCAL/#1-configure-local-demo-env","title":"1) Configure local demo env","text":"<pre><code>cd /srv/lms/app  # or your repo root\ncp compose/.env.example compose/.env\nsed -i.bak 's/^CADDYFILE_TEMPLATE=.*/CADDYFILE_TEMPLATE=Caddyfile.local/' compose/.env\nsed -i.bak 's/^HELPER_LLM_BACKEND=.*/HELPER_LLM_BACKEND=mock/' compose/.env\n</code></pre> <p>Verification signal: <code>compose/.env</code> contains <code>CADDYFILE_TEMPLATE=Caddyfile.local</code> and <code>HELPER_LLM_BACKEND=mock</code>.</p>"},{"location":"TRY_IT_LOCAL/#2-start-containers","title":"2) Start containers","text":"<pre><code>cd compose\ndocker compose up -d --build\n</code></pre> <p>Verification signal:</p> <pre><code>docker compose ps\n</code></pre> <p>Expected: <code>classhub_web</code>, <code>helper_web</code>, <code>postgres</code>, <code>redis</code>, and <code>caddy</code> are up.</p>"},{"location":"TRY_IT_LOCAL/#3-create-first-admin-account","title":"3) Create first admin account","text":"<pre><code>docker compose exec classhub_web python manage.py createsuperuser\n</code></pre> <p>Use your own username/password (do not commit credentials anywhere).</p> <p>Verification signal: command ends without traceback.</p>"},{"location":"TRY_IT_LOCAL/#4-load-demo-coursepack","title":"4) Load demo coursepack","text":"<p>From repo root:</p> <pre><code>cd /srv/lms/app\nbash scripts/load_demo_coursepack.sh\n</code></pre> <p>Expected output includes: - imported course slug <code>demo_classhub_quickstart</code> - a class join code line like <code>DEMO_CLASS_CODE=...</code></p>"},{"location":"TRY_IT_LOCAL/#5-open-demo-urls","title":"5) Open demo URLs","text":"<ul> <li>Student join page: <code>http://localhost/</code></li> <li>Teacher login page: <code>http://localhost/admin/login/</code></li> <li>Teacher portal: <code>http://localhost/teach</code></li> <li>Health checks:</li> <li><code>http://localhost/healthz</code></li> <li><code>http://localhost/helper/healthz</code></li> </ul> <p>Verification signal: - Student join succeeds with the class code printed by <code>load_demo_coursepack.sh</code>. - Teacher login succeeds with your superuser credentials. - <code>/teach</code> shows a class with 2 demo sessions.</p>"},{"location":"TRY_IT_LOCAL/#helper-defaults-for-safe-demo","title":"Helper defaults for safe demo","text":"<ul> <li>This guide sets <code>HELPER_LLM_BACKEND=mock</code> so the helper works without OpenAI keys.</li> <li>You can optionally set a demo response text in <code>compose/.env</code>:</li> </ul> <pre><code>HELPER_MOCK_RESPONSE_TEXT=Let's work one step at a time. What did you try first?\n</code></pre> <p>Verification signal: helper responses return quickly and no external LLM credentials are required.</p>"},{"location":"TRY_IT_LOCAL/#reset-wipe-demo-state","title":"Reset / wipe demo state","text":"<p>From repo root:</p> <pre><code>cd compose\ndocker compose down -v\ncd ..\nrm -rf data/postgres data/minio data/classhub_uploads\n</code></pre> <p>Then repeat steps from the top.</p> <p>Verification signal: a fresh run creates a new empty DB before you load the demo coursepack.</p>"},{"location":"TRY_IT_LOCAL/#safety-note-public-demos","title":"Safety note (public demos)","text":"<ul> <li>Localhost demos are not indexable by search engines.</li> <li>Do not expose a demo stack publicly without access controls.</li> <li>Local Caddy template also sends:</li> <li><code>X-Robots-Tag: noindex, nofollow, noarchive</code></li> <li><code>robots.txt</code> with <code>Disallow: /</code></li> <li>If you run an internet-facing demo, apply operator controls from:</li> <li>SECURITY.md</li> <li>DAY1_DEPLOY_CHECKLIST.md</li> <li>START_HERE.md</li> </ul> <p>Quick check:</p> <pre><code>curl -I http://localhost/ | grep -i x-robots-tag\ncurl -s http://localhost/robots.txt\n</code></pre> <p>If you hit startup issues, use TROUBLESHOOTING.md.</p>"},{"location":"WHAT_WHERE_WHY/","title":"Class Hub + Helper: What / Where / Why (Plain-Language Guide)","text":"<p>This guide is for non-programmer staff who need to run, demo, or support the LMS. For the canonical role-based doc map and URL list, start at START_HERE.md. For guided onboarding labs, use LEARNING_PATHS.md.</p>"},{"location":"WHAT_WHERE_WHY/#what-this-system-is","title":"What this system is","text":"<ul> <li><code>Class Hub</code> is the main LMS site.</li> <li><code>Homework Helper</code> is the AI tutor inside the LMS.</li> <li>Students use class code + display name (no student passwords in MVP).</li> <li>Teachers use staff accounts and open the teacher portal at <code>/teach</code>.</li> <li>Admins use Django admin at <code>/admin/</code>.</li> </ul> <pre><code>flowchart TD\n  U[Student / Teacher / Admin] --&gt; C[Caddy]\n  C --&gt;|/helper/*| H[Homework Helper]\n  C --&gt;|all other routes| W[Class Hub]\n  W --&gt; P[(Postgres)]\n  H --&gt; P\n  W --&gt; R[(Redis)]\n  H --&gt; R</code></pre>"},{"location":"WHAT_WHERE_WHY/#where-to-go","title":"Where to go","text":"<p>Use common route list in START_HERE.md#common-urls. Use role-based docs list in START_HERE.md#quick-picks-by-role.</p>"},{"location":"WHAT_WHERE_WHY/#why-the-system-is-split-this-way","title":"Why the system is split this way","text":"<ul> <li>Helper is a separate service so LMS pages stay available if AI has issues.</li> <li>Caddy routes <code>/helper/*</code> to helper and everything else to class hub.</li> <li>Postgres stores core records, Redis handles limits/queues, MinIO stores files.</li> <li>This design keeps operations simpler and failure boundaries clearer.</li> </ul>"},{"location":"WHAT_WHERE_WHY/#day-of-class-quick-checklist","title":"Day-of-class quick checklist","text":"<ol> <li>Confirm site opens at your domain.</li> <li>Confirm teacher can sign in and open teacher portal.</li> <li>Confirm students can join and reach class view.</li> <li>Confirm helper responds inside lesson/class page.</li> <li>Confirm teacher can see submissions queue.</li> </ol> <p>Detailed operator run steps: RUNBOOK.md</p>"},{"location":"WHAT_WHERE_WHY/#if-something-is-wrong","title":"If something is wrong","text":"<ul> <li>Teacher cannot access <code>/teach</code>:</li> <li>Usually account is not staff or user is not logged in.</li> <li>Ask admin to verify teacher account with <code>create_teacher</code> command.</li> <li>Students cannot join class:</li> <li>Check class code, class lock status, and that class exists.</li> <li>Helper not responding:</li> <li>Check <code>/helper/healthz</code>.</li> <li>Restart <code>helper_web</code> container if needed.</li> <li>Uploads failing:</li> <li>Check teacher dropbox settings and allowed file extensions.</li> </ul>"},{"location":"WHAT_WHERE_WHY/#what-to-read-next","title":"What to read next","text":"<ul> <li>Role-specific paths: START_HERE.md</li> <li>Teacher workflow details: TEACHER_PORTAL.md</li> <li>Operations depth: RUNBOOK.md</li> </ul>"},{"location":"decisions/archive/2026-01/","title":"Decisions Archive \u2014 2026-01","text":"<p>Historical context only. Entries in this file may describe superseded implementations or prior rollout steps.</p>"},{"location":"decisions/archive/2026-01/#2026-01-30-local-dev-override-for-hot-reload","title":"2026-01-30 \u2014 Local dev override for hot reload","text":"<p>Why: - Avoid rebuilds for every template/markdown/Python change. - Faster local iteration while keeping production images stable.</p> <p>Tradeoffs: - Uses Django <code>runserver</code> + <code>DJANGO_DEBUG=1</code> (not production-safe). - Static handling differs from production (<code>collectstatic</code> not required in dev).</p> <p>Plan: - Keep <code>compose/docker-compose.override.yml</code> for local dev only. - Use production build (<code>--build</code>) when deploying or testing prod-like behavior.</p>"},{"location":"decisions/archive/2026-01/#2026-01-30-local-llm-via-ollama-openai-optional","title":"2026-01-30 \u2014 Local LLM via Ollama (OpenAI optional)","text":"<p>Why: - Keep student prompts and responses on our infrastructure. - Predictable cost for a single-course launch. - Allow prompt + RAG iteration without third-party dependencies.</p> <p>Tradeoffs: - We own model quality, safety, and availability. - Hardware constraints (GPU/CPU) can affect latency.</p> <p>Plan: - Default <code>HELPER_LLM_BACKEND=ollama</code>. - Keep an optional OpenAI backend for future fallback. - Add a strictness switch (<code>HELPER_STRICTNESS</code>) to adjust answer policy. - Default to a small model on CPU-only servers; adjust as hardware allows. - Add a Redis-backed concurrency queue to avoid overload on small servers.</p>"},{"location":"decisions/archive/2026-01/#2026-01-16-student-access-is-class-code-display-name","title":"2026-01-16 \u2014 Student access is class-code + display name","text":"<p>Why: - Minimum friction for classrooms. - Minimal PII collection. - Fewer account recovery issues at MVP stage.</p> <p>Tradeoffs: - If a student clears cookies, they \u201close\u201d identity unless we add a return-code.</p> <p>Plan: - MVP uses session cookie only. - Add optional \u201creturn code\u201d later.</p>"},{"location":"decisions/archive/2026-01/#2026-01-16-homework-helper-is-a-separate-service","title":"2026-01-16 \u2014 Homework Helper is a separate service","text":"<p>Why: - Reliability: helper failures do not block class materials. - Safety: independent rate limits and logs. - Clarity: prompt policy lives in one place.</p>"},{"location":"decisions/archive/2026-02/","title":"Decisions Archive \u2014 2026-02","text":"<p>Historical context only. Entries in this file may describe superseded implementations or prior rollout steps.</p>"},{"location":"decisions/archive/2026-02/#2026-02-17-add-append-only-studentevent-stream-for-learner-side-observability","title":"2026-02-17 \u2014 Add append-only <code>StudentEvent</code> stream for learner-side observability","text":"<p>Why: - Class operations need visibility into student join/rejoin/upload behavior and helper usage without inspecting raw content. - Student activity telemetry should be immutable and separate from teacher/admin audit trails.</p> <p>Tradeoffs: - Extra write load from event emission on join/upload/helper access. - Event retention is an explicit operational policy (not auto-deleted unless scheduled).</p> <p>Plan: - Add append-only <code>StudentEvent</code> model with event types:   - <code>class_join</code>   - <code>session_rejoin_device_hint</code>   - <code>session_rejoin_return_code</code>   - <code>submission_upload</code>   - <code>helper_chat_access</code> - Emit from classhub student views and helper chat hook (metadata-only). - Expose filtered read-only event list in Django admin.</p>"},{"location":"decisions/archive/2026-02/#2026-02-17-centralize-request-safety-helpers-in-servicescommonrequest_safety","title":"2026-02-17 \u2014 Centralize request safety helpers in <code>services/common/request_safety</code>","text":"<p>Why: - Client IP parsing and cache-backed burst limiting logic was duplicated in both services. - Divergent implementations increase policy drift risk (proxy behavior, rate-limit semantics).</p> <p>Tradeoffs: - Docker build contexts were widened to include <code>services/common</code>, which can slightly increase build context size. - Local direct runs now rely on a small <code>sys.path</code> bootstrap in <code>manage.py</code>/<code>wsgi.py</code> to import shared modules.</p> <p>Plan: - Add shared helpers for proxy-aware IP parsing, burst/token limiting, and actor-key builders. - Replace duplicated helpers in Class Hub and Homework Helper with shared imports. - Document canonical usage + env knobs in <code>REQUEST_SAFETY.md</code>.</p>"},{"location":"decisions/archive/2026-02/#2026-02-17-add-helper-retrytelemetry-and-classhub-auditretention-controls","title":"2026-02-17 \u2014 Add helper retry/telemetry and classhub audit+retention controls","text":"<p>Why: - Helper traffic will increase and move to GPU-backed inference, so transient backend failures need retries and observable traces. - LMS operations need immutable teacher/staff action logs and an explicit upload-retention enforcement tool.</p> <p>Tradeoffs: - Helper responses now include operational fields (<code>request_id</code>, attempt/timing metadata). - Audit rows add write volume on teacher mutations. - Submission retention is operator-driven via command/scheduling.</p> <p>Plan: - Add helper backend retry controls (<code>HELPER_BACKEND_MAX_ATTEMPTS</code>, <code>HELPER_BACKOFF_SECONDS</code>) and structured event logging. - Add <code>AuditEvent</code> model + admin visibility and emit events on <code>/teach/*</code> mutating actions. - Add <code>manage.py prune_submissions</code> command for retention policy enforcement.</p>"},{"location":"decisions/archive/2026-02/#2026-02-17-add-deploy-guardrails-migration-gate-deterministic-compose-smoke-checks","title":"2026-02-17 \u2014 Add deploy guardrails: migration gate + deterministic compose + smoke checks","text":"<p>Why: - Deployment failures were caused by config drift and hidden runtime assumptions (especially Caddy config source). - We need a repeatable, operator-friendly path that blocks unsafe deploys before users feel them.</p> <p>Tradeoffs: - Deploy requires smoke credentials/class code in environment for strict checks. - <code>deploy_with_smoke.sh</code> uses an optional rollback hook (<code>ROLLBACK_CMD</code>) instead of an automatic git/image rollback policy.</p> <p>Plan: - Add <code>scripts/migration_gate.sh</code> to run <code>makemigrations --check --dry-run</code> in both services. - Add <code>scripts/smoke_check.sh</code> to validate health, student join/helper chat, and teacher login. - Add <code>scripts/deploy_with_smoke.sh</code> to enforce base compose usage and Caddy mount guardrail before/after rollout.</p>"},{"location":"decisions/archive/2026-02/#2026-02-17-split-hubviews-into-package-extract-testable-service-helpers","title":"2026-02-17 \u2014 Split <code>hub.views</code> into package + extract testable service helpers","text":"<p>Why: - <code>hub/views.py</code> grew into a mixed endpoint + business-logic module that was hard to test in isolation. - We need endpoint ownership by concern (student/teacher/content/media) without breaking existing URL imports.</p> <p>Tradeoffs: - Temporary duplication exists while <code>_legacy.py</code> remains as a compatibility layer. - Full function-body migration of all teacher endpoints can happen incrementally to reduce deployment risk.</p> <p>Plan: - Convert <code>hub/views.py</code> to <code>hub/views/</code> package with concern modules. - Keep <code>hub/views/__init__.py</code> as a compatibility export surface for <code>from hub import views</code>. - Move reusable logic into <code>hub/services/</code> modules (<code>release_state</code>, <code>markdown_content</code>, <code>upload_policy</code>) and add focused service-level tests. - Finish teacher endpoint migration and remove direct helper imports from <code>_legacy.py</code> by introducing <code>hub/services/content_links.py</code>.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-add-teacher-managed-lesson-asset-library-folders-files","title":"2026-02-16 \u2014 Add teacher-managed lesson asset library (folders + files)","text":"<p>Why: - Teachers need to add/update classroom reference files (GPIO maps, handouts, checklists) without shell/git edits. - Non-programmer staff need the same assets visible in Django admin for backup operations and audits.</p> <p>Tradeoffs: - Lesson assets now live in the database/media store, while markdown lessons still live in git. - Asset links use stable app routes (<code>/lesson-asset/&lt;id&gt;/download</code>) rather than direct storage paths.</p> <p>Plan: - Add <code>LessonAssetFolder</code> and <code>LessonAsset</code> models with publish/draft status. - Add staff UI at <code>/teach/assets</code> for folder creation, uploads, and publish/hide/delete actions. - Add protected asset route <code>/lesson-asset/&lt;id&gt;/download</code> and expose assets in Django admin.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-add-plain-english-structure-comments-in-core-class-hub-code-files","title":"2026-02-16 \u2014 Add plain-English structure comments in core Class Hub code files","text":"<p>Why: - Non-programmer staff need to understand request flow and ownership boundaries quickly during demos and support. - Variable names alone do not explain \"where traffic goes\" and \"which route is for whom.\"</p> <p>Tradeoffs: - More comments means a small maintenance cost when routes or auth flow change.</p> <p>Plan: - Add high-level flow comments in:   - <code>services/classhub/config/urls.py</code>   - <code>services/classhub/hub/middleware.py</code>   - <code>services/classhub/hub/views.py</code> - Keep these as comment-only changes (no behavior changes).</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-expand-documentary-comments-in-settingsmodelsrelease-logic","title":"2026-02-16 \u2014 Expand documentary comments in settings/models/release logic","text":"<p>Why: - Team handoff requires context that explains operational intent (not just variable names). - Office staff need a literal map of \"what this switch/route/model does\" during support.</p> <p>Tradeoffs: - Slightly larger source files and a small ongoing comment-maintenance burden.</p> <p>Plan: - Add plain-English comments in:   - <code>services/classhub/config/settings.py</code>   - <code>services/classhub/hub/models.py</code>   - <code>services/classhub/hub/views.py</code> (release, upload, teacher actions) - Keep these as comment-only/documentation changes.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-add-explicit-done-for-now-cues-in-student-class-views","title":"2026-02-16 \u2014 Add explicit \u201cDone for now\u201d cues in student class views","text":"<p>Why: - Students and non-technical staff need a clear visual definition of completion. - \u201cUpload exists\u201d was visible but not explicit as a completion signal.</p> <p>Tradeoffs: - \u201cDone for now\u201d means at least one upload exists; it is not rubric-graded completion.</p> <p>Plan: - Add a small status legend in student class view. - Show <code>Done for now</code> badge when a student has at least one submission for a dropbox. - Mirror that cue on lesson dropbox and upload pages.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-add-plain-language-whatwherewhy-guide-for-non-programmer-staff","title":"2026-02-16 \u2014 Add plain-language What/Where/Why guide for non-programmer staff","text":"<p>Why: - Existing docs are strong for engineering/operations but harder for non-technical coworkers. - Demo support and day-to-day handoff improve when one plain-language entry point exists.</p> <p>Tradeoffs: - Adds one more doc to keep current as routes and workflows evolve. - Some overlap with teacher/runbook docs is intentional to reduce confusion.</p> <p>Plan: - Add <code>WHAT_WHERE_WHY.md</code> with URL map, role map, quick checklist, and troubleshooting. - Link this guide from <code>README.md</code> so it is easy to find.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-add-explicit-teacher-logout-route-and-simplify-admin-login-ui","title":"2026-02-16 \u2014 Add explicit teacher logout route and simplify admin login UI","text":"<p>Why: - Teachers needed an obvious way to end staff sessions from <code>/teach</code> screens. - The admin login view should avoid extra sidebar/theme/filter controls that distract from sign-in.</p> <p>Tradeoffs: - <code>/teach/logout</code> always clears the full session and redirects to <code>/admin/login/</code>. - Admin sidebar navigation filters are disabled globally for a simpler admin surface.</p> <p>Plan: - Add <code>GET /teach/logout</code> that logs out Django auth and flushes session state. - Add <code>Log out</code> links to all teacher templates. - Disable Django admin nav sidebar and hide login-page toggle/popout controls.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-same-device-rejoin-without-return-code-using-signed-cookie-hints","title":"2026-02-16 \u2014 Same-device rejoin without return code using signed cookie hints","text":"<p>Why: - Return-code-only rejoin is secure across devices, but too heavy for fixed classroom machines. - Students often rejoin from the same browser after session expiry/logout.</p> <p>Tradeoffs: - Same-device rejoin now depends on browser cookie persistence. - Shared machines can still reuse identity only when class code + display name match.</p> <p>Plan: - Store a signed, HTTP-only device hint cookie after successful join. - If <code>return_code</code> is omitted, allow same-device rejoin when cookie maps to the same class + display name. - Keep return code required for cross-device recovery.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-replace-display-name-auto-rejoin-with-explicit-student-return-codes-amended","title":"2026-02-16 \u2014 Replace display-name auto-rejoin with explicit student return codes (amended)","text":"<p>Status: Historical context only. Amended by follow-on same-device-hint rejoin changes.</p> <p>Why: - Reusing identity by display name enabled accidental or deliberate impersonation in class. - We need a low-friction way to reclaim identity after cookie loss without relying on name collisions.</p> <p>Tradeoffs: - Students now need a short return code to reclaim an existing identity. - Entering an invalid return code returns an explicit join error instead of silently creating/reusing records.</p> <p>Plan (initial): - Add <code>StudentIdentity.return_code</code> (unique per class). - First join creates a new identity and returns the code. - Rejoin only reuses identity when <code>return_code</code> matches.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-helper-endpoint-now-requires-classroomstaff-session-and-proxy-aware-limits","title":"2026-02-16 \u2014 Helper endpoint now requires classroom/staff session and proxy-aware limits","text":"<p>Why: - <code>/helper/chat</code> was publicly reachable and CSRF-exempt. - IP-only throttling based on <code>REMOTE_ADDR</code> can collapse all users behind a proxy.</p> <p>Tradeoffs: - Anonymous users cannot use helper chat. - Rate limit keys now include both actor/session and client IP, which is stricter but safer for shared infrastructure.</p> <p>Plan: - Require either student session (<code>student_id</code>, <code>class_id</code>) or staff auth. - Keep CSRF protection enabled for helper POST requests. - Read client IP from <code>X-Forwarded-For</code> with validation fallback to <code>REMOTE_ADDR</code>. - Apply per-actor and per-IP limits.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-align-helper-runtime-and-routing-with-production-compose","title":"2026-02-16 \u2014 Align helper runtime and routing with production compose","text":"<p>Why: - Helper container runtime port and Caddy helper route handling were inconsistent with app URLs. - Both Django services depend on Gunicorn in Docker CMD.</p> <p>Tradeoffs: - Dependency set is slightly larger (<code>gunicorn</code>, <code>openai</code> in helper; <code>gunicorn</code> in classhub).</p> <p>Plan: - Bind helper Gunicorn to port <code>8000</code> (matching compose reverse proxy target). - Use Caddy <code>handle /helper/*</code> (no path stripping). - Add required runtime dependencies to requirements files.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-rejoin-by-class-code-reuses-existing-student-identity-by-display-name-superseded","title":"2026-02-16 \u2014 Rejoin by class code reuses existing student identity by display name (superseded)","text":"<p>Status: Historical context only. Superseded by return-code and same-device-hint rejoin flow.</p> <p>Why: - Students who log out and rejoin with the same name were creating duplicate identities. - Duplicate identities fragment submission history and lesson progress visibility.</p> <p>Tradeoffs: - Name matching is class-scoped and case-insensitive. - Students sharing the same display name in one class will map to one identity in MVP.</p> <p>Plan: - On <code>/join</code>, lookup existing <code>StudentIdentity</code> by <code>classroom + display_name__iexact</code>. - Reuse that identity and refresh <code>last_seen_at</code> instead of creating a new row. - Serialize join flow per class transaction to reduce same-name race duplicates.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-date-based-lesson-release-with-intro-only-pre-access","title":"2026-02-16 \u2014 Date-based lesson release with intro-only pre-access","text":"<p>Why: - Teachers need calendar-based pacing without exposing full activities early. - Students should see lesson context before unlock, but full exploration and submissions should wait for schedule.</p> <p>Tradeoffs: - Release behavior is driven by content metadata (<code>available_on</code>) and depends on accurate dates. - Intro-only extraction uses heading boundaries (<code>##</code>) and may need editorial tuning for unusual lesson formats.</p> <p>Plan: - Add optional <code>available_on: YYYY-MM-DD</code> on lesson metadata. - Before release, render intro-only lesson content for students and hide full lesson blocks. - Block lesson-linked uploads until the release date. - Show unlock date status on <code>/student</code> materials and lesson pages. - Add per-class release overrides in teacher tools so staff can set date, lock/unlock, or reset defaults without editing markdown.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-restrict-django-admin-to-superusers-hide-admin-links-for-non-admin-teachers","title":"2026-02-16 \u2014 Restrict Django admin to superusers; hide admin links for non-admin teachers","text":"<p>Why: - Teachers use <code>/teach</code> for day-to-day operations. - <code>/admin</code> should be visible and accessible only to accounts with explicit admin authority.</p> <p>Tradeoffs: - Staff users who are not superusers can no longer access Django admin. - Operational tasks needed by teachers must remain available in <code>/teach</code>.</p> <p>Plan: - Override admin site permission check to require <code>is_superuser</code>. - Keep teacher portal staff-only. - Render <code>/admin</code> links in teacher templates only when <code>request.user.is_superuser</code>.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-keep-lesson-pages-learner-only-move-teacher-notes-to-teacher-tools","title":"2026-02-16 \u2014 Keep lesson pages learner-only; move teacher notes to teacher tools","text":"<p>Why: - Learner lesson pages were rendering teacher-authored sections (prep, agenda, checkpoints). - We need <code>/course/...</code> to be safe for student-only reading.</p> <p>Tradeoffs: - Teacher sections are hidden from learner pages by heading-based rules. - Mis-labeled headings may land in the wrong audience bucket until normalized.</p> <p>Plan: - Split lesson markdown into learner vs teacher sections at render time. - Treat headings like <code>Teacher prep</code>, <code>Agenda</code>, <code>Materials</code>, <code>Checkpoints</code>, and <code>Common stuck points</code> as teacher-only. - Keep teacher notes visible in <code>/teach/lessons</code> and <code>/teach/class/&lt;id&gt;</code> via expandable panels.</p>"},{"location":"decisions/archive/2026-02/#2026-02-16-fail-open-lesson-pages-when-lessonvideo-table-is-missing","title":"2026-02-16 \u2014 Fail-open lesson pages when <code>LessonVideo</code> table is missing","text":"<p>Why: - <code>LessonVideo</code> code paths can execute before migration <code>hub.0002_lessonvideo</code> is applied. - Student lesson pages should not hard-fail due to schema drift.</p> <p>Tradeoffs: - Stored lesson videos are temporarily hidden when the table is absent. - This safety layer does not replace running migrations.</p> <p>Plan: - Catch missing-table DB errors in lesson video read paths. - Return lesson pages without DB-backed videos instead of raising <code>500</code>. - Show a clear migrate action in teacher video management.</p>"},{"location":"decisions/archive/2026-02/#2026-02-13-self-hosted-lesson-video-library-with-teacher-tagging-accordion-playback","title":"2026-02-13 \u2014 Self-hosted lesson video library with teacher tagging + accordion playback","text":"<p>Why: - Course front matter listed lesson videos, but non-YouTube sources were link-only. - Teachers needed an in-product way to upload and tag videos to specific lessons. - Student lesson pages needed a cleaner video UX (open one at a time, avoid multiple concurrent players).</p> <p>Tradeoffs: - Uploaded files are streamed through Django for access control, which is simpler but less efficient than direct object storage/CDN delivery at scale. - Teacher tagging currently keys on <code>course_slug + lesson_slug</code> (global), not per-class overrides.</p> <p>Plan: - Add <code>LessonVideo</code> model with tagged metadata (<code>course_slug</code>, <code>lesson_slug</code>, title, outcome, URL or uploaded file, order). - Add staff UI at <code>/teach/videos</code> for upload/link, ordering, and deletion. - Add publish/draft controls so teachers can stage videos before student release. - Add bulk file upload flow to reduce repetitive tagging work for multi-clip lessons. - Add secure stream endpoint <code>/lesson-video/&lt;id&gt;/stream</code> with byte-range support for seekable playback. - Render lesson videos as an accordion where clicking a heading opens that item and closes/pause-resets others. - Keep YouTube embed support while adding inline playback for self-hosted/native video URLs.</p>"},{"location":"decisions/archive/2026-02/#2026-02-13-add-create_teacher-management-command-for-staff-account-ops","title":"2026-02-13 \u2014 Add <code>create_teacher</code> management command for staff account ops","text":"<p>Why: - Shell one-liners for user creation are easy to mistype and hard to remember. - Teacher onboarding and recovery should use a repeatable, documented command.</p> <p>Tradeoffs: - Adds a small command-maintenance surface in <code>hub.management.commands</code>. - We still rely on Django password auth (SSO planned later).</p> <p>Plan: - Add <code>manage.py create_teacher</code> for create/update flows. - Default to <code>is_staff=True</code>, non-superuser for least privilege. - Support updates (<code>--update</code>) for password resets and account activation changes.</p>"},{"location":"decisions/archive/2026-02/#2026-02-13-teacher-first-portal-centered-on-lessons-and-submissions","title":"2026-02-13 \u2014 Teacher-first portal centered on lessons and submissions","text":"<p>Why: - Teachers primarily need lesson flow and submission visibility, not full admin object editing. - Existing <code>/teach</code> screens exposed module/material internals first, which made day-to-day teaching tasks slower.</p> <p>Tradeoffs: - Lesson tracking depends on detecting lesson links from module materials (<code>/course/&lt;course&gt;/&lt;lesson&gt;</code> pattern). - If classes use custom link structures, they may not appear in the lesson tracker.</p> <p>Plan: - Add <code>/teach/lessons</code> as a lesson-level tracker grouped by class. - Show per-lesson dropbox progress (<code>submitted / total</code>, missing count, latest upload timestamp). - Add direct triage actions from lesson rows (<code>all</code>, <code>missing</code>, <code>download latest zip</code>) to reduce click depth. - Add a primary row-level <code>Review missing now</code> shortcut that targets the highest-missing dropbox. - Add recent submissions summary to <code>/teach</code> for quick triage. - Keep module/material editing in place as a secondary workflow, not the primary teacher view.</p>"},{"location":"decisions/archive/2026-02/#2026-02-08-scripted-course-pack-rebuilds-for-test-classes","title":"2026-02-08 \u2014 Scripted course-pack rebuilds for test classes","text":"<p>Why: - Curriculum edits require re-importing Modules + Materials. - We want a single, repeatable command that targets a class code or creates a new class.</p> <p>Tradeoffs: - Assumes a Compose-based workflow and container name <code>classhub_web</code>. - Adds a small maintenance surface (the wrapper script).</p> <p>Plan: - Add <code>scripts/rebuild_coursepack.sh</code> to wrap <code>import_coursepack</code>. - Document the script in <code>DEVELOPMENT.md</code>.</p>"},{"location":"decisions/archive/2026-02/#2026-02-04-lesson-linked-homework-dropbox-from-front-matter","title":"2026-02-04 \u2014 Lesson-linked homework dropbox from front matter","text":"<p>Why: - Students needed a predictable place to submit work directly from each lesson. - Submission rules already exist in lesson front matter (<code>submission.type</code>, <code>accepted</code>, <code>naming</code>). - Teachers should not have to manually create upload materials per lesson.</p> <p>Tradeoffs: - Dropbox availability now depends on importing course packs into class modules. - Non-file submissions (<code>submission.type: text</code>) still rely on teacher workflow outside file uploads.</p> <p>Plan: - During <code>import_coursepack</code>, auto-create a <code>Homework dropbox</code> material for any lesson with <code>submission.type: file</code>. - Use front matter extension rules to configure allowed upload types. - Surface the dropbox on lesson pages when a student is signed in, with latest upload status.</p>"},{"location":"decisions/archive/2026-02/#2026-02-01-per-lesson-reference-files-for-helper-expertise","title":"2026-02-01 \u2014 Per-lesson reference files for helper expertise","text":"<p>Why: - Small models respond better to short, lesson-specific context. - Avoids a single giant reference file that dilutes signal. - Lets expertise shift as students move through lessons.</p> <p>Tradeoffs: - More files to manage. - Requires a generator to keep references aligned with lesson content.</p> <p>Plan: - Generate <code>reference/&lt;lesson_slug&gt;.md</code> files from course markdown. - Set <code>helper_reference: &lt;lesson_slug&gt;</code> per lesson in <code>course.yaml</code>. - Allow safe slug-based reference lookup in the helper.</p>"},{"location":"decisions/archive/2026-02/#2026-02-01-scratch-only-guardrails-for-helper-responses","title":"2026-02-01 \u2014 Scratch-only guardrails for helper responses","text":"<p>Why: - Avoid irrelevant text-language answers (e.g., Pascal) for Scratch lessons. - Keep responses aligned with blocks-based instruction.</p> <p>Tradeoffs: - Overly strict keyword filtering may redirect some legitimate questions.</p> <p>Plan: - Add Scratch-only guardrails in the prompt policy. - Add a lightweight redirect filter in the helper for text-language keywords. - Lower randomness for the Ollama backend. - Allow an explicit per-lesson allowed-topics list and redirect off-topic queries. - Default to strict scope + strict allowed-topics for Scratch-only course delivery.</p>"},{"location":"examples/course_authoring/example_slug-public-overview-template/","title":"Example Slug Course","text":"<p>Course slug: example_slug Grade level: 6th-8th Meeting time: 60 minutes/week for 4 weeks Platform:"},{"location":"examples/course_authoring/example_slug-public-overview-template/#course-summary","title":"Course summary","text":"<ul> <li>&lt;1-2 sentence summary for parents/admin&gt;</li> </ul>"},{"location":"examples/course_authoring/example_slug-public-overview-template/#learning-goals","title":"Learning goals","text":"<ul> <li> <li>"},{"location":"examples/course_authoring/example_slug-public-overview-template/#student-outputs","title":"Student outputs","text":"<ul> <li>"},{"location":"examples/course_authoring/example_slug-public-overview-template/#materials-and-prerequisites","title":"Materials and prerequisites","text":"<ul> <li>"},{"location":"examples/course_authoring/example_slug-teacher-plan-template/","title":"Teacher Session Plan Template: Example Slug Course","text":"<p>Course slug: example_slug Grade level: 6th-8th Session length: 60 minutes Total sessions: 4</p> <p>Use <code>Session NN: Title</code> headings exactly so <code>scripts/ingest_syllabus_md.py</code> can parse this file.</p>"},{"location":"examples/course_authoring/example_slug-teacher-plan-template/#session-01-session-01-title","title":"Session 01: Session 01 Title","text":"<p>Mission:  Lesson slug example: s01-session-01-title <p>Teacher prep -  <p>Materials -  <p>Agenda - 0-10 min:  - 10-45 min:  - 45-60 min:  <p>Checkpoints -  <p>Common stuck points + fixes -  -&gt;  <p>Extensions -"},{"location":"examples/course_authoring/example_slug-teacher-plan-template/#session-02-session-02-title","title":"Session 02: Session 02 Title","text":"<p>Mission:  Lesson slug example: s02-session-02-title <p>Teacher prep -  <p>Materials -  <p>Agenda - 0-10 min:  - 10-45 min:  - 45-60 min:  <p>Checkpoints -  <p>Common stuck points + fixes -  -&gt;  <p>Extensions -"},{"location":"examples/course_authoring/example_slug-teacher-plan-template/#session-03-session-03-title","title":"Session 03: Session 03 Title","text":"<p>Mission:  Lesson slug example: s03-session-03-title <p>Teacher prep -  <p>Materials -  <p>Agenda - 0-10 min:  - 10-45 min:  - 45-60 min:  <p>Checkpoints -  <p>Common stuck points + fixes -  -&gt;  <p>Extensions -"},{"location":"examples/course_authoring/example_slug-teacher-plan-template/#session-04-session-04-title","title":"Session 04: Session 04 Title","text":"<p>Mission:  Lesson slug example: s04-session-04-title <p>Teacher prep -  <p>Materials -  <p>Agenda - 0-10 min:  - 10-45 min:  - 45-60 min:  <p>Checkpoints -  <p>Common stuck points + fixes -  -&gt;  <p>Extensions -"}]}